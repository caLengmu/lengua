<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read Aid</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 2.5em;
        }

        .button-categories {
            margin-bottom: 30px;
        }

        .category {
            margin-bottom: 25px;
        }

        .category-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            display: inline-block;
        }

        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .lesson-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .lesson-btn:hover {
            background-color: #2980b9;
        }

        .lesson-btn.active {
            background-color: #e74c3c;
        }

        .speed-control-section {
            margin: 30px 0;
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .speed-label {
            font-weight: bold;
            color: #495057;
            margin-right: 15px;
            font-size: 16px;
        }

        .speed-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .speed-btn:hover {
            background-color: #5a6268;
        }

        .speed-btn.active-speed {
            background-color: #28a745;
        }

        .text-table-container {
            margin-top: 30px;
            overflow-x: auto;
        }

        .text-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        .section-header {
            background-color: #ecf0f1;
            font-weight: bold;
            padding: 15px;
            text-align: left;
            font-size: 1.5em;
            color: #2c3e50;
        }

        .text-row {
            border-bottom: 1px solid #ddd;
        }

        .audio-controls {
            width: 80px;
            text-align: center;
            padding: 15px 10px;
            vertical-align: top;
        }

        .content-cell {
            padding: 15px;
            vertical-align: top;
        }

        .english-text {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .chinese-translation {
            font-size: 1.5em;
            color: #555;
            line-height: 1.5;
        }

        .audio-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            margin: 2px;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.3s;
            display: block;
            width: 100%;
        }

        .audio-btn:hover {
            background-color: #f0f0f0;
        }

        .play-btn {
            color: #27ae60;
        }

        .stop-btn {
            color: #e74c3c;
        }

        .easy-btn {
            color: #f39c12;
        }

        .dialogue-btn {
            color: #9b59b6;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: red;
            font-size: 25px;
        }

        /* Modal Base Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
        }

        .close:hover {
            color: #000;
        }

        /* Easy Version Modal */
        .easy-version-content {
            margin-top: 20px;
        }

        .easy-version-text {
            font-size: 1.8em;
            color: #2c3e50;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .easy-audio-controls {
            text-align: center;
            margin-top: 20px;
        }

        .easy-audio-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            margin: 0 10px;
            transition: background-color 0.3s;
        }

        .easy-audio-btn:hover {
            background-color: #2980b9;
        }

        .easy-audio-btn.stop {
            background-color: #e74c3c;
        }

        .easy-audio-btn.stop:hover {
            background-color: #c0392b;
        }

        /* Dialogue Modal */
        .dialogue-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .dialogue-line {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .dialogue-line.active {
            background-color: #fff3cd;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }

        .dialogue-row {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .dialogue-row.addresser {
            justify-content: flex-start;
        }

        .dialogue-row.addressee {
            justify-content: flex-end;
        }

        .dialogue-icon {
            font-size: 40px;
            flex-shrink: 0;
        }

        .dialogue-bubble {
    max-width: 70%;
    padding: 15px 20px;
    border-radius: 20px;
    font-size: 1.3em;
    line-height: 1.6;
    position: relative;
}

.dialogue-row.addresser .dialogue-bubble {
    background-color: #e3f2fd;
    color: #1565c0;
    border-bottom-left-radius: 5px;
}

/* Add tail pointing to addresser (left side) */
.dialogue-row.addresser .dialogue-bubble::before {
    content: '';
    position: absolute;
    left: -10px;
    top: 20px;
    width: 0;
    height: 0;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-right: 10px solid #e3f2fd;
}

.dialogue-row.addressee .dialogue-bubble {
    background-color: #c8e6c9;
    color: #2e7d32;
    border-bottom-right-radius: 5px;
}

/* Add tail pointing to addressee (right side) */
.dialogue-row.addressee .dialogue-bubble::before {
    content: '';
    position: absolute;
    right: -10px;
    top: 20px;
    width: 0;
    height: 0;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-left: 10px solid #c8e6c9;
}

        .dialogue-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            gap: 15px;
        }

        .dialogue-control-group {
            display: flex;
            gap: 10px;
        }

        .dialogue-control-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            min-width: 100px;
        }

        .dialogue-control-btn:hover {
            background-color: #2980b9;
        }

        .dialogue-control-btn.stop {
            background-color: #e74c3c;
        }

        .dialogue-control-btn.stop:hover {
            background-color: #c0392b;
        }

        .dialogue-control-btn.play-all {
            background-color: #27ae60;
        }

        .dialogue-control-btn.play-all:hover {
            background-color: #229954;
        }

.dialogue-control-btn.reset {
    background-color: #f39c12;  /* Orange color */
}

.dialogue-control-btn.reset:hover {
    background-color: #e67e22;  /* Darker orange on hover */
}

        .dialogue-control-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        /* Welcome Notice Modal */
        #welcomeModal .modal-content {
            max-width: 500px;
        }

        /* Floating Navigation Buttons */
        .floating-nav-buttons {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .floating-nav-btn {
            width: 60px;
            height: 60px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            transition: all 0.3s;
        }

        .floating-nav-btn:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }

        .floating-nav-btn.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .next-section-btn {
            background-color: #27ae60;
        }

        .next-section-btn:hover {
            background-color: #229954;
        }

.prev-section-btn {
    background-color: #27ae60;
}

.prev-section-btn:hover {
    background-color: #229954;
}

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }

            .category-title {
                font-size: 1.2em;
            }

            .lesson-btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .speed-control-section {
                padding: 10px;
            }

            .speed-label {
                display: block;
                margin-bottom: 10px;
                margin-right: 0;
            }

            .speed-btn {
                padding: 8px 12px;
                font-size: 13px;
                margin: 2px;
            }

            .section-header {
                font-size: 1.2em;
                padding: 12px;
            }

            .audio-controls {
                width: 60px;
                padding: 10px 5px;
            }

            .content-cell {
                padding: 12px;
            }

            .english-text {
                font-size: 1.5em;
            }

            .chinese-translation {
                font-size: 1.5em;
            }

            .modal-content {
                width: 95%;
                margin: 20px auto;
                padding: 20px;
            }

            .easy-version-text {
                font-size: 1.5em;
            }

            .dialogue-bubble {
                font-size: 1.1em;
                padding: 12px 16px;
            }

            .dialogue-icon {
                font-size: 32px;
            }

            .dialogue-controls {
                flex-direction: column;
                gap: 10px;
            }

            .dialogue-control-group {
                width: 100%;
                justify-content: center;
            }

            .dialogue-control-btn {
                flex: 1;
                min-width: auto;
            }

            .floating-nav-buttons {
                bottom: 20px;
                right: 20px;
                gap: 8px;
            }
            
            .floating-nav-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

.hidden-data {
    display: none;
}

    </style>
</head>
<body>
    <!-- Floating Navigation Buttons -->
<div class="floating-nav-buttons">
    <button class="floating-nav-btn" id="backToTopBtn" title="Back to lesson buttons">üîù</button>
    <button class="floating-nav-btn prev-section-btn" id="prevSectionBtn" title="Previous section">‚¨ÜÔ∏è</button>
    <button class="floating-nav-btn next-section-btn" id="nextSectionBtn" title="Next section">‚¨áÔ∏è</button>
</div>
    
    <div class="container">
        <h1>üìñ Read Aid <br>(v2.2 Ê∏¨Ë©¶1204/22:23)</h1>

        <div class="button-categories">
            <div class="category">
                <div class="category-title">üìö Textbook: Book 3 (Ë™≤Êú¨Á¨¨‰∏âÂÜä)</div>
                <div class="category-buttons">
                    <button class="lesson-btn" data-lesson="text1">B3 L7 Ë™≤Êñá</button>
                    <button class="lesson-btn" data-lesson="text2">B3 L8 Ë™≤Êñá</button>
                    <button class="lesson-btn" data-lesson="text3">B3 L9 Ë™≤Êñá</button>
                </div>
            </div>

            <div class="category">
                <div class="category-title">üì∞ Magazine: All+ December 2026</div>
                <div class="category-buttons">
                    <button class="lesson-btn" data-lesson="maga1">U2 Baseball</button>
                    <button class="lesson-btn" data-lesson="maga2">U4 Ban</button>
                    <button class="lesson-btn" data-lesson="maga3">U5 Viruses</button>
                    <button class="lesson-btn" data-lesson="maga4">U14 Study Approaches</button>
                </div>
            </div>

            <div class="category">
                <div class="category-title">üìí Ê†∏ÂøÉÂ≠óÂΩô</div>
                <div class="category-buttons">
                    <button class="lesson-btn" data-lesson="core1">U7 Ballpoint Pen</button>
                    <button class="lesson-btn" data-lesson="core2">U8 Pancakes</button>
                    <button class="lesson-btn" data-lesson="core3">U9 Homeless</button>
                </div>
            </div>
        </div>

        <!-- Speed Control -->
        <div class="speed-control-section">
            <span class="speed-label">Speed (Ë™ûÈÄü):</span>
            <button class="speed-btn" data-speed="1.2">1.2x</button>
            <button class="speed-btn active-speed" data-speed="1.0">1x</button>
            <button class="speed-btn" data-speed="0.8">0.8x</button>
            <button class="speed-btn" data-speed="0.6">0.6x</button>
        </div>

        <!-- Table -->
        <div class="text-table-container">
            <table class="text-table" id="textTable">
                <tbody id="textTableBody">
                    <tr class="no-data">
                        <td colspan="2">Select a lesson to load content <br>(ÈÅ∏ÊìáÂñÆÂÖÉ‰ª•ËºâÂÖ•ÂÖßÂÆπ)</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Welcome Notice Modal -->
    <div id="welcomeModal" class="modal" style="display: block;">
        <div class="modal-content">
            <div style="text-align: center; padding: 10px;">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">üì¢ Welcome to Read Aid</h2>
                <div style="text-align: left; font-size: 16px; line-height: 1.8; margin-bottom: 25px;">
                    <p style="margin-bottom: 15px;">This tool helps you improve reading and listening comprehension.</p>
                    <p style="margin-bottom: 15px;">Features:</p>
                    <ul style="margin-left: 20px;">
                        <li>Listen to English text with natural speech</li>
                        <li>See Chinese translations</li>
                        <li>Access simplified versions (üòä icon)</li>
                        <li>Practice with dialogues (üí¨ icon)</li>
                        <li>Adjust playback speed</li>
                    </ul>
                </div>
                <button id="welcomeOkBtn" style="background-color: #28a745; color: white; border: none; padding: 12px 40px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;">
                    Get Started
                </button>
            </div>
        </div>
    </div>

    <!-- Easy Version Modal -->
    <div id="easyModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeEasyModal">&times;</span>
            <h2 style="color: #2c3e50; margin-bottom: 20px;">üòä Easy Version</h2>
            <div class="easy-version-content">
                <div class="easy-version-text" id="easyVersionText"></div>
                <div class="easy-audio-controls">
                    <button class="easy-audio-btn" id="playEasyBtn">üîä Play</button>
                    <button class="easy-audio-btn stop" id="stopEasyBtn">‚èπ Stop</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dialogue Modal -->
    <div id="dialogueModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeDialogueModal">&times;</span>
            <h2 style="color: #2c3e50; margin-bottom: 20px;">üí¨ Dialogue</h2>
            <div class="dialogue-container" id="dialogueContainer">
                <!-- Dialogue lines will be inserted here -->
            </div>
            <div class="dialogue-controls">
    <div class="dialogue-control-group">
        <button class="dialogue-control-btn play-all" id="playPauseBtn">‚ñ∂Ô∏è Play</button>
        <button class="dialogue-control-btn reset" id="resetBtn">üîÑ Reset</button>
    </div>
    <div class="dialogue-control-group">
        <button class="dialogue-control-btn" id="backLineBtn">‚¨ÜÔ∏è Back</button>
        <button class="dialogue-control-btn" id="nextLineBtn">Next ‚¨áÔ∏è</button>
    </div>
</div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        
        // Adjust this value to change pause duration between dialogue lines (in milliseconds)
        // 1000 = 1 second, 1500 = 1.5 seconds, etc.
        const DIALOGUE_PAUSE_DURATION = 100;

        // ========================================
        // DIALOGUE DATABASE
        // ========================================
        
        const dialogueDatabase = {
            'text1': `
Hi! Today we‚Äôre going to read about the history of baseball in Taiwan. Are you ready?	^	Yes, I‚Äôm ready!
Great! Let‚Äôs start with the first paragraph. Can you read it for me?	^	‚ÄúWith roots tracing back to the Japanese colonial period from 1895 to 1945, baseball has long held a special place in Taiwan‚Äôs heart. One of the early events that helped fuel Taiwan‚Äôs passion for the sport came in 1968, when the Red Leaves Little League team from Taitung beat a visiting Japanese powerhouse. The win captured lots of attention and sparked excitement all over the island.‚Äù
Very good! Let‚Äôs talk about some vocabulary. Do you know what ‚Äútrace back to‚Äù means?	^	Umm‚Ä¶ maybe ‚Äústarted from long ago‚Äù?
Exactly! It tells us where something began. And ‚Äúhold a special place in Taiwan‚Äôs heart‚Äù means people in Taiwan love it very much.	^	Oh, I see.
What happened in 1968 that made people excited?	^	The Red Leaves Little League team won against a strong Japanese team.
Yes! That win sparked excitement‚Äîit made people feel happy and proud.	^	
Let‚Äôs look at paragraph 2. Can you read it?	^	‚ÄúBaseball grew even more popular in 1969, when Taichung‚Äôs Golden Dragon team won the Little League World Series. It was a feat which proved that Taiwan could compete on the global stage. Taiwanese teams dominated the LLWS for many years thereafter, earning Taiwan a reputation as a baseball heavyweight.‚Äù
Nice reading! Do you know the word ‚Äúfeat‚Äù?	^	Is it something difficult and amazing?
Exactly! The Golden Dragon team did something amazing. What does ‚Äúcompete on the global stage‚Äù mean?	^	It means Taiwan could play against teams from other countries.
Yes! And ‚Äúdominated‚Äù means Taiwan won again and again for many years.	^	Oh! That‚Äôs why Taiwan got the reputation as a baseball heavyweight!
Very good! You understood it perfectly.	^	1
Let‚Äôs read paragraph 3 now.	^	‚ÄúBaseball in Taiwan took another big step in 1990 with the start of the Chinese Professional Baseball League. This let local players shine and gave fans new heroes to cheer for. Soon after, Taiwan showed its strength again by winning a silver medal at the 1992 Barcelona Olympics. However, the CPBL struggled in the 1990s and 2000s due to multiple game-fixing scandals, which led to a sharp fall in attendance.‚Äù
Great job. What does ‚Äútook another big step‚Äù mean?	^	It means something important happened for baseball.
Yes! The CPBL was a big change. Why did fans have ‚Äúnew heroes to cheer for‚Äù?	^	Because now there were local professional players.
Exactly! Do you know what ‚Äústruggled‚Äù means?	^	It means had a hard time.
Yes. And why did the CPBL struggle?	^	Because there were many game-fixing scandals.
Right. ‚ÄúGame-fixing‚Äù means cheating in games, and that made many fans stop going to games. That is a sharp fall in attendance.	^	That's too bad!

`,
            'text2': `

`,
            'text3': ``,
            'maga1': ``,
            'maga2': ``,
            'maga3': ``,
            'maga4': ``,
            'core1': ``,
            'core2': ``,
            'core3': ``
        };

        // ========================================
        // TEXT DATABASE
        // ========================================
        
        const textDatabaseRaw = {
            'text1': `
‚óéParagraph 1
The theory that spoken words account for only about seven percent of communication involving emotions may surprise many people. This was first proposed by Dr. Albert Mehrabian, a famous psychology professor. ^Âè£Ë™ûÂú®ÊÉÖÁ∑íÊ∫ùÈÄö‰∏≠Âè™‰ΩîÁ¥ÑÁôæÂàÜ‰πã‰∏ÉÁöÑÁêÜË´ñÔºåÂèØËÉΩÊúÉËÆìË®±Â§ö‰∫∫ÊÑüÂà∞È©öË®ù„ÄÇÈÄôÊòØÁî±ËëóÂêçÁöÑÂøÉÁêÜÂ≠∏ÊïôÊéàËâæ‰ºØÁâπ„ÉªÊ¢ÖÂìàÊØîÂÆâÂçöÂ£´È¶ñÂÖàÊèêÂá∫ÁöÑ„ÄÇ^The idea that spoken words are only about seven percent of emotional communication may surprise people. A well-known psychology professor, Dr. Albert Mehrabian, first suggested this.

According to his studies, we achieve about 55% of our emotional communication with our bodies, for they typically demonstrate our true feelings and what we're actually thinking. Therefore, understanding people's body language is an important ability to help us better interpret others' messages. ^ Ê†πÊìö‰ªñÁöÑÁ†îÁ©∂ÔºåÊàëÂÄëÂ§ßÁ¥ÑÊúâÁôæÂàÜ‰πã‰∫îÂçÅ‰∫îÁöÑÊÉÖÁ∑íÊ∫ùÈÄöÊòØÈÄèÈÅéË∫´È´îÈÄ≤Ë°åÁöÑÔºåÂõ†ÁÇ∫Ë∫´È´îÈÄöÂ∏∏ÊúÉÂ±ïÁèæÊàëÂÄëÁúüÊ≠£ÁöÑÊÑüÂèóËàáÊÉ≥Ê≥ï„ÄÇÂõ†Ê≠§Ôºå‰∫ÜËß£‰ªñ‰∫∫ÁöÑËÇ¢È´îË™ûË®ÄÊòØÂπ´Âä©ÊàëÂÄëÊõ¥Ê∫ñÁ¢∫Ëß£ËÆÄË®äÊÅØÁöÑÈáçË¶ÅËÉΩÂäõ„ÄÇ^His research says about 55% of emotional communication comes from our body because it shows our real feelings. So understanding body language helps us know what others really mean.
‚óéParagraph 2
Being able to read body language well is helpful in determining whether or not someone is telling the truth. When people are lying, there are usually three telltale signs: making stiff body movements, touching or scratching themselves, and making eye movements. ^ ËÉΩÂ§†ËÆÄÊáÇËÇ¢È´îË™ûË®ÄÊúâÂä©ÊñºÂà§Êñ∑‰∏ÄÂÄã‰∫∫ÊòØÂê¶Âú®Ë™™ÁúüË©±„ÄÇÁï∂‰∫∫Ë™™Ë¨äÊôÇÔºåÈÄöÂ∏∏ÊúÉÊúâ‰∏âÂÄãÊòéÈ°ØÁâπÂæµÔºöÂãï‰ΩúÂÉµÁ°¨„ÄÅËß∏Á¢∞ÊàñÊêîÊäìËá™Â∑±Ôºå‰ª•ÂèäÁúºÁùõÁöÑÁï∞Â∏∏Âãï‰Ωú„ÄÇ^ Reading body language helps us know if someone is telling the truth. When people lie, they often show three signs: stiff movements, touching themselves, and unusual eye movements.

Typically, liars exhibit fewer arm and hand gestures. When they do make such gestures, their movements are usually stiff, and their hands tend to stay close to the body rather than move in an outward direction. Moreover, liars often can't help but touch or scratch their faces, their necks, or behind their ears. They sometimes rub their eyes without being conscious of it as well. ^ ÈÄöÂ∏∏ÔºåË™™Ë¨äËÄÖÊúÉÊ∏õÂ∞ëÊâãËáÇÂíåÊâãÁöÑÂãï‰Ωú„ÄÇÂç≥‰ΩøÊúâÂãï‰ΩúÔºå‰ªñÂÄëÁöÑÂãï‰ΩúÈÄöÂ∏∏ÂæàÂÉµÁ°¨ÔºåÊâã‰πüÊúÉÈù†ËøëË∫´È´îÔºåËÄå‰∏çÊòØÂêëÂ§ñÊì∫Âãï„ÄÇÊ≠§Â§ñÔºåË™™Ë¨äËÄÖÂ∏∏ÊúÉÂøç‰∏ç‰ΩèËß∏Á¢∞ÊàñÊêîÊäìËáâÈÉ®„ÄÅËÑñÂ≠êÊàñËÄ≥Âæå„ÄÇ‰ªñÂÄëÊúâÊôÇ‰πüÊúÉ‰∏çËá™Ë¶∫Âú∞ÊèâÁúºÁùõ„ÄÇ^ Liars usually move their arms and hands less. If they do move, their movements are stiff and their hands stay close to their body. Liars also often touch or scratch their face, neck, or behind their ears. They sometimes rub their eyes without noticing.

Whether people are telling falsehoods or not can also be detected by observing how their eyes move as they speak. When right-handed people say true things, their eyes move to their left. In contrast, when they are lying or being "creative" with the truth, their eyes tend to drift toward their right. The reverse is true for left-handed people. ^ ÈÄèÈÅéËßÄÂØü‰∫∫ÂÄëË™™Ë©±ÊôÇÁúºÁùõÁöÑÁßªÂãïÔºå‰πüËÉΩÂà§Êñ∑‰ªñÂÄëÊòØÂê¶Ë™™Ë¨ä„ÄÇÂè≥ÊíáÂ≠êË™™ÁúüË©±ÊôÇÔºå‰ªñÂÄëÁöÑÁúºÁùõÊúÉÂæÄÂ∑¶Áßª„ÄÇÁõ∏ÂèçÂú∞ÔºåÁï∂‰ªñÂÄëË™™Ë¨äÊàñ„ÄåÂä†Â∑•„Äç‰∫ãÂØ¶ÊôÇÔºåÁúºÁùõÂâáÊúÉÂæÄÂè≥ÂÅè„ÄÇÂ∑¶ÊíáÂ≠êÁöÑÊÉÖÊ≥ÅÂâáÁõ∏Âèç„ÄÇ^ You can also tell if someone lies by watching their eye movements. When right-handed people tell the truth, their eyes move left. When they lie, their eyes usually move to the right. For left-handed people, it is the opposite.
‚óéParagraph 3
Another significant type of telling body language is connected to love. In the case of romantic feelings, people's bodies subconsciously provide an indication for someone to whom they are attracted. ^ Âè¶‰∏ÄÁ®ÆÈáçË¶Å‰∏îÂÖ∑ÊúâÊåáÊ®ôÊÄßÁöÑËÇ¢È´îË™ûË®ÄËàáÊÑõÊÉÖÊúâÈóú„ÄÇÁï∂‰∫∫Áî¢ÁîüÊµ™Êº´ÊÉÖÊÑ´ÊôÇÔºå‰ªñÂÄëÁöÑË∫´È´îÊúÉ‰∏ãÊÑèË≠òÂú∞ÂêëÂøÉÂÑÄÁöÑÂ∞çË±°ÂÇ≥ÈÅîË®äËôü„ÄÇ^ Another important kind of body language is related to love. When someone likes another person, their body gives signals without them knowing.

Under the circumstances, their eyes do most of the "talking." Initially, they may glance at a person from a distance and for just slightly longer than normal. Afterward, they may look away and finally rest their eyes on him or her again for an even longer period. ^ Âú®ÈÄôÁ®ÆÊÉÖÊ≥Å‰∏ãÔºå‰ªñÂÄëÁöÑÁúºÁùõË≤†Ë≤¨Â§ßÈÉ®ÂàÜÁöÑ„ÄåÂ∞çË©±„Äç„ÄÇ‰∏ÄÈñãÂßãÔºå‰ªñÂÄëÂèØËÉΩÊúÉÂæûÈÅ†ËôïÁúãÂ∞çÊñπ‰∏ÄÁúºÔºå‰∏¶‰∏îÊØîÂπ≥Â∏∏Â§öÂÅúÁïô‰∏ÄÈªûÊôÇÈñì„ÄÇÊé•ËëóÔºå‰ªñÂÄëÂèØËÉΩÊúÉËΩâÈñãË¶ñÁ∑öÔºå‰πãÂæåÂèàÂÜçÂ∫¶ÁúãÂêëÂ∞çÊñπÔºå‰∏îÂÅúÁïôÊõ¥‰πÖ„ÄÇ^In this situation, their eyes send most of the signals. First, they may look at the person from far away for a little longer than usual. Then they look away and later look back again for even longer.

Furthermore, they automatically track or repeat his or her actions without even knowing it. If he or she sits back, they will follow suit. If that person takes a sip of water, they will probably do the same. ^ Ê≠§Â§ñÔºå‰ªñÂÄëÊúÉ‰∏çËá™Ë¶∫Âú∞Ë∑üÈö®ÊàñÊ®°‰ªøÂ∞çÊñπÁöÑÂãï‰Ωú„ÄÇÂ¶ÇÊûúÂ∞çÊñπÂæÄÂæåÈù†Ôºå‰ªñÂÄë‰πüÊúÉË∑üËëóÂÅö„ÄÇËã•Â∞çÊñπÂñù‰∏ÄÂè£Ê∞¥Ôºå‰ªñÂÄë‰πüÂæàÂèØËÉΩÊúÉÈÄôÈ∫ºÂÅö„ÄÇ^ Besides, they may copy the other person's actions without knowing it. If the person sits back, they will too. If the person drinks water, they will likely do the same.

Aside from copying behavior, they often can't help pointing their feet and shoulders toward the one they adore or standing closer to the object of their affection than to others. ^ Èô§‰∫ÜÊ®°‰ªøË°åÁÇ∫Â§ñÔºå‰ªñÂÄë‰πüÂ∏∏ÊúÉ‰∏çËá™Ë¶∫Â∞áËÖ≥ÂíåËÇ©ËÜÄÊúùÂêëÂøÉÂÑÄÂ∞çË±°ÔºåÊàñÁ´ôÂæóÊØîËµ∑‰ªñ‰∫∫Êõ¥Èù†ËøëÂ∞çÊñπ„ÄÇ^ Also, they point their feet and shoulders toward the person they like or stand closer to them.
‚óéParagraph 4
All of the previously mentioned points reveal the idea that one of the best methods for interpreting people's thoughts and emotions is to pay attention to their body language. ^ ‰ª•‰∏äÁ®ÆÁ®ÆÈÉΩÈ°ØÁ§∫ÔºöÊÉ≥Ëß£ËÆÄ‰ªñ‰∫∫ÁöÑÊÉ≥Ê≥ïËàáÊÉÖÁ∑íÔºåÊúÄÂ•ΩÁöÑÊñπÊ≥ï‰πã‰∏ÄÂ∞±ÊòØÊ≥®ÊÑè‰ªñÂÄëÁöÑËÇ¢È´îË™ûË®Ä„ÄÇ^ All these points show that watching body language is one of the best ways to understand people.

By understanding the signals that people send out with their body language, we may interact in a more meaningful way with our fellow human beings. Best of all, we can do it without even saying a single word! ^ ÈÄèÈÅéÁêÜËß£‰ªñÂÄëÁöÑËÇ¢È´îË®äËôüÔºåÊàëÂÄëËÉΩËàá‰ªñ‰∫∫ÈÄ≤Ë°åÊõ¥ÊúâÊÑèÁæ©ÁöÑ‰∫íÂãï„ÄÇÊúÄÊ£íÁöÑÊòØÔºåÈÄô‰∏ÄÂàáÁîöËá≥‰∏çÈúÄË¶Å‰∏ÄÂè•Ë©±ÔºÅ^ By understanding these signals, we can interact with others in a better way. The best part is that we can do this without saying anything.

`,
            'text2': `

`,
            'text3': ``,
            'maga1': ``,
            'maga2': ``,
            'maga3': ``,
            'maga4': ``,
            'core1': ``,
            'core2': ``,
            'core3': ``
        };

        // Parse simplified database format
        function parseSimplifiedDatabase(text) {
            const sections = [];
            const lines = text.trim().split('\n');
            let currentSection = null;

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                if (line.startsWith('‚óé')) {
                    if (currentSection) {
                        sections.push(currentSection);
                    }
                    currentSection = {
                        section: line,
                        items: []
                    };
                } else if (line.includes('^') && currentSection) {
                    const parts = line.split('^').map(s => s.trim());
                    if (parts.length === 3) {
                        currentSection.items.push({
                            english: parts[0],
                            chinese: parts[1],
                            easy: parts[2]
                        });
                    }
                }
            }

            if (currentSection) {
                sections.push(currentSection);
            }

            return sections;
        }

        // Convert raw database to parsed format
        const textDatabase = {};
        for (const [key, value] of Object.entries(textDatabaseRaw)) {
            textDatabase[key] = parseSimplifiedDatabase(value);
        }

        // ========================================
        // GLOBAL STATE
        // ========================================
        
        let currentSpeech = null;
        let speechRate = 1.0;
        let voices = [];
        let currentEasyText = '';
        
        // Dialogue state
let currentDialogueData = [];
let currentDialogueIndex = 0;
let dialoguePlayTimeout = null;
let isPlayingDialogue = false;
let isPlayingAll = false;
let isPaused = false;
// Note: We no longer need femaleVoice and maleVoice variables
// Dialogue uses the same voice as reading mode with pitch variation

        // ========================================
        // VOICE MANAGEMENT
        // ========================================

        // Load voices
function loadVoices() {
    voices = speechSynthesis.getVoices();
    if (!voices.length) {
        const dummy = new SpeechSynthesisUtterance('');
        speechSynthesis.speak(dummy);
        voices = speechSynthesis.getVoices();
    }
    
// Debug log - show which voice is being used
    const readingVoice = getEnglishVoice();
    console.log('=== VOICE SELECTION DEBUG ===');
    console.log('Total voices available:', voices.length);
    console.log('Reading voice (used for all modes):', readingVoice?.name, '| Lang:', readingVoice?.lang);
    console.log('Dialogue mode uses SAME voice with pitch variation (1.4 for addresser, 0.7 for addressee)');
    console.log('All available English voices:');
    voices.filter(v => v.lang.startsWith('en')).forEach(v => {
        console.log('  -', v.name, '(', v.lang, ')');
    });
    console.log('=============================');

}

        // Get the BEST English voice available
function getEnglishVoice() {
    if (!voices.length) loadVoices();
    
    // Priority order: best to worst
    const voicePriority = [
        // iOS premium voices (best quality)
        'Samantha (Enhanced)',
        'Samantha',
        
        // Google voices (very good quality)
        'Google US English',
        'Chrome OS US English',
        
        // Other good iOS voices
        'Karen',
        'Victoria',
        'Allison',
        
        // Windows premium voices
        'Microsoft Zira Desktop',
        'Microsoft David Desktop',
        
        // Android voices
        'en-US-language'
    ];
    
    // Try to find voices in priority order
    for (const voiceName of voicePriority) {
        const voice = voices.find(v => v.name.includes(voiceName));
        if (voice) {
            console.log('‚úì Selected voice:', voice.name);
            return voice;
        }
    }
    
    // Fallback: any US English voice
    let voice = voices.find(v => v.lang === 'en-US');
    
    // Last resort: any English voice
    if (!voice) voice = voices.find(v => v.lang.startsWith('en'));
    
    console.log('Fallback voice:', voice?.name || 'None found');
    return voice || null;
}

        // ========================================
        // TEXT-TO-SPEECH FUNCTIONS
        // ========================================

        // Clean text for TTS with improved phrasing
function cleanTextForTTS(text) {
    return text.replace(/\*/g, '')
                  .replace(/\//g, '')
                  .replace(/\([^)]*\)/g, '')
                  .replace(/\[[^\]]*\]/g, '')
                  // Add brief pauses after punctuation for better phrasing
                  .replace(/\.\s+/g, '.  ')      // Double space after period
                  .replace(/,\s+/g, ', ')        // Space after comma
                  .replace(/\?\s+/g, '?  ')      // Double space after question
                  .replace(/!\s+/g, '!  ')       // Double space after exclamation
                  .replace(/:\s+/g, ':  ')       // Double space after colon
                  .replace(/;\s+/g, '; ')        // Space after semicolon
                  .replace(/\s+/g, ' ')          // Normalize spaces
                  .trim();
}

        // Speak text
        function speakText(text) {
            stopSpeech();
            const cleaned = cleanTextForTTS(text);
            if (!cleaned) return;

            const utterance = new SpeechSynthesisUtterance(cleaned);
            utterance.lang = 'en-US';
            utterance.rate = speechRate;

            const voice = getEnglishVoice();
            if (voice) utterance.voice = voice;

            utterance.onend = () => {
                currentSpeech = null;
            };

            currentSpeech = utterance;
            speechSynthesis.speak(utterance);
        }

// Speak text using Google Translate (high quality)
function speakWithGoogleTranslate(text) {
    stopSpeech();
    const cleaned = cleanTextForTTS(text);
    if (!cleaned) return;
    
    // Encode text for URL
    const encodedText = encodeURIComponent(cleaned);
    
    // Google Translate TTS API URL
    const audioUrl = `https://translate.google.com/translate_tts?ie=UTF-8&tl=en&client=tw-ob&q=${encodedText}`;
    
    // Create and play audio
    const audio = new Audio(audioUrl);
    audio.playbackRate = speechRate;
    
    audio.onended = () => {
        currentSpeech = null;
    };
    
    audio.onerror = () => {
        console.error('Google Translate audio failed, falling back to Web Speech API');
        speakText(text);  // Fallback to regular TTS
    };
    
    currentSpeech = audio;
    audio.play().catch(err => {
        console.error('Playback failed:', err);
        speakText(text);  // Fallback if playback fails
    });
}

        // Stop speech (both Web Speech API and Audio elements)
function stopSpeech() {
    // Stop Web Speech API
    if (speechSynthesis.speaking || speechSynthesis.pending) {
        speechSynthesis.cancel();
    }
    
    // Stop Google Translate audio if playing
    if (currentSpeech && currentSpeech instanceof Audio) {
        currentSpeech.pause();
        currentSpeech.currentTime = 0;
    }
    
    currentSpeech = null;
    
    // Clear dialogue timeouts
    if (dialoguePlayTimeout) {
        clearTimeout(dialoguePlayTimeout);
        dialoguePlayTimeout = null;
    }
    isPlayingDialogue = false;
    
    // DON'T reset isPlayingAll and isPaused here if we're just pausing
    // They will be reset by the specific functions that need to
}

        // ========================================
        // TEXT CONTENT FUNCTIONS
        // ========================================

        // Load text content
function loadTextContent(lessonKey) {
    const tableBody = document.getElementById('textTableBody');
    const data = textDatabase[lessonKey];

    if (!data || data.length === 0) {
        tableBody.innerHTML = '<tr class="no-data"><td colspan="2">No data available. <br>(Êö´ÁÑ°Ë≥áÊñô)</td></tr>';
        setTimeout(() => {
            const textTable = document.getElementById('textTable');
            if (textTable) {
                textTable.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }
        }, 50);
        return;
    }

    let html = '';
    let itemIndex = 0; // Add counter for unique IDs
    
    data.forEach((section) => {
        html += `<tr>
            <td colspan="2" class="section-header">${section.section}</td>
        </tr>`;
        
        section.items.forEach((item) => {
            const uniqueId = `item-${itemIndex++}`;
            
            html += `<tr class="text-row">
                <td class="audio-controls">
                    <button class="audio-btn play-btn" data-text-id="${uniqueId}" onclick="speakTextById('${uniqueId}')">üîä</button>
                    <button class="audio-btn stop-btn" onclick="stopSpeech()">‚èπ</button>
                    <button class="audio-btn easy-btn" data-easy-id="${uniqueId}" onclick="showEasyVersionById('${uniqueId}')">üòä</button>
                    <button class="audio-btn dialogue-btn" onclick="showDialogue('${lessonKey}')">üí¨</button>
                </td>
                <td class="content-cell">
                    <div class="english-text">${item.english}</div>
                    <div class="chinese-translation">${item.chinese}</div>
                    <div class="hidden-data" data-id="${uniqueId}" data-english="${escapeForDataAttribute(item.english)}" data-easy="${escapeForDataAttribute(item.easy)}"></div>
                </td>
            </tr>`;
        });
    });

    tableBody.innerHTML = html;
}

// Helper function to escape for data attributes (use JSON encoding)
function escapeForDataAttribute(text) {
    return text.replace(/"/g, '&quot;')
               .replace(/'/g, '&#39;');
}

// New function to speak text by ID
function speakTextById(id) {
    const dataDiv = document.querySelector(`[data-id="${id}"]`);
    if (dataDiv) {
        const text = dataDiv.getAttribute('data-english');
        // Decode HTML entities back to normal text
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        speakText(textarea.value);
    }
}

// New function to show easy version by ID
function showEasyVersionById(id) {
    const dataDiv = document.querySelector(`[data-id="${id}"]`);
    if (dataDiv) {
        const easyText = dataDiv.getAttribute('data-easy');
        // Decode HTML entities back to normal text
        const textarea = document.createElement('textarea');
        textarea.innerHTML = easyText;
        showEasyVersion(textarea.value);
    }
}

        // ========================================
        // EASY VERSION FUNCTIONS
        // ========================================

        // Show easy version modal
        function showEasyVersion(easyText) {
            currentEasyText = easyText;
            document.getElementById('easyVersionText').textContent = easyText;
            document.getElementById('easyModal').style.display = 'block';
        }

        // Play easy version audio
        function playEasyAudio() {
            if (currentEasyText) {
                speakText(currentEasyText);
            }
        }

        // Close easy modal
        function closeEasyModal() {
            document.getElementById('easyModal').style.display = 'none';
            stopSpeech();
        }

        // ========================================
        // DIALOGUE FUNCTIONS
        // ========================================

        // Parse dialogue data
        function parseDialogueData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim());
            const dialogueLines = [];
            
            for (let line of lines) {
                if (line.includes('^')) {
                    const parts = line.split('^').map(s => s.trim());
                    if (parts.length === 2) {
                        dialogueLines.push({
                            addresser: parts[0],
                            addressee: parts[1]
                        });
                    }
                }
            }
            
            return dialogueLines;
        }

        // Show dialogue modal
        function showDialogue(lessonKey) {
            const dialogueText = dialogueDatabase[lessonKey];
            if (!dialogueText || !dialogueText.trim()) {
                alert('No dialogue available for this lesson.');
                return;
            }
            
            currentDialogueData = parseDialogueData(dialogueText);
            if (currentDialogueData.length === 0) {
                alert('No dialogue available for this lesson.');
                return;
            }
            
            currentDialogueIndex = 0;
            isPlayingAll = false;
            isPaused = false;
            
            renderDialogueLines();
            updateDialogueButtons();
            
            document.getElementById('dialogueModal').style.display = 'block';
        }

        // Render all dialogue lines
        function renderDialogueLines() {
            const container = document.getElementById('dialogueContainer');
            let html = '';
            
            currentDialogueData.forEach((line, index) => {
                const isActive = index === currentDialogueIndex;
                html += `
                    <div class="dialogue-line ${isActive ? 'active' : ''}" data-index="${index}">
                        <div class="dialogue-row addresser">
                            <div class="dialogue-icon">üë©‚Äçü¶∞</div>
                            <div class="dialogue-bubble">${line.addresser}</div>
                        </div>
                        <div class="dialogue-row addressee">
                            <div class="dialogue-bubble">${line.addressee}</div>
                            <div class="dialogue-icon">üë¶</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Scroll to active line
            setTimeout(() => {
                const activeLine = container.querySelector('.dialogue-line.active');
                if (activeLine) {
                    activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // Update active dialogue line
        function updateActiveDialogueLine() {
            const lines = document.querySelectorAll('.dialogue-line');
            lines.forEach((line, index) => {
                if (index === currentDialogueIndex) {
                    line.classList.add('active');
                    line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    line.classList.remove('active');
                }
            });
        }

        // Next dialogue line
        function nextDialogueLine() {
            if (currentDialogueIndex < currentDialogueData.length - 1) {
                currentDialogueIndex++;
                updateActiveDialogueLine();
                updateDialogueButtons();
            }
        }

        // Speak dialogue line with pitch differentiation ONLY
function speakDialogueLine(addresserText, addresseeText, callback) {
    stopSpeech();
    
    if (!addresserText || !addresseeText) {
        if (callback) callback();
        return;
    }
    
    const cleanAddresser = cleanTextForTTS(addresserText);
    const cleanAddressee = cleanTextForTTS(addresseeText);
    
    // Get the SAME voice used in reading mode
    const readingVoice = getEnglishVoice();
    
    // Speak addresser first (HIGHER pitch, same voice)
    const utterance1 = new SpeechSynthesisUtterance(cleanAddresser);
    utterance1.lang = 'en-US';
    utterance1.rate = speechRate;
    utterance1.pitch = 1.4;  // Higher pitch for addresser
    if (readingVoice) utterance1.voice = readingVoice;  // Use SAME voice as reading
    
    utterance1.onend = () => {
        // Reset addresser highlight
        const currentLine = document.querySelector('.dialogue-line.active');
        const addresserBubble = currentLine?.querySelector('.addresser .dialogue-bubble');
        if (addresserBubble) {
            addresserBubble.style.transition = 'background-color 0.3s';
            addresserBubble.style.backgroundColor = '#e3f2fd';  // Back to original color
        }
        
        // Small pause before addressee speaks
        setTimeout(() => {
            // Highlight addressee speaking
            const addresseeBubble = currentLine?.querySelector('.addressee .dialogue-bubble');
            if (addresseeBubble) {
                addresseeBubble.style.transition = 'background-color 0.3s';
                addresseeBubble.style.backgroundColor = '#a5d6a7';  // Brighter green
            }
            
            // Speak addressee (LOWER pitch, same voice)
            const utterance2 = new SpeechSynthesisUtterance(cleanAddressee);
            utterance2.lang = 'en-US';
            utterance2.rate = speechRate;
            utterance2.pitch = 0.6;  // Lower pitch for addressee
            if (readingVoice) utterance2.voice = readingVoice;  // Use SAME voice as reading
            
            utterance2.onend = () => {
                // Reset addressee highlight
                if (addresseeBubble) {
                    addresseeBubble.style.backgroundColor = '#c8e6c9';  // Back to original color
                }
                
                currentSpeech = null;
                isPlayingDialogue = false;
                if (callback) callback();
            };
            
            currentSpeech = utterance2;
            speechSynthesis.speak(utterance2);
        }, 100);
    };
    
    // Highlight addresser speaking
    const currentLine = document.querySelector('.dialogue-line.active');
    const addresserBubble = currentLine?.querySelector('.addresser .dialogue-bubble');
    if (addresserBubble) {
        addresserBubble.style.transition = 'background-color 0.3s';
        addresserBubble.style.backgroundColor = '#90caf9';  // Brighter blue
    }
    
    isPlayingDialogue = true;
    currentSpeech = utterance1;
    speechSynthesis.speak(utterance1);
}

        // Play/Stop current dialogue line
        function togglePlayStopDialogue() {
            const btn = document.getElementById('playStopBtn');
            
            if (isPlayingDialogue) {
                stopSpeech();
                btn.textContent = 'üîä Play';
                btn.classList.remove('stop');
            } else {
                const currentLine = currentDialogueData[currentDialogueIndex];
                if (currentLine) {
                    btn.textContent = '‚èπ Stop';
                    btn.classList.add('stop');
                    speakDialogueLine(currentLine.addresser, currentLine.addressee, () => {
                        btn.textContent = 'üîä Play';
                        btn.classList.remove('stop');
                    });
                }
            }
        }

        
       function playNextInSequence() {
    if (!isPlayingAll || isPaused) return;
    
    if (currentDialogueIndex >= currentDialogueData.length) {
        isPlayingAll = false;
        isPaused = false;
        updateDialogueButtons();
        return;
    }
    
    updateActiveDialogueLine();
    const currentLine = currentDialogueData[currentDialogueIndex];
    
    speakDialogueLine(currentLine.addresser, currentLine.addressee, () => {
        if (!isPlayingAll) return;
        if (isPaused) return;
        
        currentDialogueIndex++;
        
        if (currentDialogueIndex < currentDialogueData.length) {
            // Pause between dialogue pairs
            dialoguePlayTimeout = setTimeout(() => {
                if (!isPlayingAll || isPaused) return;
                playNextInSequence();
            }, DIALOGUE_PAUSE_DURATION);
        } else {
            isPlayingAll = false;
            isPaused = false;
            updateDialogueButtons();
        }
    });
}

// Toggle Play/Pause
function togglePlayPause() {
    if (isPlayingAll && !isPaused) {
        // Currently playing - pause it
        isPaused = true;
        stopSpeech();
        if (dialoguePlayTimeout) {
            clearTimeout(dialoguePlayTimeout);
            dialoguePlayTimeout = null;
        }
        updateDialogueButtons();
    } else {
        // Start or resume playing
        if (isPaused) {
            // Resuming from pause
            isPaused = false;
            updateDialogueButtons();
            playNextInSequence();
        } else {
            // Starting fresh
            isPlayingAll = true;
            isPaused = false;
            updateDialogueButtons();
            playNextInSequence();
        }
    }
}

// Reset to beginning
function resetDialogue() {
    stopSpeech();
    isPlayingAll = false;
    isPaused = false;
    currentDialogueIndex = 0;
    if (dialoguePlayTimeout) {
        clearTimeout(dialoguePlayTimeout);
        dialoguePlayTimeout = null;
    }
    updateActiveDialogueLine();
    updateDialogueButtons();
}

// Go back to previous exchange
function backDialogueLine() {
    if (currentDialogueIndex > 0) {
        currentDialogueIndex--;
        updateActiveDialogueLine();
        updateDialogueButtons();
    }
}

        // Pause/Resume play all
function togglePauseResumeDialogue() {
    if (!isPlayingAll) return;
    
    const btn = document.getElementById('pauseResumeBtn');
    
    if (isPaused) {
        // Resume
        isPaused = false;
        btn.textContent = '‚è∏Ô∏è Pause';
        playNextInSequence();
    } else {
        // Pause
        isPaused = true;
        btn.textContent = '‚ñ∂Ô∏è Resume';
        stopSpeech();
        if (dialoguePlayTimeout) {
            clearTimeout(dialoguePlayTimeout);
            dialoguePlayTimeout = null;
        }
    }
}

        // Update dialogue button states
function updateDialogueButtons() {
    const backBtn = document.getElementById('backLineBtn');
    const nextBtn = document.getElementById('nextLineBtn');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    
    // Back button - disabled at first exchange OR during active playback (not paused)
    if (currentDialogueIndex <= 0 || (isPlayingAll && !isPaused)) {
        backBtn.disabled = true;
    } else {
        backBtn.disabled = false;
    }
    
    // Next button - disabled at last exchange OR during active playback (not paused)
    if (currentDialogueIndex >= currentDialogueData.length - 1 || (isPlayingAll && !isPaused)) {
        nextBtn.disabled = true;
    } else {
        nextBtn.disabled = false;
    }
    
    // Play/Pause button
    if (isPlayingAll && !isPaused) {
        playPauseBtn.textContent = '‚è∏Ô∏è Pause';
        playPauseBtn.classList.remove('play-all');
        playPauseBtn.classList.add('stop');
    } else if (isPlayingAll && isPaused) {
        playPauseBtn.textContent = '‚ñ∂Ô∏è Resume';
        playPauseBtn.classList.add('play-all');
        playPauseBtn.classList.remove('stop');
    } else {
        playPauseBtn.textContent = '‚ñ∂Ô∏è Play';
        playPauseBtn.classList.add('play-all');
        playPauseBtn.classList.remove('stop');
    }
    
    // Reset button - disabled only when at first exchange AND not playing
    if (currentDialogueIndex === 0 && !isPlayingAll) {
        resetBtn.disabled = true;
    } else {
        resetBtn.disabled = false;
    }
}

        // Close dialogue modal
        function closeDialogueModal() {
            document.getElementById('dialogueModal').style.display = 'none';
            stopSpeech();
            isPlayingAll = false;
            isPaused = false;
            updateDialogueButtons();
        }

// Handle keyboard shortcuts in dialogue modal
function handleDialogueKeyboard(event) {
    const dialogueModal = document.getElementById('dialogueModal');
    
    // Only handle if dialogue modal is open
    if (dialogueModal.style.display !== 'block') return;
    
    switch(event.key) {
        case 'ArrowRight':
            event.preventDefault();
            if (!document.getElementById('nextLineBtn').disabled) {
                nextDialogueLine();
            }
            break;
            
        case 'ArrowLeft':
            event.preventDefault();
            if (!document.getElementById('backLineBtn').disabled) {
                backDialogueLine();
            }
            break;
            
        case ' ':
        case 'Spacebar': // For older browsers
            event.preventDefault();
            togglePlayPause();
            break;
            
        case 'r':
        case 'R':
            event.preventDefault();
            if (!document.getElementById('resetBtn').disabled) {
                resetDialogue();
            }
            break;
            
        case 'Escape':
            event.preventDefault();
            closeDialogueModal();
            break;
    }
}

        // ========================================
        // FLOATING NAVIGATION
        // ========================================
        
        function handleFloatingButtons() {
    const backToTopBtn = document.getElementById('backToTopBtn');
    const prevSectionBtn = document.getElementById('prevSectionBtn');
    const nextSectionBtn = document.getElementById('nextSectionBtn');
    const buttonCategories = document.querySelector('.button-categories');
    
    if (!backToTopBtn || !prevSectionBtn || !nextSectionBtn || !buttonCategories) return;
    
    const buttonCategoriesBottom = buttonCategories.offsetTop + buttonCategories.offsetHeight;
    
    if (window.scrollY > buttonCategoriesBottom + 100) {
        backToTopBtn.classList.add('show');
        prevSectionBtn.classList.add('show');
        nextSectionBtn.classList.add('show');
    } else {
        backToTopBtn.classList.remove('show');
        prevSectionBtn.classList.remove('show');
        nextSectionBtn.classList.remove('show');
    }
}

        function scrollToTop() {
            const buttonCategories = document.querySelector('.button-categories');
            if (buttonCategories) {
                buttonCategories.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            } else {
                window.scrollTo({ 
                    top: 0, 
                    behavior: 'smooth' 
                });
            }
        }

        function scrollToNextSection() {
            const sectionHeaders = document.querySelectorAll('.section-header');
            
            if (sectionHeaders.length === 0) return;
            
            const currentScrollPos = window.scrollY;
            
            for (let i = 0; i < sectionHeaders.length; i++) {
                const headerPos = sectionHeaders[i].offsetTop;
                
                if (headerPos > currentScrollPos + 100) {
                    sectionHeaders[i].scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                    return;
                }
            }
            
            window.scrollTo({ 
                top: document.body.scrollHeight, 
                behavior: 'smooth' 
            });
        }

function scrollToPrevSection() {
    const sectionHeaders = document.querySelectorAll('.section-header');
    
    if (sectionHeaders.length === 0) return;
    
    const currentScrollPos = window.scrollY;
    let targetSection = null;
    
    // Find the current section we're viewing (or just passed)
    let currentSectionIndex = -1;
    for (let i = 0; i < sectionHeaders.length; i++) {
        const headerPos = sectionHeaders[i].offsetTop;
        // If we're past this section header (with small buffer)
        if (currentScrollPos >= headerPos - 50) {
            currentSectionIndex = i;
        } else {
            break;
        }
    }
    
    // Go to previous section
    if (currentSectionIndex > 0) {
        // Go to the section before current
        targetSection = sectionHeaders[currentSectionIndex - 1];
    } else if (currentSectionIndex === 0) {
        // Already at first section, go to top
        scrollToTop();
        return;
    } else {
        // Somehow before all sections, go to first section
        targetSection = sectionHeaders[0];
    }
    
    // Scroll to target
    if (targetSection) {
        targetSection.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    } else {
        scrollToTop();
    }
}

        // ========================================
        // INITIALIZATION
        // ========================================
        
        // Initialize event listeners
        function initializeEventListeners() {
            document.body.addEventListener('click', () => loadVoices(), { once: true });

            // Lesson buttons
            const lessonButtons = document.querySelectorAll('.lesson-btn');
            lessonButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    lessonButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const lessonKey = this.getAttribute('data-lesson');
                    loadTextContent(lessonKey);
                });
            });

            // Speed buttons
            const speedButtons = document.querySelectorAll('.speed-btn');
            speedButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    speedButtons.forEach(b => b.classList.remove('active-speed'));
                    this.classList.add('active-speed');
                    speechRate = parseFloat(this.getAttribute('data-speed'));
                    stopSpeech();
                });
            });

            // Welcome modal
            document.getElementById('welcomeOkBtn').addEventListener('click', () => {
                document.getElementById('welcomeModal').style.display = 'none';
            });

            // Easy version modal
            document.getElementById('closeEasyModal').addEventListener('click', closeEasyModal);
            document.getElementById('playEasyBtn').addEventListener('click', playEasyAudio);
            document.getElementById('stopEasyBtn').addEventListener('click', stopSpeech);

            // Dialogue modal
document.getElementById('closeDialogueModal').addEventListener('click', closeDialogueModal);
document.getElementById('backLineBtn').addEventListener('click', backDialogueLine);
document.getElementById('nextLineBtn').addEventListener('click', nextDialogueLine);
document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
document.getElementById('resetBtn').addEventListener('click', resetDialogue);

            // Floating buttons
document.getElementById('backToTopBtn').addEventListener('click', scrollToTop);
document.getElementById('prevSectionBtn').addEventListener('click', scrollToPrevSection);
document.getElementById('nextSectionBtn').addEventListener('click', scrollToNextSection);
            window.addEventListener('scroll', handleFloatingButtons);
            handleFloatingButtons();

            // Click outside modal to close
            window.addEventListener('click', (e) => {
                const easyModal = document.getElementById('easyModal');
                const dialogueModal = document.getElementById('dialogueModal');
                
                if (e.target === easyModal) {
                    closeEasyModal();
                }
                
                if (e.target === dialogueModal) {
                    closeDialogueModal();
                }
            });

// Keyboard shortcuts for dialogue modal
document.addEventListener('keydown', handleDialogueKeyboard);

window.addEventListener('beforeunload', () => stopSpeech());

            window.addEventListener('beforeunload', () => stopSpeech());
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeEventListeners();
        });
    </script>
</body>
</html>
