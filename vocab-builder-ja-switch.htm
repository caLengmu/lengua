<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Vocab Builder</title>
    <style>
        :root {
            --primary: #E53935;      /* Japanese Red */
            --secondary: #FF9800;    /* Orange */
            --accent1: #2196F3;      /* Blue */
            --accent2: #4CAF50;      /* Green */
            --accent3: #9C27B0;      /* Purple */
            --dark: #2C2C2C;         /* Dark Gray */
            --light: #F8F8F8;        /* Light Gray */
            --mid: #757575;          /* Mid Gray */
            --japanese: #1976D2;     /* Japanese Blue */
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', 'Arial', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .tts-system-selector {
            margin-top: 15px;
            font-size: 16px;
            color: var(--dark);
        }

        .tts-system-selector label {
            font-weight: bold;
            margin-right: 8px;
        }

        .tts-system-selector select {
            padding: 8px 12px;
            border: 2px solid var(--mid);
            border-radius: 6px;
            background-color: white;
            color: var(--dark);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .tts-system-selector select:hover {
            border-color: var(--accent1);
        }

        .tts-system-selector select:focus {
            outline: none;
            border-color: var(--primary);
        }

        h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
            gap: 10px;
        }

        .left-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }

        .text-import-btn {
            background-color: var(--secondary);
            color: black;
        }

        .japanese-to-english-btn {
            background-color: var(--accent3);
            color: white;
            padding: 16px 25px;
            font-size: 18px;
        }

        .listen-choose-btn {
            background-color: var(--accent2);
            color: white;
            padding: 16px 25px;
            font-size: 18px;
        }

        .start-btn {
            background-color: var(--primary);
            color: white;
            padding: 16px 25px;
            font-size: 20px;
        }

        .ai-support-btn {
            background-color: var(--accent1);
            color: white;
            padding: 12px 24px;
            font-size: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            clear: both;
            display: table;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--dark);
            color: var(--light);
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.03);
        }

        tr:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .speaker-icon {
            cursor: pointer;
            color: var(--secondary);
            margin-left: 8px;
            font-size: 20px;
        }

        .japanese-text {
            font-size: 18px;
            font-weight: bold;
            color: var(--japanese);
        }

        .reading-text {
            font-size: 14px;
            color: var(--mid);
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--light);
            width: 90%;
            max-width: 500px;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .modal h2 {
            margin-top: 0;
            color: var(--primary);
            font-size: 1.8rem;
        }

        .prompt {
            font-size: 24px;
            margin: 20px 0;
            color: var(--dark);
            font-weight: bold;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            margin-bottom: 15px;
            border: 2px solid var(--mid);
            border-radius: 6px;
            box-sizing: border-box;
        }

        .feedback {
            margin: 15px 0;
            font-size: 25px;
            font-weight: bold;
            min-height: 27px;
        }

        .correct {
            color: var(--accent2);
        }

        .incorrect {
            color: var(--primary);
        }

        .hint {
            color: var(--accent1);
            font-style: italic;
            font-size: 25px;
            margin: 10px 0;
            min-height: 24px;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .submit-btn {
            background-color: var(--primary);
            color: white;
        }

        .speak-btn {
            background-color: var(--accent1);
            color: white;
        }

        .hint-btn {
            background-color: var(--secondary);
            color: var(--dark);
        }

        .answer-btn {
            background-color: var(--accent3);
            color: white;
        }

        .next-btn {
            background-color: var(--accent2);
            color: white;
        }

        .close-btn {
            background-color: var(--mid);
            color: white;
        }

        .copy-btn {
            background-color: var(--accent3);
            color: white;
        }

        .recording {
            background-color: var(--primary);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .hidden {
            display: none;
        }

        #file-input {
            display: none;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--mid);
            font-style: italic;
        }

        .tts-speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tts-speed-control select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid var(--mid);
            background-color: white;
            font-size: 14px;
        }

        .tts-speed-control label {
            font-weight: bold;
            color: white;
        }

        .reveal-answer {
            color: var(--primary);
            font-weight: bold;
            font-size: 30px;
            margin: 10px 0;
            min-height: 27px;
        }

        .section-header {
            background-color: var(--dark);
            color: var(--light);
            font-weight: bold;
        }

        .section-header td {
            background-color: var(--dark);
            color: var(--light);
            padding: 10px 15px;
        }

        /* Text Import Modal Styles */
        #text-import-content {
            width: 100%;
            height: 200px;
            padding: 12px;
            margin: 15px 0;
            font-size: 14px;
            border: 2px solid var(--mid);
            border-radius: 6px;
            box-sizing: border-box;
            resize: vertical;
            white-space: pre-wrap;
            font-family: 'Hiragino Sans', 'Yu Gothic', monospace;
            overflow-y: auto;
        }

        #text-import-modal .modal-content {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .button-set {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.02);
        }

        .button-set h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--dark);
        }

        .preset-btn {
            margin: 5px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            border: none;
            cursor: pointer;
            font-weight: normal;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .jlpt-btn {
            background-color: var(--accent1);
            color: white;
        }

        .kanji-btn {
            background-color: var(--accent2);
            color: white;
        }

        .grammar-btn {
            background-color: var(--accent3);
            color: white;
        }

        .other-btn {
            background-color: var(--secondary);
            color: var(--dark);
        }

        /* AI Support Modal Styles */
        #ai-support-modal .modal-content {
            max-width: 600px;
        }

        .ai-support-links {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .ai-support-link {
            background-color: var(--accent1);
            color: white;
            text-decoration: none;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-support-link:hover {
            background-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }

        /* Listen and Choose Modal Styles */
        #listen-choose-modal .modal-content {
            max-width: 100%;
            width: 95%;
            max-height: 95vh;
            padding: 15px;
        }

        .listen-answer-section {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .listen-answer-display {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            min-height: 30px;
            padding: 10px 15px;
            border: 2px solid var(--mid);
            border-radius: 8px;
            background-color: white;
            flex-grow: 1;
            text-align: center;
        }

        .listen-speaker {
            cursor: pointer;
            color: var(--secondary);
            font-size: 28px;
            padding: 8px;
            border-radius: 50%;
            background-color: rgba(255, 152, 0, 0.1);
            transition: all 0.2s ease;
        }

        .listen-speaker:hover {
            background-color: rgba(255, 152, 0, 0.2);
            transform: scale(1.1);
        }

        .timer-feedback-section {
            margin-bottom: 25px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-feedback {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }

        .choices-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 25px;
            max-width: 100%;
        }

        .choice-button {
            padding: 15px 10px;
            border: 2px solid var(--mid);
            border-radius: 8px;
            background-color: white;
            color: var(--dark);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.3;
        }

        .choice-button:hover {
            background-color: var(--accent1);
            color: white;
            border-color: var(--accent1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .choice-button.correct {
            background-color: var(--accent2);
            color: white;
            border-color: var(--accent2);
        }

        .choice-button.incorrect {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .choice-button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .listen-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .listen-next-btn {
            background-color: var(--accent2);
            color: white;
            padding: 12px 24px;
            font-size: 18px;
        }

        .listen-close-btn {
            background-color: var(--mid);
            color: white;
            padding: 12px 24px;
            font-size: 18px;
        }

        .date-info {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            font-size: 14px;
            line-height: 1.6;
            color: var(--dark);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-weight: bold;
            max-width: 90%;
            z-index: 10;
        }

        .date-info span {
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .date-info .emoji {
            margin-right: 8px;
            font-size: 16px;
        }

        .date-info .countdown {
            color: var(--primary);
            margin: 0 3px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .date-info {
                position: static;
                margin: 0 auto 15px auto;
                width: 100%;
                max-width: 100%;
                text-align: center;
                right: auto;
                top: auto;
            }
            
            .date-info span {
                justify-content: center;
            }
            
            header {
                display: flex;
                flex-direction: column;
            }

            .controls {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .left-controls {
                justify-content: space-between;
                width: 100%;
            }

            .preset-buttons {
                grid-template-columns: 1fr;
            }

            .ai-support-links {
                grid-template-columns: 1fr;
            }

            .choices-grid {
                gap: 10px;
            }

            .choice-button {
                padding: 12px 8px;
                font-size: 14px;
                min-height: 50px;
            }

            #listen-choose-modal .modal-content {
                width: 98%;
                padding: 10px;
            }
        }

        .visitor-counter {
            margin-top: 40px;
            text-align: center;
            padding: 15px;
            color: var(--dark);
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #visitor-count {
            font-weight: bold;
        }

        /* Refresh Reminder Popup Styles */
        .popup-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-content {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .popup-layout {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .mascot-image {
            width: 150px;
            flex-shrink: 0;
        }

        .mascot-image img {
            width: 100%;
            height: auto;
        }

        .speech-bubble {
            position: relative;
            background-color: #FFF3E0;
            border: 2px solid var(--secondary);
            border-radius: 15px;
            padding: 15px;
            margin-left: 15px;
        }

        .speech-bubble:before {
            content: "";
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            border-width: 15px 15px 15px 0;
            border-style: solid;
            border-color: transparent var(--secondary) transparent transparent;
        }

        .speech-bubble:after {
            content: "";
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            border-width: 12px 12px 12px 0;
            border-style: solid;
            border-color: transparent #FFF3E0 transparent transparent;
        }

        .japanese-text-popup {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .english-text-popup {
            font-size: 16px;
            color: var(--dark);
        }

        .close-reminder-btn {
            background-color: var(--accent1);
            color: white;
            padding: 12px 24px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .close-reminder-btn:hover {
            background-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
        }

        @media (max-width: 600px) {
            .popup-layout {
                flex-direction: column;
            }
            
            .speech-bubble {
                margin-left: 0;
                margin-top: 15px;
            }
            
            .speech-bubble:before, .speech-bubble:after {
                left: 50%;
                top: -15px;
                transform: translateX(-50%) rotate(90deg);
            }
            
            .speech-bubble:after {
                top: -12px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div id="date-info" class="date-info"></div>
        <h1>ğŸŒ Japanese Vocab Builder (1.0)</h1>
        <div class="tts-system-selector">
            <label for="tts-system">éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ : </label>
            <select id="tts-system">
                <option value="android" selected>Android</option>
                <option value="ios">iOS</option>
            </select>
        </div>
    </header>

    <div class="controls">
        <div class="left-controls">
            <button class="text-import-btn" id="text-import-btn">ğŸ“ å˜èªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
        <button class="japanese-to-english-btn" id="japanese-to-english-btn" disabled>ğŸ‘€ æ—¥æœ¬èªâ†’è‹±èª</button>
        <button class="listen-choose-btn" id="listen-choose-btn" disabled>ğŸ§ èã„ã¦é¸æŠ</button>
        <button class="start-btn" id="start-btn" disabled>ğŸ¤ è‹±èªâ†’æ—¥æœ¬èª</button>
        <button class="ai-support-btn" id="ai-support-btn">ğŸ’¡ AIæ”¯æ´</button>
    </div>

    <table id="vocabulary-table">
        <thead>
            <tr>
                <th>
                    <div class="tts-speed-control">
                        <label for="tts-speed">æ—¥æœ¬èªå˜èª</label>
                        <select id="tts-speed">
                            <option value="0.6">0.6x</option>
                            <option value="0.8">0.8x</option>
                            <option value="1">1x</option>                                                       
                        </select>
                    </div>
                </th>
                <th>è‹±èª/æ„å‘³</th>
                <th>
                    <label>
                        <input type="checkbox" id="select-all"> ã™ã¹ã¦é¸æŠ
                    </label>
                </th>
            </tr>
        </thead>
        <tbody id="vocabulary-body">
            <tr>
                <td colspan="3" class="no-data">å˜èªãƒªã‚¹ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„</td>
            </tr>
        </tbody>
    </table>

    <!-- Text Import Modal -->
    <div id="text-import-modal" class="modal">
        <div class="modal-content">
            <h2>å˜èªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
            
            <!-- Button Sets -->
            <div class="preset-buttons">
                <!-- JLPT Buttons -->
                <div class="button-set jlpt-buttons">
                    <h3>JLPT ãƒ¬ãƒ™ãƒ«</h3>
                    <button class="preset-btn jlpt-btn" data-preset="jlptN5">N5 åŸºæœ¬</button>
                    <button class="preset-btn jlpt-btn" data-preset="jlptN4">N4 ä¸­ç´š</button>
                    <button class="preset-btn jlpt-btn" data-preset="jlptN3">N3 ä¸Šç´š</button>
                </div>
                
                <!-- Kanji Buttons -->
                <div class="button-set kanji-buttons">
                    <h3>æ¼¢å­—å­¦ç¿’</h3>
                    <button class="preset-btn kanji-btn" data-preset="kanji1">å°å­¦1å¹´</button>
                    <button class="preset-btn kanji-btn" data-preset="kanji2">å°å­¦2å¹´</button>
                    <button class="preset-btn kanji-btn" data-preset="kanji3">å°å­¦3å¹´</button>
                </div>
                
                <!-- Grammar Buttons -->
                <div class="button-set grammar-buttons">
                    <h3>æ–‡æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
                    <button class="preset-btn grammar-btn" data-preset="grammar1">åŸºæœ¬æ–‡æ³•</button>
                    <button class="preset-btn grammar-btn" data-preset="grammar2">æ•¬èª</button>
                    <button class="preset-btn grammar-btn" data-preset="grammar3">åŠ©è©</button>
                </div>
                
                <!-- Other Button -->
                <div class="button-set other-buttons">
                    <h3>ãã®ä»–</h3>
                    <button class="preset-btn other-btn" data-preset="other1">æ—¥å¸¸ä¼šè©±</button>
                    <button class="preset-btn other-btn" data-preset="other2">ãƒ“ã‚¸ãƒã‚¹</button>
                </div>
            </div>
            
            <!-- Text Import Field -->
            <textarea id="text-import-content" placeholder="æ—¥æœ¬èª=è‹±èªã®å½¢å¼ã§å˜èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            
            <!-- Action Buttons -->
            <div class="button-group">
                <button id="text-import-submit-btn" class="submit-btn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button id="text-import-copy-btn" class="copy-btn">ã‚³ãƒ”ãƒ¼</button>
                <button id="text-import-clear-btn" class="hint-btn">ã‚¯ãƒªã‚¢</button>
                <button id="text-import-close-btn" class="close-btn">é–‰ã˜ã‚‹</button>
            </div>        
        </div>
    </div>

    <!-- AI Support Modal -->
    <div id="ai-support-modal" class="modal">
        <div class="modal-content">
            <h2>ğŸ’¡ AIæ”¯æ´ãƒ„ãƒ¼ãƒ«</h2>
            <div class="ai-support-links">
                <a href="https://jisho.org/" class="ai-support-link" target="_blank">ğŸ” Jishoè¾æ›¸</a>
                <a href="https://chatgpt.com/" class="ai-support-link" target="_blank">ğŸŒŸ ä¾‹æ–‡ç”Ÿæˆ</a>
                <a href="https://chatgpt.com/" class="ai-support-link" target="_blank">ğŸ’¬ ä¼šè©±ç·´ç¿’</a>
                <a href="https://chatgpt.com/" class="ai-support-link" target="_blank">ğŸ“š æ–‡æ³•èª¬æ˜</a>
                <a href="https://chatgpt.com/" class="ai-support-link" target="_blank">âœï¸ æ¼¢å­—ç·´ç¿’</a>
                <a href="https://chatgpt.com/" class="ai-support-link" target="_blank">ğŸ¯ JLPTå¯¾ç­–</a>
                <a href="https://chatgpt.com/" class="ai-support-link" target="_blank">ğŸ—¾ æ–‡åŒ–å­¦ç¿’</a>
                <a href="https://chatgpt.com/" class="ai-support-link" target="_blank">ğŸ“– èª­è§£ç·´ç¿’</a>
            </div>
            <div class="button-group">
                <button id="ai-support-close-btn" class="close-btn">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Japanese to English Quiz Modal -->
    <div id="japanese-to-english-modal" class="modal">
        <div class="modal-content">
            <div class="prompt">ã“ã®æ—¥æœ¬èªã®æ„å‘³ã‚’è€ƒãˆã¦ã€ç­”ãˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
            
            <div style="font-size: 32px; font-weight: bold; color: var(--japanese); margin: 20px 0; display: flex; align-items: center; justify-content: center; gap: 15px;">
                <span id="japanese-word-display" class="japanese-text"></span>
                <span class="speaker-icon" id="japanese-word-speaker" title="èã" style="cursor: pointer; color: var(--secondary); font-size: 24px;">ğŸ”Š</span>
            </div>
            
            <div id="english-answer-display" class="reveal-answer" style="display: none;"></div>
            <div id="check-question" style="display: none; font-size: 23px; color: var(--accent1); margin-top: 10px;">æ­£è§£ã§ã—ãŸã‹ï¼Ÿ</div>
            
            <div style="margin-top: 30px;">
                <button id="check-answer-btn" class="submit-btn" style="width: 100%; margin-bottom: 15px; padding: 15px;">ç­”ãˆã‚’ç¢ºèª</button>
                
                <div class="button-group">
                    <button id="japanese-next-btn" class="next-btn">æ¬¡ã¸</button>
                    <button id="japanese-close-btn" class="close-btn">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Listen and Choose Modal -->
    <div id="listen-choose-modal" class="modal">
        <div class="modal-content">
            <h2>ğŸ§ èã„ã¦é¸æŠ</h2>
            
            <!-- Answer Display Section -->
            <div class="listen-answer-section">
                <div id="listen-answer-display" class="listen-answer-display">ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯</div>
                <div class="listen-speaker" id="listen-speaker" title="éŸ³å£°å†ç”Ÿ">ğŸ”Š</div>
            </div>
            
            <!-- Timer and Feedback Section -->
            <div class="timer-feedback-section">
                <div id="timer-feedback" class="timer-feedback"></div>
            </div>
            
            <!-- Choices Grid -->
            <div id="choices-grid" class="choices-grid">
                <!-- Choices will be dynamically generated -->
            </div>
            
            <!-- Control Buttons -->
            <div class="listen-controls">
                <button id="listen-next-btn" class="listen-next-btn">æ¬¡ã¸</button>
                <button id="listen-close-btn" class="listen-close-btn">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="modal">
        <div class="modal-content">
            <div id="prompt" class="prompt">"<span id="translation-prompt"></span>" ã‚’æ—¥æœ¬èªã§è¨€ã£ã¦ãã ã•ã„ã€‚</div>
            <input type="text" id="answer-input" class="answer-input" placeholder="ã“ã“ã«ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...">
            <div id="feedback" class="feedback"></div>
            <div id="hint-text" class="hint"></div>
            <div id="reveal-answer" class="reveal-answer"></div>
            <div class="button-group">
                <button id="submit-btn" class="submit-btn">âœ… or â</button>
                <button id="speak-btn" class="speak-btn">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
                <button id="hint-btn" class="hint-btn">â“ ãƒ’ãƒ³ãƒˆ</button>
                <button id="answer-btn" class="answer-btn">ğŸ”‘ ç­”ãˆ</button>
                <button id="next-btn" class="next-btn">æ¬¡ã¸</button>
                <button id="close-btn" class="close-btn">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const japaneseToEnglishBtn = document.getElementById('japanese-to-english-btn');
        const japaneseToEnglishModal = document.getElementById('japanese-to-english-modal');
        const japaneseWordDisplay = document.getElementById('japanese-word-display');
        const japaneseWordSpeaker = document.getElementById('japanese-word-speaker');
        const englishAnswerDisplay = document.getElementById('english-answer-display');
        const checkQuestion = document.getElementById('check-question');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const japaneseNextBtn = document.getElementById('japanese-next-btn');
        const japaneseCloseBtn = document.getElementById('japanese-close-btn');

        // Listen and Choose Modal Elements
        const listenChooseBtn = document.getElementById('listen-choose-btn');
        const listenChooseModal = document.getElementById('listen-choose-modal');
        const listenAnswerDisplay = document.getElementById('listen-answer-display');
        const listenSpeaker = document.getElementById('listen-speaker');
        const timerFeedback = document.getElementById('timer-feedback');
        const choicesGrid = document.getElementById('choices-grid');
        const listenNextBtn = document.getElementById('listen-next-btn');
        const listenCloseBtn = document.getElementById('listen-close-btn');

        const textImportBtn = document.getElementById('text-import-btn');
        const startBtn = document.getElementById('start-btn');
        const aiSupportBtn = document.getElementById('ai-support-btn');
        const vocabularyTable = document.getElementById('vocabulary-table');
        const vocabularyBody = document.getElementById('vocabulary-body');
        const selectAllCheckbox = document.getElementById('select-all');
        const quizModal = document.getElementById('quiz-modal');
        const translationPrompt = document.getElementById('translation-prompt');
        const answerInput = document.getElementById('answer-input');
        const feedbackEl = document.getElementById('feedback');
        const hintTextEl = document.getElementById('hint-text');
        const revealAnswerEl = document.getElementById('reveal-answer');
        const submitBtn = document.getElementById('submit-btn');
        const speakBtn = document.getElementById('speak-btn');
        const hintBtn = document.getElementById('hint-btn');
        const answerBtn = document.getElementById('answer-btn');
        const nextBtn = document.getElementById('next-btn');
        const closeBtn = document.getElementById('close-btn');
        const ttsSpeedSelect = document.getElementById('tts-speed');
        const ttsSystemSelect = document.getElementById('tts-system');
        
        // Text Import Modal Elements
        const textImportModal = document.getElementById('text-import-modal');
        const textImportContent = document.getElementById('text-import-content');
        const textImportSubmitBtn = document.getElementById('text-import-submit-btn');
        const textImportCloseBtn = document.getElementById('text-import-close-btn');
        const textImportClearBtn = document.getElementById('text-import-clear-btn');

        // AI Support Modal Elements
        const aiSupportModal = document.getElementById('ai-support-modal');
        const aiSupportCloseBtn = document.getElementById('ai-support-close-btn');

        // Variables
        let isSpeaking = false;
        let vocabularyData = [];
        let currentQuizWords = [];
        let currentWordIndex = -1;
        let currentWord = null;
        let recognition = null;
        let speechRate = 0.6;

        let currentJapaneseQuizWords = [];
        let currentJapaneseWordIndex = -1;
        let currentJapaneseWord = null;

        // Listen and Choose Quiz Variables
        let currentListenQuizWords = [];
        let currentListenWordIndex = -1;
        let currentListenWord = null;
        let questionStartTime = null;
        let isAnswered = false;

        // ===== JAPANESE TTS FUNCTIONS =====
        let voices = [];
        let voicesLoaded = false;
        let currentTTSSystem = 'android';

        // Load voices function
        function loadVoices() {
            return new Promise((resolve) => {
                voices = speechSynthesis.getVoices();
                
                if (voices.length > 0) {
                    voicesLoaded = true;
                    console.log('Voices loaded:', voices.length);
                    resolve(voices);
                } else {
                    const utterance = new SpeechSynthesisUtterance('');
                    utterance.volume = 0;
                    speechSynthesis.speak(utterance);
                    
                    setTimeout(() => {
                        voices = speechSynthesis.getVoices();
                        voicesLoaded = true;
                        console.log('Voices loaded after trigger:', voices.length);
                        resolve(voices);
                    }, 100);
                }
            });
        }

        // Get the best Japanese voice
        function getJapaneseVoice() {
            if (!voicesLoaded || voices.length === 0) {
                return null;
            }
            
            if (currentTTSSystem === 'ios') {
                const iosPreferredVoices = [
                    'Kyoko', // iOS Japanese female
                    'Otoya', // iOS Japanese male
                    'Japanese'
                ];
                
                for (const voiceName of iosPreferredVoices) {
                    const voice = voices.find(v => v.name.includes(voiceName));
                    if (voice) {
                        console.log('Using iOS Japanese voice:', voice.name);
                        return voice;
                    }
                }
            } else {
                const androidPreferredVoices = [
                    'Google æ—¥æœ¬èª', 
                    'Japanese (Japan)',
                    'ja-JP-language',
                    'Japanese Japan'
                ];
                
                for (const voiceName of androidPreferredVoices) {
                    const voice = voices.find(v => 
                        v.name.includes(voiceName) || 
                        v.name.toLowerCase().includes(voiceName.toLowerCase())
                    );
                    if (voice) {
                        console.log('Using Android Japanese voice:', voice.name);
                        return voice;
                    }
                }
            }
            
            // Fallback: find any Japanese voice
            const japaneseVoice = voices.find(v => 
                v.lang === 'ja-JP' || 
                v.lang.startsWith('ja-') ||
                v.name.toLowerCase().includes('japan')
            );
            
            if (japaneseVoice) {
                console.log(`Using fallback Japanese voice for ${currentTTSSystem}:`, japaneseVoice.name);
                return japaneseVoice;
            }
            
            console.log(`Using first available voice for ${currentTTSSystem}:`, voices[0]?.name);
            return voices[0] || null;
        }

        // Japanese speak function
        function speakJapanese(text) {
            console.log('Speak Japanese function called with:', text, 'System:', currentTTSSystem);
            
            if (!('speechSynthesis' in window)) {
                console.warn('Speech synthesis not supported');
                return;
            }

            const cleanText = text.replace(/[()[\]*]/g, '').trim();
            
            if (!cleanText) return;

            speechSynthesis.cancel();
            
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(cleanText);
                
                const preferredVoice = getJapaneseVoice();
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                utterance.lang = 'ja-JP';
                utterance.rate = speechRate;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                if (currentTTSSystem === 'ios') {
                    utterance.rate = Math.max(0.5, speechRate * 0.9);
                } else {
                    utterance.rate = speechRate;
                    utterance.pitch = 0.95;
                }
                
                utterance.onstart = function() {
                    console.log('Japanese speech started successfully');
                };
                
                utterance.onend = function() {
                    console.log('Japanese speech ended normally');
                    isSpeaking = false;
                };

                utterance.onerror = function(event) {
                    console.error('Japanese speech error:', event.error);
                    isSpeaking = false;
                };

                try {
                    speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('Failed to start Japanese speech synthesis:', error);
                }
            }, 100);
        }

        // Initialize TTS
        async function initializeTTS() {
            console.log('Initializing Japanese TTS...');
            
            const testUtterance = new SpeechSynthesisUtterance('');
            testUtterance.volume = 0;
            speechSynthesis.speak(testUtterance);
            
            await new Promise(resolve => setTimeout(resolve, 200));
            
            await loadVoices();
            
            if (voices.length === 0) {
                console.log('No voices found, trying again...');
                await new Promise(resolve => setTimeout(resolve, 500));
                await loadVoices();
            }
            
            console.log('Japanese TTS initialization complete. Voices:', voices.length);
            
            speechSynthesis.addEventListener('voiceschanged', () => {
                console.log('Voices changed event fired');
                loadVoices();
            });
        }

        // Initialize Speech Recognition for Japanese
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'ja-JP';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript.trim();
                answerInput.value = transcript;
                speakBtn.textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›';
                speakBtn.classList.remove('recording');
            };

            recognition.onend = function() {
                speakBtn.textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›';
                speakBtn.classList.remove('recording');
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error', event.error);
                speakBtn.textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›';
                speakBtn.classList.remove('recording');
            };
        }

        // TTS Speed change handler
        ttsSpeedSelect.addEventListener('change', (e) => {
            speechRate = parseFloat(e.target.value);
        });

        // TTS System change handler
        ttsSystemSelect.addEventListener('change', (e) => {
            currentTTSSystem = e.target.value;
            console.log(`Switched to ${currentTTSSystem} TTS system`);
            
            loadVoices().then(() => {
                console.log(`Voice loading complete for ${currentTTSSystem}`);
            });
        });

        // AI Support button click handler
        aiSupportBtn.addEventListener('click', () => {
            aiSupportModal.style.display = 'flex';
        });

        aiSupportCloseBtn.addEventListener('click', () => {
            aiSupportModal.style.display = 'none';
        });

        // Text Import button click handler
        textImportBtn.addEventListener('click', () => {
            textImportModal.style.display = 'flex';
        });

        textImportCloseBtn.addEventListener('click', () => {
            textImportModal.style.display = 'none';
        });

        // Preset vocabulary data
        const presetVocabulary = {
            jlptN5: `â—JLPT N5 åŸºæœ¬å˜èª
ã“ã‚“ã«ã¡ã¯=Hello
ã‚ã‚ŠãŒã¨ã†=Thank you
ã™ã¿ã¾ã›ã‚“=Excuse me / Sorry
ã¯ã„=Yes
ã„ã„ãˆ=No
ã‚ãŸã—=I / Me
ã‚ãªãŸ=You
ã“ã‚Œ=This
ãã‚Œ=That
ã‚ã‚Œ=That (over there)
ã“ã“=Here
ãã“=There
ã‚ãã“=Over there
ã„ã¾=Now
ãã‚‡ã†=Today
ã‚ã—ãŸ=Tomorrow
ãã®ã†=Yesterday
ãŠã„ã—ã„=Delicious
ãŸã‹ã„=Expensive / High
ã‚„ã™ã„=Cheap
ã‚ãŸã‚‰ã—ã„=New
ãµã‚‹ã„=Old
ãŠãŠãã„=Big
ã¡ã„ã•ã„=Small
ã‚ã¤ã„=Hot
ã•ã‚€ã„=Cold
ãŸã¹ã‚‹=To eat
ã®ã‚€=To drink
ã„ã=To go
ãã‚‹=To come
ã¿ã‚‹=To see / To watch
ãã=To listen / To hear
ã‚ˆã‚€=To read
ã‹ã=To write
ã¯ãªã™=To speak / To talk
ã‚„ã™ã‚€=To rest
ã­ã‚‹=To sleep
ãŠãã‚‹=To wake up
ã¯ãŸã‚‰ã=To work
ã¹ã‚“ãã‚‡ã†ã™ã‚‹=To study`,

            jlptN4: `â—JLPT N4 ä¸­ç´šå˜èª
ã‘ã£ã“ã‚“=Marriage
ã‚Šã‚‡ã“ã†=Travel
ã³ã‚‡ã†ã=Illness
ã‘ã‚“ã“ã†=Health
ã—ã”ã¨=Work / Job
ãŒã£ã“ã†=School
ã³ã‚‡ã†ã„ã‚“=Hospital
ãˆã=Station
ãã†ã“ã†=Airport
ãƒ›ãƒ†ãƒ«=Hotel
ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³=Restaurant
ã§ã‚“ã—ã‚ƒ=Train
ãƒã‚¹=Bus
ã˜ã¦ã‚“ã—ã‚ƒ=Bicycle
ãã‚‹ã¾=Car
ã²ã“ã†ã=Airplane
ã¦ã‚“ã=Weather
ã‚ã‚=Rain
ã‚†ã=Snow
ã‹ãœ=Wind
ãŠã‚“ãŒã=Music
ãˆã„ãŒ=Movie
ã»ã‚“=Book
ã—ã‚“ã¶ã‚“=Newspaper
ãƒ†ãƒ¬ãƒ“=Television
ã§ã‚“ã‚=Telephone
ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼=Computer
ã„ã‚“ãŸãƒ¼ã­ã£ã¨=Internet
ã‹ã„ã‚‚ã®=Shopping
ã‚Šã‚‡ã†ã‚Š=Cooking
ã›ã‚“ãŸã=Laundry
ãã†ã˜=Cleaning
ã†ã‚“ã©ã†=Exercise
ã•ã‚“ã½=Walk
ã‚„ããã=Promise
ã—ã£ã±ã„=Failure
ã›ã„ã“ã†=Success
ã‚‚ã‚“ã ã„=Problem
ã‹ã„ã‘ã¤=Solution
ã‘ã„ã‘ã‚“=Experience`,

            jlptN3: `â—JLPT N3 ä¸Šç´šå˜èª
ã—ã‚ƒã‹ã„=Society
ã¶ã‚“ã‹=Culture
ã§ã‚“ã¨ã†=Tradition
ãã˜ã‚…ã¤=Technology
ã‹ã‚“ãã‚‡ã†=Environment
ã›ã„ã˜=Politics
ã‘ã„ã–ã„=Economy
ãã‚‡ã†ã„ã=Education
ã„ã‚Šã‚‡ã†=Medical care
ã“ã†ã¤ã†=Transportation
ã•ã„ãŒã„=Disaster
ã¡ãã‚…ã†=Earth
ã†ã¡ã‚…ã†=Space
ã‚Œãã—=History
ã¡ã‚Š=Geography
ã‹ãŒã=Science
ã™ã†ãŒã=Mathematics
ã¶ã¤ã‚Š=Physics
ã‹ãŒã=Chemistry
ã›ã„ã¶ã¤=Biology
ã—ã‚“ã‚Š=Psychology
ã¦ã¤ãŒã=Philosophy
ã’ã„ã˜ã‚…ã¤=Art
ã¶ã‚“ãŒã=Literature
ãŠã‚“ãŒã=Music
ãˆã‚“ã’ã=Theater
ã†ã‚“ã©ã†=Sports
ãã‚‡ã†ãã†=Competition
ã›ã„ã•ã=Policy
ã›ã„ã©=System
ãã—ã=Organization
ã ã‚“ãŸã„=Group
ã“ã†ã˜ã‚‡ã†=Factory
ããã‚‡ã†=Company
ã—ã˜ã‚‡ã†=Market
ã“ã†ã“ã=Advertisement
ã˜ã‚‡ã†ã»ã†=Information
ãƒ‡ãƒ¼ã‚¿=Data
ã‘ã‚“ãã‚…ã†=Research
ã‹ã„ã¯ã¤=Development`,

            kanji1: `â—å°å­¦1å¹´ç”Ÿã®æ¼¢å­—
ä¸€=One
äºŒ=Two
ä¸‰=Three
å››=Four
äº”=Five
å…­=Six
ä¸ƒ=Seven
å…«=Eight
ä¹=Nine
å=Ten
ç™¾=Hundred
åƒ=Thousand
äºº=Person
å¤§=Big
å°=Small
ä¸Š=Up / Above
ä¸‹=Down / Below
å·¦=Left
å³=Right
ä¸­=Middle / Inside
å¤–=Outside
å‰=Front / Before
å¾Œ=Back / After
å±±=Mountain
å·=River
ç«=Fire
æ°´=Water
æœ¨=Tree
é‡‘=Gold / Money
åœŸ=Soil
æ—¥=Sun / Day
æœˆ=Moon / Month
å¹´=Year
æ™‚=Time
åˆ†=Minute
ç™½=White
é»’=Black
èµ¤=Red
é’=Blue
å…¥=Enter
å‡º=Exit
æ‰‹=Hand
è¶³=Foot`,

            kanji2: `â—å°å­¦2å¹´ç”Ÿã®æ¼¢å­—
æ±=East
è¥¿=West
å—=South
åŒ—=North
é–“=Between / Room
è¿‘=Near
é =Far
é«˜=High / Tall
å®‰=Cheap / Safe
æ–°=New
å¤=Old
å¤š=Many
å°‘=Few
é•·=Long
çŸ­=Short
å¼·=Strong
å¼±=Weak
æ—©=Early
é…=Late
æ˜=Bright
æš—=Dark
ç†±=Hot
å†·=Cold
é‡=Heavy
è»½=Light
å¤ª=Fat / Thick
ç´°=Thin
åºƒ=Wide
ç‹­=Narrow
æ·±=Deep
æµ…=Shallow
é›£=Difficult
æ˜“=Easy
æ­£=Correct
é•=Wrong
å¥½=Like
å«Œ=Dislike
æœ‰=Have
ç„¡=None`,

            kanji3: `â—å°å­¦3å¹´ç”Ÿã®æ¼¢å­—
å­¦=Study
æ ¡=School
ç”Ÿ=Life / Student
å…ˆ=Before / Teacher
æ™‚=Time
é–“=Time / Room
ä»Š=Now
å¾Œ=After / Behind
æ¯=Every
é€±=Week
æ›œ=Day of week
æ˜¼=Noon
å¤œ=Night
æœ=Morning
å¤•=Evening
æ˜¥=Spring
å¤=Summer
ç§‹=Autumn
å†¬=Winter
æš–=Warm
æ¶¼=Cool
æ™´=Clear weather
é›¨=Rain
é›ª=Snow
é¢¨=Wind
é›²=Cloud
ç©º=Sky / Empty
æµ·=Ocean
æ± =Pond
å³¶=Island
æ©‹=Bridge
é§…=Station
é“=Road
è»Š=Car
é›»=Electricity
è©±=Talk / Story
èª=Language / Word
æ–‡=Sentence
å­—=Character
èª­=Read
æ›¸=Write
è=Listen
è¦‹=See
æ€=Think`,

            grammar1: `â—åŸºæœ¬æ–‡æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³
ã§ã™=Is / To be (polite)
ã§ã‚ã‚‹=Is / To be (formal)
ã =Is / To be (casual)
ã§ã¯ãªã„=Is not
ã˜ã‚ƒãªã„=Is not (casual)
ã¾ã™=Polite verb ending
ã¾ã›ã‚“=Negative polite verb ending
ã¾ã—ãŸ=Past tense polite
ã¾ã›ã‚“ã§ã—ãŸ=Past negative polite
ã‚‹=Verb ending (ichidan)
ã†=Verb ending (godan)
ãŸ=Past tense (casual)
ãªã„=Negative (casual)
ã¦=Te-form connector
ã§=Particle (by means of)
ã«=Particle (to/at/in)
ã‚’=Object particle
ãŒ=Subject particle
ã¯=Topic particle
ã‚‚=Also particle
ã®=Possessive particle
ã‹ã‚‰=From / Because
ã¾ã§=Until / To
ã¨=And / With
ã‚„=And (incomplete list)
ã‘ã‚Œã©=But / However
ã§ã‚‚=But / However
ãã—ã¦=And then
ãã‚Œã‹ã‚‰=And then / After that
ã ã‹ã‚‰=Therefore / So
ã—ã‹ã—=However
ã§ã‚‚=However / But`,

            grammar2: `â—æ•¬èª (Keigo)
ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›=Welcome (to customers)
ã„ã‚‰ã£ã—ã‚ƒã‚‹=To be (honorific)
ãŠã„ã§ã«ãªã‚‹=To come/go (honorific)
ã‚ã—ã‚ãŒã‚‹=To eat (honorific)
ãŠã®ã¿ã«ãªã‚‹=To drink (honorific)
ã”ã‚‰ã‚“ã«ãªã‚‹=To see (honorific)
ãŠã£ã—ã‚ƒã‚‹=To say (honorific)
ãªã•ã‚‹=To do (honorific)
ãã ã•ã‚‹=To give (honorific)
ã„ãŸã ã=To receive (humble)
ã‚‚ã†ã—ã‚ã’ã‚‹=To say (humble)
ã†ã‹ãŒã†=To visit/ask (humble)
ã¾ã„ã‚‹=To go/come (humble)
ãŠã‚‹=To be (humble)
ã„ãŸã™=To do (humble)
ã•ã—ã‚ã’ã‚‹=To give (humble)
ã¯ã„ã‘ã‚“=To see (humble)
ã¡ã‚‡ã†ã ã„=To receive (humble)
ãã‚“ã¡ã‚‡ã†=Tension/nervousness
ã‚Œã„ã=Etiquette
ãã‚“ã‘ã„=Respect
ã‘ã‚“ã˜ã‚‡ã†=Humility
ã¦ã„ã­ã„=Polite
ã—ã¤ã‚Œã„=Rudeness
ã”ã‚ã„ã•ã¤=Greeting
ãŠã˜ã=Bow
ã‚ã„ã—=Business card
ãŠãã‚ƒãã•ã¾=Customer (honorific)
ã›ã‚“ã›ã„=Teacher (respectful)
ã—ã‚ƒã¡ã‚‡ã†=Company president`,

            grammar3: `â—åŠ©è© (Particles)
ãŒ=Subject marker
ã‚’=Object marker
ã«=Direction/time/purpose
ã¸=Direction
ã§=Location of action/means
ã¨=And/with/quotation
ã‚„=Incomplete listing
ã®=Possessive/modification
ã¯=Topic marker
ã‚‚=Also/too
ã‹ã‚‰=From/because/since
ã¾ã§=Until/up to
ã‚ˆã‚Š=Than/from
ã®ã§=Because/since
ã®ã«=Although/despite
ã‘ã‚Œã©=But/however
ã‘ã‚Œã©ã‚‚=But/however (formal)
ãŒ=But/however
ã§ã‚‚=But/however
ãã‚Œã§=Therefore/so
ã ã‹ã‚‰=Therefore/because
ãã“ã§=Therefore/so
ã¨ã“ã‚ã§=By the way
ã¡ãªã¿ã«=Incidentally
ãŸã¨ãˆã°=For example
ã¤ã¾ã‚Š=In other words
ã™ãªã‚ã¡=That is to say
ã—ã‹ã—=However
ãŸã ã—=However/but
ã‚‚ã—=If
ã‚‚ã—ã‚‚=If (emphatic)
ãŸã¨ãˆ=Even if
ã¾ã•ã‹=Surely not
ãã£ã¨=Surely/certainly
ãŸã¶ã‚“=Probably
ã‚‚ã—ã‹ã—ã¦=Perhaps/maybe`,

            other1: `â—æ—¥å¸¸ä¼šè©±
ãŠã¯ã‚ˆã†=Good morning (casual)
ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™=Good morning (polite)
ã“ã‚“ã«ã¡ã¯=Good afternoon
ã“ã‚“ã°ã‚“ã¯=Good evening
ãŠã‚„ã™ã¿=Good night (casual)
ãŠã‚„ã™ã¿ãªã•ã„=Good night (polite)
ã•ã‚ˆã†ãªã‚‰=Goodbye (formal)
ã¾ãŸæ˜æ—¥=See you tomorrow
ã¾ãŸä»Šåº¦=See you next time
ãŠç–²ã‚Œã•ã¾=Good work/Thank you for your hard work
ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™=Thank you (polite)
ã©ã†ã„ãŸã—ã¾ã—ã¦=You're welcome
ã™ã¿ã¾ã›ã‚“=Excuse me/I'm sorry
ã”ã‚ã‚“ãªã•ã„=I'm sorry (polite)
ã”ã‚ã‚“=Sorry (casual)
ã„ãŸã ãã¾ã™=Before eating (gratitude for food)
ã”ã¡ãã†ã•ã¾=After eating (gratitude for food)
ã¯ã˜ã‚ã¾ã—ã¦=Nice to meet you
ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™=Please treat me favorably
ãŠå…ƒæ°—ã§ã™ã‹=How are you?
å…ƒæ°—ã§ã™=I'm fine
ãã†ã§ã™ã­=That's right/I agree
ãã†ã§ã™ã‹=Is that so?
ã‚ã‹ã‚Šã¾ã›ã‚“=I don't understand
ã‚ã‹ã‚Šã¾ã—ãŸ=I understand
ã¡ã‚‡ã£ã¨å¾…ã£ã¦=Wait a moment
ãŠå…ˆã«å¤±ç¤¼ã—ã¾ã™=Excuse me for leaving first
ãŠç–²ã‚Œã•ã¾ã§ã—ãŸ=Thank you for your hard work (past tense)
ã„ã‚‰ã£ã—ã‚ƒã„=Welcome (casual)
ã©ã†ã=Please go ahead/Here you are
ã©ã†ã‚‚=Thanks (casual)/Somehow`,

            other2: `â—ãƒ“ã‚¸ãƒã‚¹æ—¥æœ¬èª
ä¼šç¤¾=Company
ç¤¾å“¡=Company employee
éƒ¨é•·=Department manager
èª²é•·=Section chief
ä¸»ä»»=Supervisor
åŒåƒš=Colleague
ä¸Šå¸=Boss/superior
éƒ¨ä¸‹=Subordinate
å–¶æ¥­=Sales
ä¼ç”»=Planning
é–‹ç™º=Development
äººäº‹=Human resources
çµŒç†=Accounting
ç·å‹™=General affairs
ä¼šè­°=Meeting
æ‰“ã¡åˆã‚ã›=Business meeting
è³‡æ–™=Materials/documents
å ±å‘Š=Report
ææ¡ˆ=Proposal
å¥‘ç´„=Contract
å–å¼•=Business transaction
é¡§å®¢=Customer
å£²ä¸Š=Sales revenue
åˆ©ç›Š=Profit
äºˆç®—=Budget
ç· åˆ‡=Deadline
ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«=Schedule
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ=Project
æ¥­ç¸¾=Performance
æˆæœ=Results
ç›®æ¨™=Goal/target
èª²é¡Œ=Task/issue
å•é¡Œ=Problem
è§£æ±º=Solution
æ”¹å–„=Improvement
åŠ¹ç‡=Efficiency
å“è³ª=Quality
ã‚µãƒ¼ãƒ“ã‚¹=Service
ãŠå®¢æ§˜=Customer (respectful)
ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›=Welcome (to store/office)`
        };

        // Add event listeners to all preset buttons
        document.querySelectorAll('.preset-btn').forEach(button => {
            button.addEventListener('click', () => {
                const presetKey = button.dataset.preset;
                if (presetVocabulary[presetKey]) {
                    textImportContent.value = presetVocabulary[presetKey];
                }
            });
        });

        // Text Import Submit button click handler
        textImportSubmitBtn.addEventListener('click', () => {
            const text = textImportContent.value.trim();
            if (!text) {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹å‰ã«å˜èªãƒšã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            processTextImport(text);
            textImportModal.style.display = 'none';
        });

        // Text Import Clear button click handler
        textImportClearBtn.addEventListener('click', () => {
            textImportContent.value = '';
        });

        function processTextImport(text) {
            vocabularyData = [];
            const lines = text.split('\n');
            
            let currentSection = "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ";
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Check if this is a section header
                if (line.includes('â—') || line.includes('#')) {
                    currentSection = line.replace('â—', '').replace('#', '').trim();
                    continue;
                }
                
                const parts = line.split('=');
                if (parts.length < 2) continue;
                
                const vocabulary = parts[0].trim();
                const translation = parts[1].trim();
                
                if (vocabulary && translation) {
                    vocabularyData.push({
                        vocabulary: vocabulary,
                        translation: translation,
                        selected: true,
                        section: currentSection
                    });
                }
            }
            
            renderVocabularyTable();
            if (vocabularyData.length > 0) {
                startBtn.disabled = false;
                japaneseToEnglishBtn.disabled = false;
                listenChooseBtn.disabled = false;
            }
        }

        // Copy button click handler
        const textImportCopyBtn = document.getElementById('text-import-copy-btn');

        textImportCopyBtn.addEventListener('click', () => {
            const textToCopy = textImportContent.value;
            if (!textToCopy) {
                alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    const originalText = textImportCopyBtn.textContent;
                    textImportCopyBtn.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†!';
                    
                    setTimeout(() => {
                        textImportCopyBtn.textContent = originalText;
                    }, 1500);
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('ãƒ†ã‚­ã‚¹ãƒˆã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                });
        });

        function renderVocabularyTable() {
            if (vocabularyData.length === 0) {
                vocabularyBody.innerHTML = '<tr><td colspan="3" class="no-data">å˜èªãƒªã‚¹ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„</td></tr>';
                return;
            }
            
            vocabularyBody.innerHTML = '';
            
            // Group items by section
            const sectionMap = {};
            vocabularyData.forEach(item => {
                if (!sectionMap[item.section]) {
                    sectionMap[item.section] = [];
                }
                sectionMap[item.section].push(item);
            });
            
            // Render each section
            Object.keys(sectionMap).forEach(sectionName => {
                const sectionItems = sectionMap[sectionName];
                
                // Add section header row
                const sectionRow = document.createElement('tr');
                sectionRow.className = 'section-header';
                
                const sectionCell = document.createElement('td');
                sectionCell.colSpan = 2;
                sectionCell.textContent = sectionName;
                sectionCell.style.fontWeight = 'bold';
                sectionCell.style.backgroundColor = 'var(--dark)';
                sectionCell.style.color = 'var(--light)';
                sectionCell.style.padding = '10px 15px';
                
                const sectionCheckCell = document.createElement('td');
                const sectionCheckbox = document.createElement('input');
                sectionCheckbox.type = 'checkbox';
                sectionCheckbox.checked = sectionItems.every(item => item.selected);
                sectionCheckbox.dataset.section = sectionName;
                sectionCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    const section = e.target.dataset.section;
                    
                    vocabularyData.forEach((item, index) => {
                        if (item.section === section) {
                            item.selected = isChecked;
                            const checkbox = document.querySelector(`input[data-index="${index}"]`);
                            if (checkbox) checkbox.checked = isChecked;
                        }
                    });
                    
                    updateSelectAllCheckbox();
                });
                
                sectionCheckCell.appendChild(sectionCheckbox);
                sectionRow.appendChild(sectionCell);
                sectionRow.appendChild(sectionCheckCell);
                vocabularyBody.appendChild(sectionRow);
                
                // Add vocabulary items for this section
                sectionItems.forEach((item, localIndex) => {
                    const index = vocabularyData.findIndex(vItem => 
                        vItem.vocabulary === item.vocabulary && 
                        vItem.translation === item.translation);
                    
                    const row = document.createElement('tr');
                    
                    // Vocabulary column with speaker
                    const wordCell = document.createElement('td');
                    const cleanWord = item.vocabulary.replace(/\(.*\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();
                    
                    wordCell.innerHTML = `
                        <div class="japanese-text">${item.vocabulary}</div>
                        <span class="speaker-icon" title="èã" data-word="${cleanWord}">ğŸ”Š</span>
                    `;
                    
                    // Translation column
                    const translationCell = document.createElement('td');
                    translationCell.textContent = item.translation;
                    
                    // Checkbox column
                    const checkboxCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = item.selected;
                    checkbox.dataset.index = index;
                    checkbox.dataset.section = item.section;
                    checkbox.addEventListener('change', (e) => {
                        vocabularyData[index].selected = e.target.checked;
                        updateSectionCheckbox(item.section);
                        updateSelectAllCheckbox();
                    });
                    checkboxCell.appendChild(checkbox);
                    
                    row.appendChild(wordCell);
                    row.appendChild(translationCell);
                    row.appendChild(checkboxCell);
                    vocabularyBody.appendChild(row);
                });
            });
            
            // Add event listeners to speaker icons
            document.querySelectorAll('.speaker-icon').forEach(icon => {
                icon.addEventListener('click', (e) => {
                    const word = e.target.dataset.word;
                    speakJapanese(word);
                });
            });
            
            updateSelectAllCheckbox();
        }

        function updateSectionCheckbox(sectionName) {
            const sectionItems = vocabularyData.filter(item => item.section === sectionName);
            const allSelected = sectionItems.every(item => item.selected);
            const noneSelected = sectionItems.every(item => !item.selected);
            
            const sectionCheckbox = document.querySelector(`input[data-section="${sectionName}"]`);
            if (sectionCheckbox) {
                sectionCheckbox.checked = allSelected;
                sectionCheckbox.indeterminate = !allSelected && !noneSelected;
            }
        }

        function updateSelectAllCheckbox() {
            if (vocabularyData.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }
            
            const selectedCount = vocabularyData.filter(item => item.selected).length;
            
            if (selectedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedCount === vocabularyData.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        // Update the global "Select All" checkbox handler
        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            
            vocabularyData.forEach(item => {
                item.selected = isChecked;
            });
            
            document.querySelectorAll('#vocabulary-body input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = isChecked;
                if (checkbox.dataset.section) {
                    checkbox.indeterminate = false;
                }
            });
        });

        // Listen and Choose Quiz Functions
        function startListenAndChooseQuiz() {
            currentListenQuizWords = vocabularyData.filter(item => item.selected);
            if (currentListenQuizWords.length === 0) {
                alert('ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯å°‘ãªãã¨ã‚‚8å€‹ã®å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (currentListenQuizWords.length < 8) {
                alert('ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯å°‘ãªãã¨ã‚‚8å€‹ã®å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            resetListenAndChooseQuiz();
            listenChooseModal.style.display = 'flex';
            nextListenQuestion();
        }

        function resetListenAndChooseQuiz() {
            currentListenWordIndex = -1;
            currentListenWord = null;
            questionStartTime = null;
            isAnswered = false;
            listenAnswerDisplay.textContent = 'ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯';
            timerFeedback.textContent = '';
        }

        function nextListenQuestion() {
            isAnswered = false;
            questionStartTime = null;
            listenAnswerDisplay.textContent = 'ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯';
            timerFeedback.textContent = '';
            
            const previousIndex = currentListenWordIndex;
            
            if (currentListenQuizWords.length === 1) {
                currentListenWordIndex = 0;
            } else {
                do {
                    currentListenWordIndex = Math.floor(Math.random() * currentListenQuizWords.length);
                } while (currentListenWordIndex === previousIndex && currentListenQuizWords.length > 1);
            }
            
            currentListenWord = currentListenQuizWords[currentListenWordIndex];
            
            generateChoices();
        }

        function generateChoices() {
            if (!currentListenWord) return;
            
            const otherTranslations = currentListenQuizWords
                .filter(item => item.translation !== currentListenWord.translation)
                .map(item => item.translation);
            
            const shuffled = otherTranslations.sort(() => 0.5 - Math.random());
            const selectedChoices = shuffled.slice(0, 7);
            
            const allChoices = [...selectedChoices, currentListenWord.translation];
            
            const finalChoices = allChoices.sort(() => 0.5 - Math.random());
            
            choicesGrid.innerHTML = '';
            
            finalChoices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = choice;
                button.addEventListener('click', () => handleChoiceClick(button, choice));
                choicesGrid.appendChild(button);
            });
        }

        function handleChoiceClick(button, selectedChoice) {
            if (isAnswered) return;
            
            isAnswered = true;
            const responseTime = questionStartTime ? (Date.now() - questionStartTime) / 1000 : 0;
            
            document.querySelectorAll('.choice-button').forEach(btn => {
                btn.disabled = true;
            });
            
            const isCorrect = selectedChoice === currentListenWord.translation;
            
            if (isCorrect) {
                button.classList.add('correct');
                listenAnswerDisplay.textContent = currentListenWord.vocabulary.replace(/\(.*?\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();
                
                let feedbackMessage = '';
                if (responseTime < 2) {
                    feedbackMessage = 'å®Œç’§ï¼ âš¡';
                    speakJapanese('å®Œç’§');
                } else if (responseTime < 3.5) {
                    feedbackMessage = 'ã‚ˆãã§ãã¾ã—ãŸï¼ ğŸ‘';
                    speakJapanese('ã‚ˆãã§ãã¾ã—ãŸ');
                } else if (responseTime < 6) {
                    feedbackMessage = 'ã‚‚ã£ã¨æ—©ãï¼ â°';
                    speakJapanese('ã‚‚ã£ã¨æ—©ã');
                } else {
                    feedbackMessage = 'é…ã™ãã¾ã™... ğŸ˜´';
                    speakJapanese('é…ã™ãã¾ã™');
                }
                
                timerFeedback.textContent = `${feedbackMessage} (${responseTime.toFixed(1)}ç§’ã‹ã‹ã‚Šã¾ã—ãŸã€‚)`;
                timerFeedback.className = 'timer-feedback correct';
            } else {
                button.classList.add('incorrect');
                document.querySelectorAll('.choice-button').forEach(btn => {
                    if (btn.textContent === currentListenWord.translation) {
                        btn.classList.add('correct');
                    }
                });
                
                timerFeedback.textContent = 'é–“é•ã„ã§ã™ï¼ ğŸ˜“âŒ';
                timerFeedback.className = 'timer-feedback incorrect';
                speakJapanese('é–“é•ã„ã§ã™');
                
                listenAnswerDisplay.textContent = currentListenWord.vocabulary.replace(/\(.*?\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();
            }
        }

        // Listen and Choose event handlers
        listenChooseBtn.addEventListener('click', startListenAndChooseQuiz);

        listenSpeaker.addEventListener('click', () => {
            if (currentListenWord && !isAnswered) {
                const cleanWord = currentListenWord.vocabulary.replace(/\(.*?\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();
                speakJapanese(cleanWord);
                
                if (!questionStartTime) {
                    questionStartTime = Date.now();
                }
            }
        });

        listenNextBtn.addEventListener('click', nextListenQuestion);

        listenCloseBtn.addEventListener('click', () => {
            listenChooseModal.style.display = 'none';
        });

        // Japanese to English Quiz button handler
        japaneseToEnglishBtn.addEventListener('click', () => {
            currentJapaneseQuizWords = vocabularyData.filter(item => item.selected);
            if (currentJapaneseQuizWords.length === 0) {
                alert('ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯å°‘ãªãã¨ã‚‚1ã¤ã®å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            startJapaneseToEnglishQuiz();
        });

        // Japanese to English Quiz Modal event listeners
        checkAnswerBtn.addEventListener('click', showEnglishAnswer);
        japaneseNextBtn.addEventListener('click', nextJapaneseQuestion);
        japaneseCloseBtn.addEventListener('click', () => {
            japaneseToEnglishModal.style.display = 'none';
        });

        japaneseWordSpeaker.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (isSpeaking) {
                console.log('Already speaking, ignoring click');
                return;
            }
            
            if (currentJapaneseWord) {
                isSpeaking = true;
                const cleanWord = currentJapaneseWord.vocabulary.replace(/\(.*?\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();
                console.log('About to speak Japanese:', cleanWord);
                
                speakJapanese(cleanWord);
                
                setTimeout(() => {
                    isSpeaking = false;
                }, 3000);
            }
        });

        // Start Quiz button handler (English to Japanese)
        startBtn.addEventListener('click', () => {
            currentQuizWords = vocabularyData.filter(item => item.selected);
            
            if (currentQuizWords.length === 0) {
                alert('ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯å°‘ãªãã¨ã‚‚1ã¤ã®å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            startQuiz();
        });

        // Start the quiz (English to Japanese)
        function startQuiz() {
            resetQuiz();
            quizModal.style.display = 'flex';
            nextQuestion();
        }

        // Reset quiz state
        function resetQuiz() {
            currentWordIndex = -1;
            currentWord = null;
            answerInput.value = '';
            feedbackEl.textContent = '';
            feedbackEl.className = 'feedback';
            hintTextEl.textContent = '';
            revealAnswerEl.textContent = '';
        }

        // Load the next question
        function nextQuestion() {
            answerInput.value = '';
            feedbackEl.textContent = '';
            feedbackEl.className = 'feedback';
            hintTextEl.textContent = '';
            revealAnswerEl.textContent = '';
            
            const previousIndex = currentWordIndex;
            
            if (currentQuizWords.length === 1) {
                currentWordIndex = 0;
            } else {
                do {
                    currentWordIndex = Math.floor(Math.random() * currentQuizWords.length);
                } while (currentWordIndex === previousIndex && currentQuizWords.length > 1);
            }
            
            currentWord = currentQuizWords[currentWordIndex];
            translationPrompt.textContent = currentWord.translation;
        }

        // Submit answer
        function submitAnswer() {
            if (!currentWord) return;
            
            const userAnswer = answerInput.value.trim().toLowerCase();
            const correctAnswers = currentWord.vocabulary
                .split('/')
                .map(ans => ans.replace(/\(.*?\)/g, '').trim().toLowerCase());
            
            const normalizedUserAnswer = userAnswer.replace(/[.,?''â€¦\/#!$%\^&\*;:{}=\-_`~()]/g, "");
            
            const isCorrect = correctAnswers.some(answer => {
                const normalizedAnswer = answer.replace(/[.,?''â€¦\/#!$%\^&\*;:{}=\-_`~()]/g, "");
                return normalizedUserAnswer === normalizedAnswer;
            });
            
            if (isCorrect) {
                feedbackEl.textContent = 'ã‚ˆãã§ãã¾ã—ãŸï¼ ğŸ†ğŸ˜ŠğŸ‘';
                feedbackEl.className = 'feedback correct';
                speakJapanese('ã‚ˆãã§ãã¾ã—ãŸ');
            } else {
                feedbackEl.textContent = 'ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ãã ã•ã„ï¼ ğŸ”¥ğŸ”¥ğŸ”¥';
                feedbackEl.className = 'feedback incorrect';
                speakJapanese('ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ãã ã•ã„');
            }
        }

        // Show hint
        function showHint() {
            if (!currentWord) return;
            
            const correctAnswer = currentWord.vocabulary.replace(/\(.*?\)/g, '').trim();
            const firstChar = correctAnswer.charAt(0);
            
            hintTextEl.textContent = `æœ€åˆã®æ–‡å­—ã¯ã€Œ${firstChar}ã€ã§ã™ã€‚`;
        }

        // Show answer
        function showAnswer() {
            if (!currentWord) return;
            
            const correctAnswer = currentWord.vocabulary.replace(/\(.*?\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();
            revealAnswerEl.textContent = `${correctAnswer}`;
            speakJapanese(correctAnswer);
        }

        // Start Japanese to English Quiz
        function startJapaneseToEnglishQuiz() {
            console.log('Starting Japanese to English quiz');
            console.log('Voices loaded:', voicesLoaded, 'Voice count:', voices.length);
            
            if (!voicesLoaded || voices.length === 0) {
                console.log('Loading voices before starting quiz...');
                loadVoices().then(() => {
                    console.log('Voices loaded, starting quiz');
                    resetJapaneseToEnglishQuiz();
                    japaneseToEnglishModal.style.display = 'flex';
                    nextJapaneseQuestion();
                });
            } else {
                resetJapaneseToEnglishQuiz();
                japaneseToEnglishModal.style.display = 'flex';
                nextJapaneseQuestion();
            }
        }

        // Reset Japanese to English quiz state
        function resetJapaneseToEnglishQuiz() {
            currentJapaneseWordIndex = -1;
            currentJapaneseWord = null;
            englishAnswerDisplay.style.display = 'none';
            checkQuestion.style.display = 'none';
            checkAnswerBtn.style.display = 'block';
        }

        // Load next Japanese question
        function nextJapaneseQuestion() {
            englishAnswerDisplay.style.display = 'none';
            checkQuestion.style.display = 'none';
            checkAnswerBtn.style.display = 'block';
            
            const previousIndex = currentJapaneseWordIndex;
            
            if (currentJapaneseQuizWords.length === 1) {
                currentJapaneseWordIndex = 0;
            } else {
                do {
                    currentJapaneseWordIndex = Math.floor(Math.random() * currentJapaneseQuizWords.length);
                } while (currentJapaneseWordIndex === previousIndex && currentJapaneseQuizWords.length > 1);
            }
            
            currentJapaneseWord = currentJapaneseQuizWords[currentJapaneseWordIndex];
            const cleanWord = currentJapaneseWord.vocabulary.replace(/\(.*?\)/g, '').trim();
            japaneseWordDisplay.textContent = cleanWord;
        }

        // Show English answer
        function showEnglishAnswer() {
            if (!currentJapaneseWord) return;
            
            englishAnswerDisplay.textContent = currentJapaneseWord.translation;
            englishAnswerDisplay.style.display = 'block';
            checkQuestion.style.display = 'block';
            checkAnswerBtn.style.display = 'none';
        }

        // Event Listeners for Quiz Modal
        submitBtn.addEventListener('click', submitAnswer);
        
        answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitAnswer();
            }
        });
        
        speakBtn.addEventListener('click', () => {
            if (!recognition) {
                alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }
            
            try {
                if (speakBtn.textContent === 'ğŸ¤ éŸ³å£°å…¥åŠ›') {
                    recognition.start();
                    speakBtn.textContent = 'éŒ²éŸ³ä¸­';
                    speakBtn.classList.add('recording');
                } else {
                    recognition.stop();
                    speakBtn.textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›';
                    speakBtn.classList.remove('recording');
                }
            } catch (error) {
                console.error('Speech recognition error:', error);
                speakBtn.textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›';
                speakBtn.classList.remove('recording');
            }
        });
        
        hintBtn.addEventListener('click', showHint);
        
        answerBtn.addEventListener('click', showAnswer);
        
        nextBtn.addEventListener('click', nextQuestion);
        
        closeBtn.addEventListener('click', () => {
            quizModal.style.display = 'none';
            if (recognition) {
                recognition.stop();
            }
        });

        // Date information display
        function updateDateInfo() {
            const dateInfoEl = document.getElementById('date-info');
            
            const options = { 
                timeZone: 'Asia/Tokyo',
                weekday: 'long', 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric'
            };
            const today = new Date();
            const japanDate = today.toLocaleDateString('ja-JP', options);
            
            // Calculate days until JLPT (typically held in July and December)
            const nextJLPT = new Date('July 7, 2025'); // Adjust as needed
            nextJLPT.setHours(0, 0, 0, 0);
            const todayNoTime = new Date(today);
            todayNoTime.setHours(0, 0, 0, 0);
            const daysUntilJLPT = Math.ceil((nextJLPT - todayNoTime) / (1000 * 60 * 60 * 24));
            
            // Calculate days until Japanese New Year
            const newYear = new Date('January 1, 2026');
            newYear.setHours(0, 0, 0, 0);
            const daysUntilNewYear = Math.ceil((newYear - todayNoTime) / (1000 * 60 * 60 * 24));
            
            dateInfoEl.innerHTML = `
                <span><span class="emoji">ğŸ“…</span>${japanDate}</span><br>
                <span><span class="emoji">ğŸŒ</span><span class="countdown">${daysUntilJLPT}</span> days until JLPT</span>
                <span><span class="emoji">ğŸŠ</span><span class="countdown">${daysUntilNewYear}</span> days until New Year</span>
            `;
        }

        updateDateInfo();
        setInterval(updateDateInfo, 60000);

        // Initialize TTS when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeTTS();
        });

        document.addEventListener('click', function initOnFirstClick() {
            initializeTTS();
            document.removeEventListener('click', initOnFirstClick);
        }, { once: true });
    </script>

    <footer class="visitor-counter">
        <div id="visitor-count">ğŸ‘¥ è¨ªå•è€…æ•°ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </footer>

    <div id="refresh-reminder-popup" class="popup-container">
        <div class="popup-content">
            <div class="popup-layout">
                <div class="mascot-image">
                    <div style="width: 150px; height: 150px; background: linear-gradient(45deg, #FF6B6B, #4ECDC4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 60px;">ğŸŒ</div>
                </div>
                <div class="speech-bubble">
                    <p class="japanese-text-popup">æ¯å›ä½¿ç”¨ã™ã‚‹å‰ã«ã€Œãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ğŸ”„ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ›´æ–°ã‚’å–å¾—ã—ã¦ãã ã•ã„ï¼</p>
                    <p class="english-text-popup">éŸ³å£°æ©Ÿèƒ½ãŒå‹•ä½œã—ãªã„å ´åˆã¯ã€ãƒ‡ãƒã‚¤ã‚¹ã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚iOS/iPhoneãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éŸ³å£°æ©Ÿèƒ½ã¯æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                </div>
            </div>
            <button id="close-reminder-btn" class="close-reminder-btn">ã‚ã‹ã‚Šã¾ã—ãŸ (Got it!)</button>
        </div>
    </div>

    <script>
        // Visitor counter (simplified for Japanese version)
        function initVisitorCounter() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const hasVisitedToday = localStorage.getItem('visited_jp_' + today);
                
                if (!hasVisitedToday) {
                    localStorage.setItem('visited_jp_' + today, 'true');
                }
                
                // Simple visitor count display
                document.getElementById('visitor-count').innerHTML = "ğŸŒ Japanese Vocab Builder ã¸ã‚ˆã†ã“ãï¼";
            } catch (e) {
                console.error("Error with visitor counter:", e);
                document.getElementById('visitor-count').innerHTML = "ğŸŒ Japanese Vocab Builder ã¸ã‚ˆã†ã“ãï¼";
            }
        }

        initVisitorCounter();

        // Refresh Reminder Popup functionality
        document.addEventListener('DOMContentLoaded', () => {
            const refreshReminderPopup = document.getElementById('refresh-reminder-popup');
            
            setTimeout(() => {
                refreshReminderPopup.style.display = 'flex';
            }, 1000);
            
            const closeReminderBtn = document.getElementById('close-reminder-btn');
            closeReminderBtn.addEventListener('click', () => {
                refreshReminderPopup.style.display = 'none';
            });
        });
    </script>
</body>
</html>