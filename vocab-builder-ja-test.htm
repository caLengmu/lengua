<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>日本語 Vocab Builder</title>
<style>
:root {
--primary: #FF69B4; /* Hot Pink (a well-known CSS color) */
--secondary: #FF9800; /* Orange */
--accent1: #1976D2; /* Japanese Blue */
--accent2: #4CAF50; /* Green */
--accent3: #9C27B0; /* Purple */
--dark: #2C2C2C; /* Dark Gray */
--light: #F8F8F8; /* Light Gray */
--mid: #757575; /* Mid Gray */
}

body {
font-family: 'Hiragino Sans', 'Meiryo', 'MS Gothic', sans-serif;
background-color: var(--light);
color: var(--dark);
max-width: 900px;
margin: 0 auto;
padding: 20px;
line-height: 1.5;
}

header {
text-align: center;
margin-bottom: 30px;
}

h1 {
color: var(--primary);
font-size: 2.5rem;
margin-bottom: 10px;
letter-spacing: 1px;
}

.subtitle {
color: var(--mid);
font-size: 1.1rem;
margin-bottom: 15px;
}

.tts-system-selector {
margin-top: 15px;
font-size: 16px;
color: var(--dark);
}

.tts-system-selector label {
font-weight: bold;
margin-right: 8px;
}

.tts-system-selector select {
padding: 8px 12px;
border: 2px solid var(--mid);
border-radius: 6px;
background-color: white;
color: var(--dark);
font-size: 16px;
font-weight: bold;
cursor: pointer;
transition: border-color 0.2s ease;
}

.tts-system-selector select:hover {
border-color: var(--accent1);
}

.tts-system-selector select:focus {
outline: none;
border-color: var(--primary);
}

.controls {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 30px;
position: relative;
z-index: 1;
}

.left-controls {
display: flex;
gap: 15px;
align-items: center;
}

button {
padding: 10px 16px;
border: none;
border-radius: 6px;
font-size: 16px;
font-weight: bold;
cursor: pointer;
transition: all 0.2s ease;
box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
}

button:hover {
transform: translateY(-2px);
box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
}

.text-import-btn {
background-color: var(--secondary);
color: black;
}

.japanese-to-english-btn {
background-color: var(--accent3);
color: white;
padding: 16px 25px;
font-size: 20px;
}

.listen-choose-btn {
background-color: var(--accent2);
color: white;
padding: 16px 25px;
font-size: 20px;
}

.start-btn {
background-color: var(--primary);
color: white;
padding: 16px 25px;
font-size: 20px;
}

.ai-support-btn {
background-color: var(--accent1);
color: white;
padding: 12px 24px;
font-size: 18px;
}

.quiz-mode-selector {
background-color: white;
border: 2px solid var(--mid);
border-radius: 10px;
padding: 3px;
margin: 3px 0;
box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
}

.mode-options {
display: flex;
justify-content: space-around;
gap: 20px;
}

.mode-option {
display: flex;
align-items: center;
cursor: pointer;
padding: 10px 15px;
border: 2px solid transparent;
border-radius: 8px;
transition: all 0.3s ease;
flex: 1;
text-align: center;
}

.mode-option:hover {
background-color: rgba(93, 156, 236, 0.1);
border-color: var(--accent1);
}

.mode-option input[type="radio"] {
margin: 0 8px 0 0;
transform: scale(1.2);
}

.mode-option .option-text {
font-weight: bold;
font-size: 16px;
color: var(--dark);
}

.mode-option input[type="radio"]:checked + .option-text {
color: var(--primary);
}

table {
width: 100%;
border-collapse: collapse;
margin-top: 10px;
background-color: white;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
clear: both;
display: table;
}

th, td {
padding: 12px 15px;
text-align: left;
border-bottom: 1px solid #ddd;
}

th {
background-color: var(--dark);
color: var(--light);
font-weight: bold;
}

tr:nth-child(even) {
background-color: rgba(0, 0, 0, 0.03);
}

tr:hover {
background-color: rgba(0, 0, 0, 0.05);
}

.speaker-icon {
cursor: pointer;
color: var(--secondary);
margin-left: 8px;
font-size: 20px;
}

.modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.6);
z-index: 100;
justify-content: center;
align-items: center;
}

.modal-content {
background-color: var(--light);
width: 90%;
max-width: 500px;
padding: 25px;
border-radius: 10px;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
text-align: center;
}

.modal h2 {
margin-top: 0;
color: var(--primary);
font-size: 1.8rem;
}

.prompt {
font-size: 24px;
margin: 20px 0;
color: var(--dark);
font-weight: bold;
}

.answer-input {
width: 100%;
padding: 12px;
font-size: 18px;
margin-bottom: 15px;
border: 2px solid var(--mid);
border-radius: 6px;
box-sizing: border-box;
}

.feedback {
margin: 15px 0;
font-size: 25px;
font-weight: bold;
min-height: 27px;
}

.correct {
color: var(--accent2);
}

.incorrect {
color: var(--primary);
}

.hint {
color: var(--accent1);
font-style: italic;
font-size: 25px;
margin: 10px 0;
min-height: 24px;
}

.button-group {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 10px;
margin-top: 20px;
}

.submit-btn {
background-color: var(--primary);
color: white;
}

.speak-btn {
background-color: var(--accent1);
color: white;
}

.hint-btn {
background-color: var(--secondary);
color: var(--dark);
}

.answer-btn {
background-color: var(--accent3);
color: white;
}

.next-btn {
background-color: var(--accent2);
color: white;
}

.close-btn {
background-color: var(--mid);
color: white;
}

.memory-btn {
background-color: var(--accent1);
color: white;
}

.delete-custom-btn {
background-color: var(--light);
color: white;
font-size: 12px;
padding: 4px 8px;
margin-left: 5px;
}

.custom-list-container {
position: relative;
display: inline-block;
width: 100%;
}

.recording {
background-color: var(--primary);
animation: pulse 1.5s infinite;
}

@keyframes pulse {
0% { opacity: 1; }
50% { opacity: 0.7; }
100% { opacity: 1; }
}

.hidden {
display: none;
}

#file-input {
display: none;
}

.no-data {
text-align: center;
padding: 40px;
color: var(--mid);
}

.tts-speed-control {
display: flex;
align-items: center;
gap: 10px;
}

.tts-speed-control select {
padding: 5px;
border-radius: 4px;
border: 1px solid var(--mid);
background-color: white;
font-size: 14px;
}

.tts-speed-control label {
font-weight: bold;
color: white;
}

.reveal-answer {
color: var(--primary);
font-weight: bold;
font-size: 30px;
margin: 10px 0;
min-height: 27px;
}

.section-header {
background-color: var(--dark);
color: var(--light);
font-weight: bold;
position: relative;
}

.section-header td {
background-color: var(--dark);
color: var(--light);
padding: 10px 15px;
}

.collapse-btn {
background: none;
border: none;
color: var(--light);
font-size: 18px;
cursor: pointer;
padding: 0 8px 0 0;
margin: 0;
transition: transform 0.2s ease;
display: inline-flex;
align-items: center;
justify-content: center;
min-width: 30px;
box-shadow: none;
}

.collapse-btn:hover {
transform: scale(1.1);
box-shadow: none;
}

.section-collapsed .collapse-btn {
transform: rotate(-90deg);
}

.section-row {
display: table-row;
transition: all 0.3s ease;
}

.section-row.section-collapsed {
display: none;
}

.section-header .section-title {
display: flex;
align-items: center;
gap: 8px;
}

.progress-info {
background-color: var(--accent1);
color: white;
padding: 8px 16px;
border-radius: 20px;
font-size: 16px;
font-weight: bold;
margin-bottom: 15px;
display: inline-block;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.progress-section {
opacity: 0.8;
font-size: 14px;
}

#text-import-content {
width: 100%;
height: 100px;
padding: 12px;
margin: 15px 0;
font-size: 16px;
border: 2px solid var(--mid);
border-radius: 6px;
box-sizing: border-box;
resize: vertical;
}

#text-import-modal .modal-content {
max-width: 800px;
max-height: 90vh;
overflow-y: auto;
}

.preset-buttons {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
margin-bottom: 20px;
}

.button-set {
border: 1px solid #ddd;
border-radius: 8px;
padding: 10px;
background-color: rgba(0, 0, 0, 0.02);
}

.button-set h3 {
margin-top: 0;
margin-bottom: 10px;
font-size: 16px;
color: var(--dark);
}

.preset-btn {
margin: 5px;
padding: 8px 12px;
border-radius: 4px;
font-size: 14px;
border: none;
cursor: pointer;
font-weight: normal;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.textbook-btn {
background-color: var(--accent1);
color: white;
}

.jlpt-btn {
background-color: var(--accent2);
color: white;
}

.core-btn {
background-color: var(--accent3);
color: white;
}

.other-btn {
background-color: var(--secondary);
color: var(--dark);
}

#ai-support-modal .modal-content {
max-width: 600px;
}

.ai-support-links {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
margin: 20px 0;
}

.ai-support-link {
background-color: var(--accent1);
color: white;
text-decoration: none;
padding: 15px;
border-radius: 8px;
font-weight: bold;
transition: all 0.2s ease;
display: flex;
align-items: center;
justify-content: center;
}

.ai-support-link:hover {
background-color: var(--primary);
transform: translateY(-2px);
box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
}

#listen-choose-modal .modal-content {
max-width: 100%;
width: 95%;
max-height: 95vh;
padding: 15px;
}

.listen-answer-section {
display: flex;
align-items: center;
justify-content: center;
margin-bottom: 20px;
gap: 15px;
}

.listen-answer-display {
font-size: 24px;
font-weight: bold;
color: var(--primary);
min-height: 30px;
padding: 10px 15px;
border: 2px solid var(--mid);
border-radius: 8px;
background-color: white;
flex-grow: 1;
text-align: center;
}

.listen-speaker {
cursor: pointer;
color: var(--secondary);
font-size: 28px;
padding: 8px;
border-radius: 50%;
background-color: rgba(248, 181, 0, 0.1);
transition: all 0.2s ease;
}

.listen-speaker:hover {
background-color: rgba(248, 181, 0, 0.2);
transform: scale(1.1);
}

.timer-feedback-section {
margin-bottom: 25px;
min-height: 40px;
display: flex;
align-items: center;
justify-content: center;
}

.timer-feedback {
font-size: 20px;
font-weight: bold;
text-align: center;
}

.choices-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 12px;
margin-bottom: 25px;
max-width: 100%;
}

.choice-button {
padding: 15px 10px;
border: 2px solid var(--mid);
border-radius: 8px;
background-color: white;
color: var(--dark);
font-size: 16px;
font-weight: 500;
cursor: pointer;
transition: all 0.2s ease;
min-height: 60px;
display: flex;
align-items: center;
justify-content: center;
text-align: center;
line-height: 1.3;
}

.choice-button:hover {
background-color: var(--accent1);
color: white;
border-color: var(--accent1);
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.choice-button.correct {
background-color: var(--accent2);
color: white;
border-color: var(--accent2);
}

.choice-button.incorrect {
background-color: var(--primary);
color: white;
border-color: var(--primary);
}

.choice-button:disabled {
cursor: not-allowed;
opacity: 0.7;
}

.listen-controls {
display: flex;
justify-content: center;
gap: 15px;
}

.listen-next-btn {
background-color: var(--accent2);
color: white;
padding: 12px 24px;
font-size: 18px;
}

.listen-close-btn {
background-color: var(--mid);
color: white;
padding: 12px 24px;
font-size: 18px;
}

.date-info {
position: absolute;
top: 20px;
right: 20px;
text-align: right;
font-size: 14px;
line-height: 1.6;
color: var(--dark);
background-color: rgba(255, 255, 255, 0.9);
padding: 10px 15px;
border-radius: 8px;
box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
display: flex;
flex-direction: column;
gap: 5px;
font-weight: bold;
max-width: 90%;
z-index: 10;
}

.date-info span {
display: flex;
align-items: center;
white-space: nowrap;
}

.date-info .emoji {
margin-right: 8px;
font-size: 16px;
}

.date-info .countdown {
color: var(--primary);
margin: 0 3px;
}

.footer {
            margin-top: 40px;
            text-align: center;
            padding: 15px;
            color: var(--dark);
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

#footer {
            font-weight: bold;
        }

.popup-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.7);
display: flex;
justify-content: center;
align-items: center;
z-index: 1000;
}

.popup-content {
background-color: white;
padding: 25px;
border-radius: 15px;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
width: 90%;
max-width: 500px;
text-align: center;
}

.popup-layout {
display: flex;
align-items: center;
margin-bottom: 20px;
}

.mascot-image {
width: 150px;
flex-shrink: 0;
}

.mascot-image img {
width: 100%;
height: auto;
}

.speech-bubble {
position: relative;
background-color: #FFFDE7;
border: 2px solid var(--secondary);
border-radius: 15px;
padding: 15px;
margin-left: 15px;
}

.speech-bubble:before {
content: "";
position: absolute;
left: -15px;
top: 50%;
transform: translateY(-50%);
border-width: 15px 15px 15px 0;
border-style: solid;
border-color: transparent var(--secondary) transparent transparent;
}

.speech-bubble:after {
content: "";
position: absolute;
left: -12px;
top: 50%;
transform: translateY(-50%);
border-width: 12px 12px 12px 0;
border-style: solid;
border-color: transparent #FFFDE7 transparent transparent;
}

.japanese-text {
font-size: 18px;
font-weight: bold;
color: var(--primary);
margin-bottom: 8px;
}

.english-text {
font-size: 16px;
color: var(--dark);
}

.close-reminder-btn {
background-color: var(--accent1);
color: white;
padding: 12px 24px;
font-size: 18px;
border: none;
border-radius: 8px;
cursor: pointer;
transition: all 0.2s ease;
}

.close-reminder-btn:hover {
background-color: var(--primary);
transform: translateY(-2px);
box-shadow: 0 5px 8px rgba(0, 0, 0, 0.15);
}

@media (max-width: 768px) {
.date-info {
position: static;
margin: 0 auto 15px auto;
width: 100%;
max-width: 100%;
text-align: center;
right: auto;
top: auto;
}

.date-info span {
justify-content: center;
}

header {
display: flex;
flex-direction: column;
}
}

@media (max-width: 600px) {
.button-group {
flex-direction: column;
}

button {
width: 100%;
}

th, td {
padding: 8px 10px;
}

.controls {
flex-direction: column;
gap: 15px;
align-items: stretch;
}

.left-controls {
justify-content: space-between;
width: 100%;
}

.right-controls {
justify-content: space-between;
width: 100%;
}

.choices-grid {
gap: 10px;
}

.choice-button {
padding: 12px 8px;
font-size: 14px;
min-height: 50px;
}

.listen-answer-display {
font-size: 20px;
}

.listen-speaker {
font-size: 24px;
}

.timer-feedback {
font-size: 18px;
}

.mode-option {
padding: 10px;
}

.preset-buttons {
grid-template-columns: 1fr;
}

.ai-support-links {
grid-template-columns: 1fr;
}

#listen-choose-modal .modal-content {
width: 98%;
padding: 10px;
}

.popup-layout {
flex-direction: column;
}

.speech-bubble {
margin-left: 0;
margin-top: 15px;
}

.speech-bubble:before, .speech-bubble:after {
left: 50%;
top: -15px;
transform: translateX(-50%) rotate(90deg);
}

.speech-bubble:after {
top: -12px;
}

/* Add these new styles */
.button-set-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.toggle-icon {
    cursor: pointer;
    font-size: 20px;
    padding: 5px;
    user-select: none;
    transition: transform 0.3s ease;
}

.toggle-icon:hover {
    transform: scale(1.1);
}

.button-set-content {
    display: none;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 8px;
    margin-bottom: 10px;
}

.button-set-content.visible {
    display: grid;
}

.custom-list-item {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
}

.custom-list-item .preset-btn {
    flex: 1;
    margin: 0;
}

.custom-list-item .delete-custom-btn {
    flex: 0 0 50px;
    background-color: var(--light);
    border: 1px solid var(--mid);
    color: var(--dark);
    font-size: 16px;
    padding: 8px;
    margin: 0;
}

#custom-buttons-container .preset-btn {
    background-color: var(--accent1);
    color: white;
}

.no-custom-lists {
    color: var(--mid);
    font-size: 14px;
    text-align: center;
    margin: 10px 0;
    font-style: italic;
}

@media (max-width: 600px) {
   .custom-list-item .preset-btn {
        font-size: 12px;  /* Adjust text size */
        padding: 8px 12px;  /* Adjust button padding */
font-weight: bold;
    }

    .custom-list-item .edit-custom-btn {
        font-size: 12px;  /* Adjust text size */
        padding: 8px 6px;  /* Adjust button padding */
background-color: var(--light);  /* Change color if desired */
    }
}

</style>
</head>
<body>
<header>
<div id="date-info" class="date-info"></div>
<h1>🎌 言葉の達人／語彙力アップ (2.1)</h1>
<p class="subtitle">N5-N4 → N3 準備中</p>
<div class="tts-system-selector">
<label for="tts-system">音声システム: </label>
<select id="tts-system">
<option value="android" selected>Android</option>
<option value="ios">iOS</option>
</select>
</div>
</header>

<div class="controls">
<div class="left-controls">
<button class="text-import-btn" id="text-import-btn">📝 語彙を読み込む</button>
</div>
<button class="japanese-to-english-btn" id="japanese-to-english-btn" disabled>👀 見る→意味</button>
<button class="listen-choose-btn" id="listen-choose-btn" disabled>🎧 聴く→選ぶ</button>
<button class="start-btn" id="start-btn" disabled>🎤 話す</button>
<button class="ai-support-btn" id="ai-support-btn">💡 人工知能</button>
</div>

<div class="quiz-mode-selector">
<div class="mode-options">
<label class="mode-option">
<input type="radio" name="quiz-mode" value="sequential" checked>
<span class="option-text">➡️ 順番に</span>
</label>
<label class="mode-option">
<input type="radio" name="quiz-mode" value="random">
<span class="option-text">🔀 ランダムに</span>
</label>
</div>
</div>

<table id="vocabulary-table">
<thead>
<tr>
<th>
<div class="tts-speed-control">
<label for="tts-speed">単語/フレーズ</label>
<select id="tts-speed">
<option value="0.6">0.6x</option>
<option value="0.8" selected>0.8x</option>
<option value="1">1x</option>
</select>
</div>
</th>
<th>英訳/意味</th>
<th>
<label>
<input type="checkbox" id="select-all"> すべて選択
</label>
</th>
</tr>
</thead>
<tbody id="vocabulary-body">
<tr>
<td colspan="3" class="no-data">語彙を読み込んでください</td>
</tr>
</tbody>
</table>

<!-- Text Import Modal -->
<div id="text-import-modal" class="modal">
<div class="modal-content">
<h2>語彙を読み込む</h2>

<div class="preset-buttons">
    <div class="button-set textbook-buttons">
        <div class="button-set-header">
            <h3>📘 基本の単語</h3>
            <span class="toggle-icon" data-toggle="n5-buttons">▼</span>
        </div>
        <div class="button-set-content" id="n5-buttons">
            <button class="preset-btn textbook-btn" data-preset="n5_1">動詞(一)</button>
            <button class="preset-btn textbook-btn" data-preset="n5_2">N5 Set 2</button>
            <button class="preset-btn textbook-btn" data-preset="n5_3">N5 Set 3</button>
        </div>
    </div>
    
    <div class="button-set jlpt-buttons">
        <div class="button-set-header">
            <h3>📗 シーン別の単語</h3>
            <span class="toggle-icon" data-toggle="n4-buttons">▼</span>
        </div>
        <div class="button-set-content" id="n4-buttons">
            <button class="preset-btn jlpt-btn" data-preset="n4_1">N4 Set 1</button>
            <button class="preset-btn jlpt-btn" data-preset="n4_2">朝</button>
            <button class="preset-btn jlpt-btn" data-preset="n4_3">寝る前</button>
        </div>
    </div>
    
    <div class="button-set core-buttons">
        <div class="button-set-header">
            <h3>📙 テーマ別の単語</h3>
            <span class="toggle-icon" data-toggle="n3-buttons">▼</span>
        </div>
        <div class="button-set-content" id="n3-buttons">
            <button class="preset-btn core-btn" data-preset="n3_1">N3 Set 1</button>
            <button class="preset-btn core-btn" data-preset="n3_2">N3 Set 2</button>
            <button class="preset-btn core-btn" data-preset="n3_3">N3 Set 3</button>
        </div>
    </div>
    
    <div class="button-set other-buttons">
        <div class="button-set-header">
            <h3>🌟 完璧な体験</h3>
            <span class="toggle-icon" data-toggle="perfect-buttons">▼</span>
        </div>
        <div class="button-set-content" id="perfect-buttons">
            <button class="preset-btn other-btn" data-preset="perfect1">運動</button>
            <button class="preset-btn other-btn" data-preset="perfect2">資格を取る</button>
        </div>
    </div>
    
    <div class="button-set custom-buttons" id="custom-buttons-section">
        <div class="button-set-header">
            <h3>📜 Custom Lists</h3>
            <span class="toggle-icon" data-toggle="custom-buttons-content">▼</span>
        </div>
        <div class="button-set-content" id="custom-buttons-content">
            <div id="custom-buttons-container"></div>
        </div>
    </div>
</div>

<textarea id="text-import-content" placeholder="日本語 = 英語/意味 の形式で入力してください..."></textarea>
<div class="button-group">
<button id="text-import-submit-btn" class="submit-btn">📂 読み込む</button>
<button id="text-import-memory-btn" class="memory-btn">📌 記憶 (きおく 0)</button>
<button id="text-import-clear-btn" class="hint-btn">🈳 消す</button>
<button id="text-import-close-btn" class="close-btn">閉じる</button>
</div>
</div>
</div>

<!-- AI Support Modal -->
<div id="ai-support-modal" class="modal">
<div class="modal-content">
<h2>💡 AI Support</h2>
<div class="ai-support-links">
<a href="https://www.japandict.com/" class="ai-support-link" target="_blank">🔍 辞書: JapanDict</a>
<a href="https://chatgpt.com/share/68e91bb2-c7f0-800f-b3ed-61aac70c3c16" class="ai-support-link" target="_blank">✏️ 英訳と例文を作る</a>
<a href="https://chatgpt.com/share/68e285e1-b0c8-800f-90b4-9a90408dd2b4" class="ai-support-link" target="_blank">🌟 英訳と例文と定義と穴埋めを作成する</a>
<a href="https://chatgpt.com" class="ai-support-link" target="_blank">[未完成] 💬 日本語で会話する</a>
<a href="https://chatgpt.com/share/68e91d2f-752c-800f-ad17-7eb2e8cfb89f" class="ai-support-link" target="_blank">📚 文法を学ぶ</a>
</div>
<div class="button-group">
<button id="ai-support-close-btn" class="close-btn">Close</button>
</div>
</div>
</div>

<!-- Japanese to English Quiz Modal -->
<div id="japanese-to-english-modal" class="modal">
<div class="modal-content">
<div id="japanese-progress-info" class="progress-info" style="display: none;">
<span id="japanese-progress-text"></span>
</div>
<div class="prompt">この日本語はどういう意味ですか？</div>
<div style="font-size: 28px; font-weight: bold; color: var(--primary); margin: 20px 0; display: flex; align-items: center; justify-content: center; gap: 15px;">
<span id="japanese-word-display"></span>
<span class="speaker-icon" id="japanese-word-speaker" title="Listen" style="cursor: pointer; color: var(--secondary); font-size: 24px;">🔊</span>
</div>
<div id="english-answer-display" class="reveal-answer" style="display: none; font-size: 23px;"></div>
<div id="check-question" style="display: none; font-size: 23px; color: var(--accent1); margin-top: 10px;"><b>正解しましたか？</b></div>
<div style="margin-top: 30px;">
<button id="check-answer-btn" class="submit-btn" style="width: 100%; margin-bottom: 15px; padding: 15px;">答えを見る</button>
<div class="button-group">
<button id="japanese-next-btn" class="next-btn">次へ</button>
<button id="japanese-close-btn" class="close-btn">閉じる</button>
</div>
</div>
</div>
</div>

<!-- Listen and Choose Modal -->
<div id="listen-choose-modal" class="modal">
<div class="modal-content">
<h2>🎧 聴いて選ぶ</h2>
<div class="listen-answer-section">
<div id="listen-answer-display" class="listen-answer-display">スピーカーをクリック</div>
<div class="listen-speaker" id="listen-speaker" title="Play Audio">🔊</div>
</div>
<div class="timer-feedback-section">
<div id="timer-feedback" class="timer-feedback"></div>
</div>
<div id="choices-grid" class="choices-grid"></div>
<div class="listen-controls">
<button id="listen-next-btn" class="listen-next-btn">次へ</button>
<button id="listen-close-btn" class="listen-close-btn">閉じる</button>
</div>
</div>
</div>

<!-- Quiz Modal -->
<div id="quiz-modal" class="modal">
<div class="modal-content">
<div class="prompt">「<span id="translation-prompt" style="color: var(--primary);"></span>」を日本語で言ってください。</div>
<input type="text" id="answer-input" class="answer-input" placeholder="ここに答えを入力してください...">
<div id="feedback" class="feedback"></div>
<div id="hint-text" class="hint"></div>
<div id="reveal-answer" class="reveal-answer" style="font-size: 23px;"></div>
<div class="button-group">
<button id="submit-btn" class="submit-btn">✅ or ❎</button>
<button id="speak-btn" class="speak-btn">🎤 音声入力</button>
<button id="hint-btn" class="hint-btn">❓ ヒント</button>
<button id="answer-btn" class="answer-btn">🔑 答え</button>
<button id="next-btn" class="next-btn">次へ</button>
<button id="close-btn" class="close-btn">閉じる</button>
</div>
</div>
</div>

<!-- Refresh Reminder Popup -->
<div id="refresh-reminder-popup" class="popup-container">
<div class="popup-content">
<div class="popup-layout">
<div class="mascot-image">
<div style="width: 150px; height: 150px; background: linear-gradient(45deg, #FF6B6B, #4ECDC4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 60px;">🎌</div>
</div>
<div class="speech-bubble">
<p class="japanese-text">1. 毎回使用する前に「リフレッシュ(refresh)🔄」をクリックして更新を取得してください！</p>
<p class="english-text">2. iPhoneとiPadユーザーは、システムをiOSに切り替えると🔊が正常に動作します。</p>
<p class="english-text">3. 携帯電話は時々「テキスト読み上げ」機能を更新することがあり、その結果🔊が動作しなくなることがあります。再起動すれば解決します。</p>
</div>
</div>
<button id="close-reminder-btn" class="close-reminder-btn">わかりました</button>
</div>
</div>

<!-- Edit Custom List Modal -->
<div id="edit-custom-modal" class="modal">
<div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
<h2>📝 カスタムリストを編集</h2>
<textarea id="edit-custom-content" style="width: 100%; height: 400px; padding: 12px; margin: 15px 0; font-size: 16px; border: 2px solid var(--mid); border-radius: 6px; box-sizing: border-box; resize: vertical; font-family: 'Hiragino Sans', 'Meiryo', 'MS Gothic', sans-serif;"></textarea>
<div class="button-group">
<button id="edit-custom-save-btn" class="next-btn">🆗 保存 (ほぞん 0)</button>
<button id="edit-custom-abort-btn" class="close-btn">🚫 中止 (ちゅうし 0)</button>
<button id="edit-custom-delete-btn" class="hint-btn" style="background-color: var(--primary); color: white;">🗑️ 削除 (さくじょ 1)</button>
</div>
</div>
</div>

 <footer class="footer">
        <div id="footer">🎌 言葉の達人／語彙力アップ へようこそ！</div>
    </footer>

<script>
// ===== DOM ELEMENTS =====
const japaneseToEnglishBtn = document.getElementById('japanese-to-english-btn');
const japaneseToEnglishModal = document.getElementById('japanese-to-english-modal');
const japaneseWordDisplay = document.getElementById('japanese-word-display');
const japaneseWordSpeaker = document.getElementById('japanese-word-speaker');
const englishAnswerDisplay = document.getElementById('english-answer-display');
const checkQuestion = document.getElementById('check-question');
const checkAnswerBtn = document.getElementById('check-answer-btn');
const japaneseNextBtn = document.getElementById('japanese-next-btn');
const japaneseCloseBtn = document.getElementById('japanese-close-btn');
const japaneseProgressInfo = document.getElementById('japanese-progress-info');
const japaneseProgressText = document.getElementById('japanese-progress-text');
const listenChooseBtn = document.getElementById('listen-choose-btn');
const listenChooseModal = document.getElementById('listen-choose-modal');
const listenAnswerDisplay = document.getElementById('listen-answer-display');
const listenSpeaker = document.getElementById('listen-speaker');
const timerFeedback = document.getElementById('timer-feedback');
const choicesGrid = document.getElementById('choices-grid');
const listenNextBtn = document.getElementById('listen-next-btn');
const listenCloseBtn = document.getElementById('listen-close-btn');
const textImportBtn = document.getElementById('text-import-btn');
const startBtn = document.getElementById('start-btn');
const aiSupportBtn = document.getElementById('ai-support-btn');
const vocabularyTable = document.getElementById('vocabulary-table');
const vocabularyBody = document.getElementById('vocabulary-body');
const selectAllCheckbox = document.getElementById('select-all');
const quizModal = document.getElementById('quiz-modal');
const translationPrompt = document.getElementById('translation-prompt');
const answerInput = document.getElementById('answer-input');
const feedbackEl = document.getElementById('feedback');
const hintTextEl = document.getElementById('hint-text');
const revealAnswerEl = document.getElementById('reveal-answer');
const submitBtn = document.getElementById('submit-btn');
const speakBtn = document.getElementById('speak-btn');
const hintBtn = document.getElementById('hint-btn');
const answerBtn = document.getElementById('answer-btn');
const nextBtn = document.getElementById('next-btn');
const closeBtn = document.getElementById('close-btn');
const ttsSpeedSelect = document.getElementById('tts-speed');
const ttsSystemSelect = document.getElementById('tts-system');
const textImportModal = document.getElementById('text-import-modal');
const textImportContent = document.getElementById('text-import-content');
const textImportSubmitBtn = document.getElementById('text-import-submit-btn');
const textImportCloseBtn = document.getElementById('text-import-close-btn');
const textImportClearBtn = document.getElementById('text-import-clear-btn');
const textImportMemoryBtn = document.getElementById('text-import-memory-btn');
const customButtonsContainer = document.getElementById('custom-buttons-container');
const aiSupportModal = document.getElementById('ai-support-modal');
const aiSupportCloseBtn = document.getElementById('ai-support-close-btn');
const editCustomModal = document.getElementById('edit-custom-modal');
const editCustomContent = document.getElementById('edit-custom-content');
const editCustomSaveBtn = document.getElementById('edit-custom-save-btn');
const editCustomAbortBtn = document.getElementById('edit-custom-abort-btn');
const editCustomDeleteBtn = document.getElementById('edit-custom-delete-btn');

// ===== VARIABLES =====
let isSpeaking = false;
let vocabularyData = [];
let currentQuizWords = [];
let currentWordIndex = -1;
let currentWord = null;
let recognition = null;
let speechRate = 0.8;
let quizMode = 'sequential';
let currentJapaneseQuizWords = [];
let currentJapaneseWordIndex = -1;
let currentJapaneseWord = null;
let sectionProgress = {};
let sectionOrder = [];
let currentListenQuizWords = [];
let currentListenWordIndex = -1;
let currentListenWord = null;
let questionStartTime = null;
let isAnswered = false;
let voices = [];
let voicesLoaded = false;
let currentTTSSystem = 'android';
let db = null;
let currentEditingListId = null;

// ===== INDEXEDDB FUNCTIONS =====
function initIndexedDB() {
return new Promise((resolve, reject) => {
const request = indexedDB.open('VocabBuilderDB', 1);

request.onerror = () => {
console.error('IndexedDB error:', request.error);
reject(request.error);
};

request.onsuccess = () => {
db = request.result;
console.log('IndexedDB initialized successfully');
resolve(db);
};

request.onupgradeneeded = (event) => {
db = event.target.result;
if (!db.objectStoreNames.contains('customLists')) {
const objectStore = db.createObjectStore('customLists', { keyPath: 'id', autoIncrement: true });
objectStore.createIndex('name', 'name', { unique: true });
objectStore.createIndex('timestamp', 'timestamp', { unique: false });
}
console.log('IndexedDB object store created');
};
});
}

function saveCustomList(name, content) {
return new Promise((resolve, reject) => {
if (!db) {
reject('Database not initialized');
return;
}

const transaction = db.transaction(['customLists'], 'readwrite');
const objectStore = transaction.objectStore('customLists');

const data = {
name: name,
content: content,
timestamp: Date.now()
};

const request = objectStore.add(data);

request.onsuccess = () => {
console.log('Custom list saved:', name);
resolve(request.result);
};

request.onerror = () => {
console.error('Error saving custom list:', request.error);
reject(request.error);
};
});
}

function getAllCustomLists() {
return new Promise((resolve, reject) => {
if (!db) {
reject('Database not initialized');
return;
}

const transaction = db.transaction(['customLists'], 'readonly');
const objectStore = transaction.objectStore('customLists');
const request = objectStore.getAll();

request.onsuccess = () => {
resolve(request.result);
};

request.onerror = () => {
reject(request.error);
};
});
}

function deleteCustomList(id) {
return new Promise((resolve, reject) => {
if (!db) {
reject('Database not initialized');
return;
}

const transaction = db.transaction(['customLists'], 'readwrite');
const objectStore = transaction.objectStore('customLists');
const request = objectStore.delete(id);

request.onsuccess = () => {
console.log('Custom list deleted:', id);
resolve();
};

request.onerror = () => {
reject(request.error);
};
});
}

function updateCustomList(id, content) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject('Database not initialized');
            return;
        }

        const transaction = db.transaction(['customLists'], 'readwrite');
        const objectStore = transaction.objectStore('customLists');
        const getRequest = objectStore.get(id);

        getRequest.onsuccess = () => {
            const data = getRequest.result;
            if (data) {
                data.content = content;
                data.timestamp = Date.now();
                const updateRequest = objectStore.put(data);

                updateRequest.onsuccess = () => {
                    console.log('Custom list updated:', id);
                    resolve();
                };

                updateRequest.onerror = () => {
                    reject(updateRequest.error);
                };
            } else {
                reject('List not found');
            }
        };

        getRequest.onerror = () => {
            reject(getRequest.error);
        };
    });
}

async function renderCustomButtons() {
    try {
        const customLists = await getAllCustomLists();
        customButtonsContainer.innerHTML = '';

        if (customLists.length === 0) {
            customButtonsContainer.innerHTML = '<p class="no-custom-lists">カスタムリストはまだありません</p>';
            return;
        }

        customLists.forEach(list => {
            const container = document.createElement('div');
            container.className = 'custom-list-item';

            const button = document.createElement('button');
            button.className = 'preset-btn';
            button.textContent = list.name;
            button.addEventListener('click', () => {
                processTextImport(list.content);
                textImportModal.style.display = 'none';

                const successMessage = document.createElement('div');
                successMessage.style.cssText = `
                    position: fixed; top: 20px; right: 20px; background-color: var(--accent2);
                    color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold;
                    z-index: 1000; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                `;
                successMessage.textContent = `✅ ${list.name} 読み込み完了！`;
                document.body.appendChild(successMessage);

                setTimeout(() => {
                    if (document.body.contains(successMessage)) {
                        document.body.removeChild(successMessage);
                    }
                }, 3000);
            });

            const editBtn = document.createElement('button');
            editBtn.className = 'edit-custom-btn';
            editBtn.textContent = '✏️ 編集';
            editBtn.title = '編集';
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openEditModal(list.id, list.name, list.content);
            });

            container.appendChild(button);
            container.appendChild(editBtn);
            customButtonsContainer.appendChild(container);
        });
    } catch (error) {
        console.error('Error rendering custom buttons:', error);
        customButtonsContainer.innerHTML = '<p style="color: var(--primary);">エラーが発生しました</p>';
    }
}

function openEditModal(id, name, content) {
    currentEditingListId = id;
    editCustomContent.value = content;
    textImportModal.style.display = 'none';
    editCustomModal.style.display = 'flex';
}

editCustomSaveBtn.addEventListener('click', async () => {
    if (!currentEditingListId) return;

    const newContent = editCustomContent.value.trim();
    if (!newContent) {
        alert('内容が空です。');
        return;
    }

    try {
        await updateCustomList(currentEditingListId, newContent);
        await renderCustomButtons();

        editCustomModal.style.display = 'none';
        textImportModal.style.display = 'flex';
        currentEditingListId = null;
        editCustomContent.value = '';

        const successMessage = document.createElement('div');
        successMessage.style.cssText = `
            position: fixed; top: 20px; right: 20px; background-color: var(--accent2);
            color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold;
            z-index: 1000; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        `;
        successMessage.textContent = '💾 保存完了！';
        document.body.appendChild(successMessage);

        setTimeout(() => {
            if (document.body.contains(successMessage)) {
                document.body.removeChild(successMessage);
            }
        }, 2000);
    } catch (error) {
        console.error('Error updating custom list:', error);
        alert('保存に失敗しました。');
    }
});

editCustomAbortBtn.addEventListener('click', () => {
    editCustomModal.style.display = 'none';
    textImportModal.style.display = 'flex';
    currentEditingListId = null;
    editCustomContent.value = '';
});

editCustomDeleteBtn.addEventListener('click', async () => {
    if (!currentEditingListId) return;

    if (confirm('このカスタムリストを削除しますか？')) {
        try {
            await deleteCustomList(currentEditingListId);
            await renderCustomButtons();

            editCustomModal.style.display = 'none';
            textImportModal.style.display = 'flex';
            currentEditingListId = null;
            editCustomContent.value = '';

            const deleteMessage = document.createElement('div');
            deleteMessage.style.cssText = `
                position: fixed; top: 20px; right: 20px; background-color: var(--primary);
                color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold;
                z-index: 1000; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            `;
            deleteMessage.textContent = '🗑️ 削除完了';
            document.body.appendChild(deleteMessage);

            setTimeout(() => {
                if (document.body.contains(deleteMessage)) {
                    document.body.removeChild(deleteMessage);
                }
            }, 2000);
        } catch (error) {
            console.error('Error deleting custom list:', error);
            alert('削除に失敗しました。');
        }
    }
});

// ===== TTS FUNCTIONS =====
function loadVoices() {
return new Promise((resolve) => {
voices = speechSynthesis.getVoices();
if (voices.length > 0) {
voicesLoaded = true;
console.log('Voices loaded:', voices.length);
resolve(voices);
} else {
const utterance = new SpeechSynthesisUtterance('');
utterance.volume = 0;
speechSynthesis.speak(utterance);
setTimeout(() => {
voices = speechSynthesis.getVoices();
voicesLoaded = true;
console.log('Voices loaded after trigger:', voices.length);
resolve(voices);
}, 100);
}
});
}

function getJapaneseVoice() {
if (!voicesLoaded || voices.length === 0) return null;

if (currentTTSSystem === 'ios') {
const iosJapaneseVoices = ['Kyoko', 'Otoya'];
for (const voiceName of iosJapaneseVoices) {
const voice = voices.find(v => v.name.includes(voiceName));
if (voice) {
console.log('Using iOS Japanese voice:', voice.name);
return voice;
}
}
} else {
const androidJapaneseVoices = [
'Google 日本語',
'Japanese (Japan)',
'ja-JP-language',
'Japanese Japan'
];
for (const voiceName of androidJapaneseVoices) {
const voice = voices.find(v =>
v.name.includes(voiceName) ||
v.name.toLowerCase().includes(voiceName.toLowerCase())
);
if (voice) {
console.log('Using Android Japanese voice:', voice.name);
return voice;
}
}
}

const japaneseVoice = voices.find(v =>
v.lang === 'ja-JP' ||
v.lang.startsWith('ja-') ||
v.name.toLowerCase().includes('japanese') ||
v.name.toLowerCase().includes('japan')
);

if (japaneseVoice) {
console.log(`Using fallback Japanese voice for ${currentTTSSystem}:`, japaneseVoice.name);
return japaneseVoice;
}

console.log(`Using first available voice for ${currentTTSSystem}:`, voices[0]?.name);
return voices[0] || null;
}

function speak(text) {
console.log('Speak function called with:', text, 'System:', currentTTSSystem);
if (!('speechSynthesis' in window)) {
console.warn('Speech synthesis not supported');
return;
}

const cleanText = text.replace(/[()[\]\\*]/g, '').trim();
if (!cleanText) return;

speechSynthesis.cancel();

setTimeout(() => {
const utterance = new SpeechSynthesisUtterance(cleanText);
const preferredVoice = getJapaneseVoice();

if (preferredVoice) {
utterance.voice = preferredVoice;
}

utterance.lang = 'ja-JP';
utterance.pitch = 1.0;
utterance.volume = 1.0;

if (currentTTSSystem === 'ios') {
utterance.rate = Math.max(0.5, speechRate * 0.9);
} else {
utterance.rate = speechRate;
}

utterance.onstart = function() {
console.log('Speech started successfully');
};

utterance.onend = function() {
console.log('Speech ended normally');
isSpeaking = false;
};

utterance.onerror = function(event) {
console.error('Speech error:', event.error);
isSpeaking = false;
};

try {
speechSynthesis.speak(utterance);
} catch (error) {
console.error('Failed to start speech synthesis:', error);
}
}, 100);
}

async function initializeTTS() {
console.log('Initializing TTS...');
const testUtterance = new SpeechSynthesisUtterance('');
testUtterance.volume = 0;
speechSynthesis.speak(testUtterance);

await new Promise(resolve => setTimeout(resolve, 200));
await loadVoices();

if (voices.length === 0) {
console.log('No voices found, trying again...');
await new Promise(resolve => setTimeout(resolve, 500));
await loadVoices();
}

console.log('TTS initialization complete. Voices:', voices.length);

speechSynthesis.addEventListener('voiceschanged', () => {
console.log('Voices changed event fired');
loadVoices();
});
}

// ===== SPEECH RECOGNITION =====
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'ja-JP';
recognition.continuous = false;
recognition.interimResults = false;

recognition.onresult = function(event) {
const transcript = event.results[0][0].transcript.trim();
answerInput.value = transcript;
speakBtn.textContent = '🎤 音声入力';
speakBtn.classList.remove('recording');
};

recognition.onend = function() {
speakBtn.textContent = '🎤 音声入力';
speakBtn.classList.remove('recording');
};

recognition.onerror = function(event) {
console.error('Speech recognition error', event.error);
speakBtn.textContent = '🎤 音声入力';
speakBtn.classList.remove('recording');
};
}

// ===== EVENT LISTENERS =====
ttsSpeedSelect.addEventListener('change', (e) => {
speechRate = parseFloat(e.target.value);
});

ttsSystemSelect.addEventListener('change', (e) => {
currentTTSSystem = e.target.value;
console.log(`Switched to ${currentTTSSystem} TTS system`);
loadVoices().then(() => {
console.log(`Voice loading complete for ${currentTTSSystem}`);
});
});

document.addEventListener('change', (e) => {
if (e.target.name === 'quiz-mode') {
quizMode = e.target.value;
console.log(`Quiz mode changed to: ${quizMode}`);
}
});

aiSupportBtn.addEventListener('click', () => {
aiSupportModal.style.display = 'flex';
});

aiSupportCloseBtn.addEventListener('click', () => {
aiSupportModal.style.display = 'none';
});

textImportBtn.addEventListener('click', () => {
textImportModal.style.display = 'flex';
});

textImportCloseBtn.addEventListener('click', () => {
textImportModal.style.display = 'none';
});

// ===== PRESET VOCABULARY DATA =====
const presetVocabulary = {
n5_1: `
◎単語とフレーズ
本を買う (hon o kau) = to buy a book
バスが来る (basu ga kuru) = the bus comes
友達に会う (tomodachi ni au) = to meet a friend
私に会いに来る (watashi ni ai ni kuru) = to come to see me
水を飲む (mizu o nomu) = to drink water
朝ご飯を食べる (asagohan o taberu) = to eat breakfast
食べすぎる (tabesugiru) = to eat too much
旅行に行く (ryokō ni iku) = to go on a trip
知る (shiru) = to know; to find out
あなたの名前を知っている (anata no namae o shitte iru) = to know your name
韓国料理が好き (kankoku ryōri ga suki) = like Korean food
この靴が一番好き (kono kutsu ga ichiban suki) = like these shoes the best
一人で住む (hitori de sumu) = to live alone
東京に住んでいる (tōkyō ni sunde iru) = to live in Tokyo
晩ご飯を作る (bangohan o tsukuru) = to make dinner
そのチームと試合をする (sono chīmu to shiai o suru) = to have a match with that team
新聞を読む (shinbun o yomu) = to read a newspaper
富士山が見える (fujisan ga mieru) = can see Mt. Fuji
日本語を話す (nihongo o hanasu) = to speak Japanese
お金が欲しい (okane ga hoshii) = want money
テレビを見る (terebi o miru) = to watch TV

◎例文
本を買いました。= I bought a book.
バスが来ました。= The bus came.
友達に会いました。= I met a friend.
私に会いに来てくれました。= They came to see me.
水を飲みました。= I drank some water.
朝ご飯を食べました。= I ate breakfast.
昨日食べすぎました。= I ate too much yesterday.
来月旅行に行きます。= I’ll go on a trip next month.
先生の名前を知りません。= I don’t know the teacher’s name.
あなたの名前を知っています。= I know your name.
韓国料理が好きです。= I like Korean food.
この靴が一番好きです。= I like these shoes the best.
一人で住んでいます。= I live alone.
東京に住んでいます。= I live in Tokyo.
晩ご飯を作ります。= I’ll make dinner.
そのチームと試合をします。= We’ll have a match with that team.
新聞を読みます。= I read the newspaper.
窓から富士山が見えます。= You can see Mt. Fuji from the window.
日本語を話します。= I speak Japanese.
お金が欲しいです。= I want money.
毎晩テレビを見ます。= I watch TV every night.

`,
n5_2: `

`,
n5_3: `

`,
n4_1: `

`,
n4_2: `
◎単語とフレーズ
目覚まし時計が鳴る (mezamashi dokei ga naru) = the alarm clock rings
ベッドから出る (beddo kara deru) = to get out of bed
起きる (okiru) = to get up; to wake up
カーテンを開ける (kāten o akeru) = to open the curtains
トイレに行く (toire ni iku) = to go to the bathroom
髪をとかす (kami o tokasu) = to comb one’s hair
歯を磨く (ha o migaku) = to brush one’s teeth
顔を洗う (kao o arau) = to wash one’s face
化粧をする (keshō o suru) = to put on makeup
眼鏡をかける (megane o kakeru) = to put on glasses
服を着る (fuku o kiru) = to put on clothes
傘を持って行く (kasa o motte iku) = to take an umbrella
朝ご飯を食べる (asagohan o taberu) = to eat breakfast
朝食を抜く (chōshoku o nuku) = to skip breakfast
弁当を作る (bentō o tsukuru) = to make a bento (lunch box)
新聞を読む (shinbun o yomu) = to read the newspaper
散歩をする (sanpo o suru) = to take a walk
公園で犬の散歩をする (kōen de inu no sanpo o suru) = to walk the dog in the park

◎例文
目覚まし時計が鳴りました。= The alarm clock rang.
ベッドから出ました。= I got out of bed.
毎朝7時に起きます。= I get up at 7 every morning.
カーテンを開けて、外を見ました。= I opened the curtains and looked outside.
トイレに行きました。= I went to the bathroom.
髪をとかしました。= I combed my hair.
歯を磨きました。= I brushed my teeth.
顔を洗いました。= I washed my face.
出かける前に化粧をします。= I put on makeup before going out.
眼鏡をかけました。= I put on my glasses.
服を着ました。= I got dressed.
傘を持って行きました。= I took an umbrella.
朝ご飯を食べました。= I ate breakfast.
今日は朝食を抜きました。= I skipped breakfast today.
弁当を作りました。= I made a bento.
新聞を読みました。= I read the newspaper.
朝、公園で散歩をします。= I take a walk in the park in the morning.
公園で犬の散歩をしました。= I walked my dog in the park.

`,
n4_3: `
◎単語とフレーズ
風呂に入る (furo ni hairu) = to take a bath
シャワーを浴びる (shawā o abiru) = to take a shower
服を着替える (fuku o kigaeru) = to change clothes
少しの間休憩を取る (sukoshi no aida kyūkei o toru) = to take a short break
ストレスを軽減する (sutoresu o keigen suru) = to reduce stress
日記をつける (nikki o tsukeru) = to keep a diary
自分の考えを書き留める (jibun no kangae o kakitomeru) = to write down one’s thoughts
テレビ番組を見る (terebi bangumi o miru) = to watch a TV program
明かりを消す (akari o kesu) = to turn off the light
音をたてる (oto o tateru) = to make a sound / noise
元気を回復する (genki o kaifuku suru) = to recover energy / feel refreshed
ソファーでくつろぐ (sofā de kutsurogu) = to relax on the sofa
友達とおしゃべりする (tomodachi to oshaberi suru) = to chat with friends
目覚まし時計をセットする (mezamashi dokei o setto suru) = to set the alarm clock
深呼吸する (shinkokyū suru) = to take a deep breath
穏やかな夢を見る (odayaka na yume o miru) = to have a peaceful dream

◎例文
毎晩風呂に入ります。= I take a bath every night.
朝シャワーを浴びます。= I take a shower in the morning.
服を着替えました。= I changed my clothes.
少しの間休憩を取りました。= I took a short break.
運動してストレスを軽減します。= I reduce stress by exercising.
毎日夜に日記をつけます。= I write in my diary every night.
自分の考えを書き留めました。= I wrote down my thoughts.
テレビ番組を見ています。= I’m watching a TV program.
寝る前に明かりを消します。= I turn off the light before going to bed.
静かにして、音をたてないでください。= Be quiet and don’t make noise.
休んで元気を回復しました。= I rested and recovered my energy.
ソファーでくつろぎました。= I relaxed on the sofa.
友達とおしゃべりしました。= I chatted with my friends.
目覚まし時計をセットしました。= I set the alarm clock.
ゆっくり深呼吸してください。= Please take a deep breath.
穏やかな夢を見ました。= I had a peaceful dream.


`,
n3_1: `

`,
n3_2: `

`,
n3_3: `

`,
perfect1: `
◎ステップ１：文脈から意味を推測しよう（👀 🎧 🎤用）
週末に友達と試合を見るのが楽しみです。= I look forward to watching a game with my friends on the weekend.
野菜を食べることは健康にいいです。= Eating vegetables is good for your health.
音楽を聴くとストレス解消になります。= Listening to music helps relieve stress.
サイクリングは自然の中で楽しめます。= You can enjoy cycling in nature.
休みに山登りをしました。= I went mountain climbing on my day off.
暑い日に走ると汗をかきます。= When you run on a hot day, you sweat.
練習すればするほど上手になります。= The more you practice, the better you get.
思いっきり笑うと気分がよくなります。= Laughing with all your energy makes you feel better.
彼はうれしくて大声で叫びました。= He was so happy that he shouted loudly.
感動して号泣しました。= I was so moved that I cried hard.
このアプリでどんなことができるか?= What can you do with this app?
学校で卓球の大会があります。= There’s a ping-pong tournament at school.
自転車で湖を巡る旅をしました。= I took a trip cycling around lakes.
朝の風がとても気持ちいいです。= The morning breeze feels so nice.
最近、写真を撮ることにはまっています。= Lately, I’m hooked on taking photos.
自転車がパンクしてしまいました。= My bicycle got a flat tire.
エアーポンプでタイヤに空気を入れました。= I pumped air into the tire with an air pump.
夜の道ではライトをつけましょう。= Turn on your light when riding at night.
自転車にはワイヤー錠を使っています。= I use a wire lock for my bike.
彼はゲームに熱中しています。= He’s absorbed in video games.
肥満の人は健康に注意が必要です。= Overweight people need to be careful about their health.
彼は汗をかきやすいようです。= He seems to sweat easily.
私は汗をかきにくい方です。= I’m the type who doesn’t sweat much.
この質問は少し答えにくいです。= This question is a little hard to answer.
この本はとても読みやすいです。= This book is very easy to read.
この説明は理解しやすいです。= This explanation is easy to understand.
毎日ジムに通っています。= I go to the gym every day.
健康のために筋トレをしています。= I do strength training for my health.
ヨガプログラムに参加しました。= I joined a yoga program.
夏は水泳をするのが好きです。= I like swimming in summer.
ダイエットのために運動しています。= I exercise to lose weight.
彼は格闘技が得意です。= He’s good at martial arts.
野球試合の生中継を見ました。= I watched a live broadcast of a baseball game.

---

◎ステップ２：語彙に注目しよう（👀 🎧 🎤用）
試合を見る (shiai o miru) = to watch a game
健康にいい (kenkō ni ii) = good for health
ストレス解消 (sutoresu kaishō) = stress relief
サイクリング (saikuringu) = cycling
山登り (yama-nobori) = mountain climbing
汗をかく (ase o kaku) = to sweat
~ほど (~ hodo) = the more (you do something), the more...
思いっきり (omoikkiri) = with all one’s might; fully
叫ぶ (sakebu) = to shout
号泣する (gōkyū suru) = to cry hard
どんな~ができるか? (donna ~ ga dekiru ka?) = what kind of ~ can you do?
卓球 (takkyū) = table tennis, ping-pong
湖を巡る (mizuumi o meguru) = to go around lakes
気持ちいい (kimochi ii) = feels good
~にはまる (~ ni hamaru) = to be hooked on
パンク (panku) = flat tire
エアーポンプ (eā ponpu) = air pump
ライト (raito) = light
ワイヤー錠 (waiyā jō) = wire lock
~に熱中する (~ ni necchū suru) = to be absorbed in
肥満の人 (himan no hito) = overweight person
汗をかきやすいようだ (ase o kaki yasui yō da) = seems to sweat easily
汗をかきにくい方だ (ase o kaki nikui hō da) = tends not to sweat much
答えにくい (kotae nikui) = hard to answer
読みやすい (yomi yasui) = easy to read
理解しやすい (rikai shi yasui) = easy to understand
ジムに通う (jimu ni kayou) = to go to the gym
筋トレする (kintore suru) = to do strength training
ヨガプログラムに参加する (yoga puroguramu ni sanka suru) = to join a yoga program
水泳 (suiei) = swimming
ダイエット (daietto) = diet
格闘技 (kakutōgi) = martial arts
野球試合の生中継 (yakyū shiai no namachūkei) = live baseball broadcast

---

◎ステップ３：日本語の定義（👀 🎧用）
スポーツの試合を観ること = 試合を見る
体にいいこと = 健康にいい
ストレスをなくすこと = ストレス解消
自転車で出かける活動 = サイクリング
山に登ること = 山登り
体から汗が出ること = 汗をかく
〜すればするだけ、〜になること = ~ほど
力いっぱい、思いのままに = 思いっきり
大きな声で言うこと = 叫ぶ
大声でたくさん泣くこと = 号泣する
どんなことができるのかたずねる表現 = どんな~ができるか?
ピンポンのこと = 卓球
湖のまわりを回ること = 湖を巡る
気分がよく感じること = 気持ちいい
何かに強く興味を持つこと = ~にはまる
タイヤの空気が抜けること = パンク
空気を入れる道具 = エアーポンプ
明るくするための器具 = ライト
自転車を守るための鍵 = ワイヤー錠
何かに夢中になること = ~に熱中する
太っている人 = 肥満の人
汗をかきやすそうに見えること = 汗をかきやすいようだ
汗をかきにくいタイプであること = 汗をかきにくい方だ
答えるのがむずかしいこと = 答えにくい
読みやすくわかりやすいこと = 読みやすい
理解するのが簡単なこと = 理解しやすい
運動施設に行くこと = ジムに通う
筋肉を強くする運動をすること = 筋トレする
ヨガの活動に参加すること = ヨガプログラムに参加する
泳ぐこと = 水泳
やせるための努力 = ダイエット
戦うスポーツの総称 = 格闘技
野球の試合を生で放送すること = 野球試合の生中継

---

◎ステップ４：穴埋めクイズ（🎤用）
試合を見る = 日曜日に友だちとサッカーの_____予定です。
健康にいい = 野菜を食べることはとても_____です。
ストレス解消 = 音楽を聴くと_____になります。
サイクリング = 休日に友だちと_____に行きました。
山登り = 夏休みに家族で_____をしました。
汗をかく = 暑い日は少し歩くだけで_____。
~ほど = 練習する_____、上手になります。
思いっきり = 子どもたちは公園で_____遊びました。
叫ぶ = 彼はうれしくて大声で_____ました。
号泣する = 映画を見て感動して_____人もいました。
どんな~ができるか? = このアプリで_____知っていますか?
卓球 = 学校のクラブで_____をしています。
湖を巡る = 旅行で自転車に乗って_____コースを走りました。
気持ちいい = 朝の空気がとても_____です。
~にはまる = 最近、彼は写真撮影_____ようです。
パンク = 自転車が_____して困りました。
エアーポンプ = タイヤの空気を入れるために_____を使いました。
ライト = 夜は自転車の_____をつけましょう。
ワイヤー錠 = 自転車を守るために_____をかけました。
~に熱中する = 彼はオンラインゲーム_____学生です。
肥満の人 = 運動不足は_____に多い問題です。
汗をかきやすいようだ = 彼は少し動くだけで_____ね。
汗をかきにくい方だ = 私は人より_____と思います。
答えにくい = その質問は少し_____です。
読みやすい = この本はやさしくてとても_____です。
理解しやすい = 先生の説明はとても_____です。
ジムに通う = 健康のために毎日_____ことにしました。
筋トレする = 彼は筋肉を強くするために_____ています。
ヨガプログラムに参加する = 週末に_____予定です。
水泳 = 夏になると_____を楽しむ人が増えます。
ダイエット = 健康的な_____をしたいです。
格闘技 = 兄は子どものころから_____を習っています。
野球試合の生中継 = テレビで_____を見ました。

 `,
perfect2: `
◎ステップ１：文脈から意味を推測しよう（👀 🎧 🎤用）
将来のために資格を取ることにしました。= I decided to get a qualification for my future.
大学では奨学金をもらって勉強しました。= I studied at university with a scholarship.
彼は毎日一生懸命勉強しています。= He studies very hard every day.
検定試験に落ちて少し落ち込みました。= I failed the proficiency test and felt a bit down.
彼は万年不合格で有名です。= He’s known for always failing the exam.
この仕事には特別な資格が必要です。= This job requires a special qualification.
彼女は英語の資格を持っています。= She has an English qualification.
それで、次はどうしたいですか?= So, what do you want to do next?
資格を取ると賃上げになることもあります。= Getting a qualification can sometimes lead to a pay raise.
来週のイベントに申し込みました。= I applied for next week’s event.
ネットで申し込めるのは便利ですね。= It’s convenient that you can apply online.
彼は試験に受かったらしいです。= It seems he passed the exam.
今日は疲れて勉強できない。= I’m too tired to study today.
彼女は毎日塾に通っています。= She goes to cram school every day.
時間がなくても何とかなると思う。= Even without much time, I think it’ll work out somehow.
授業中綺麗なノートを取るのが好きです。= I like taking neat notes during class.
先生の話を聞きながらメモを取りました。= I took notes while listening to the teacher.
友だちに参考書を貸しました。= I lent a reference book to my friend.
試験前に過去問を解きました。= I solved past exam questions before the test.
彼はひたすら問題を解いています。= He’s solving problems tirelessly.
今から行くのは無理です。= It’s impossible to go now.
彼女は常に上を目指しています。= She’s always aiming higher.
あと少しで合格できます。= I can pass if I just push a little more.
これまでずっと頑張ってきたね。= You’ve really worked hard until now.

---

◎ステップ２：語彙に注目しよう（👀 🎧 🎤用）
資格を取る (shikaku o toru) = to get a qualification
奨学金 (shōgakukin) = scholarship
一生懸命勉強する (isshōkenmei benkyō suru) = to study hard
検定試験に落ちる (kentei shiken ni ochiru) = to fail a certification exam
万年不合格 (mannen fugōkaku) = perpetual failure
仕事に必要な資格 (shigoto ni hitsuyō na shikaku) = qualification needed for a job
資格を持っている (shikaku o motte iru) = to have a qualification
それで、 (sorede) = so; and then
賃上げになる (chin’age ni naru) = to result in a pay raise
申し込む (mōshikomu) = to apply
ネットで申し込める (netto de mōshikomeru) = to apply online
~らしい (~ rashii) = it seems; apparently
勉強できない (benkyō dekinai) = can’t study
塾に通う (juku ni kayou) = to go to cram school
~何とかなる (~ nantoka naru) = it’ll work out somehow
授業中綺麗なノートを取る (jugyō-chū kirei na nōto o toru) = to take neat notes during class
メモを取る (memo o toru) = to take notes
貸す (kasu) = to lend
過去問を解く (kakomon o toku) = to solve past exam questions
ひたすら (hitasura) = earnestly; single-mindedly
無理 (muri) = impossible
上を目指す (ue o mezasu) = to aim higher
あと少し (ato sukoshi) = a little more
頑張ってきた (ganbatte kita) = have worked hard

---

◎ステップ３：日本語の定義（👀 🎧用）
特別な力を認められるための証をもらうこと = 資格を取る
学校で使えるお金をもらうこと = 奨学金
とても熱心に勉強すること = 一生懸命勉強する
テストで合格しないこと = 検定試験に落ちる
いつも試験に合格できない人 = 万年不合格
仕事をするために必要な証明 = 仕事に必要な資格
資格を持っていること = 資格を持っている
話をつなげるときに使う言葉 = それで、
給料が上がること = 賃上げになる
イベントや試験に申し込むこと = 申し込む
インターネットで申し込みできること = ネットで申し込める
聞いた話ではそうだと思うときに使う = ~らしい
何かの理由で勉強ができないこと = 勉強できない
先生に教えてもらうために塾に行くこと = 塾に通う
心配でもなんとかできると思う気持ち = ~何とかなる
授業できれいにノートを書くこと = 授業中綺麗なノートを取る
大事なことを短く書くこと = メモを取る
自分の物を人に使わせること = 貸す
昔の試験問題を解くこと = 過去問を解く
一つのことをずっと続けるようす = ひたすら
できないこと、無理なこと = 無理
もっと上のレベルを目指すこと = 上を目指す
あと少しで終わる、できること = あと少し
今までずっと努力してきたこと = 頑張ってきた

---

◎ステップ４：穴埋めクイズ（🎤用）
資格を取る = 彼は将来のために_____ことにしました。
奨学金 = 大学で_____をもらって勉強しています。
一生懸命勉強する = 毎日_____学生です。
検定試験に落ちる = 今年もまた_____しまいました。
万年不合格 = 彼は_____の記録を更新中です。
仕事に必要な資格 = この会社では_____が求められます。
資格を持っている = 彼女は英語の_____そうです。
それで、 = 今日は忙しかったですね。____、どうしますか?
賃上げになる = この資格を取ると_____こともあります。
申し込む = 明日のセミナーに_____予定です。
ネットで申し込める = このイベントは_____から便利です。
~らしい = 彼は来年海外に行くらしいです。
勉強できない = 疲れていて今日は_____。
塾に通う = 子どもは毎日_____ています。
~何とかなる = 難しいけど、努力すれば_____と思う。
授業中綺麗なノートを取る = 彼女はいつも_____タイプです。
メモを取る = 話を聞きながら大事なところを_____ました。
貸す = 明日までノートを_____よ。
過去問を解く = 試験前に_____のが大事です。
ひたすら = 彼は_____勉強を続けています。
無理 = 今からやるのは_____だと思う。
上を目指す = 彼は常に_____姿勢を持っています。
あと少し = 合格まで_____です。
頑張ってきた = あなたは今まで本当に_____ね。

 `
};

function isContentEmpty(content) {
const cleaned = content.replace(/\s+/g, '').replace(/[◎=]/g, '');
return cleaned.length === 0;
}

function showNoContentMessage() {
const messageOverlay = document.createElement('div');
messageOverlay.style.cssText = `
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background-color: rgba(0, 0, 0, 0.8); display: flex;
justify-content: center; align-items: center; z-index: 1000;
`;

const messageBox = document.createElement('div');
messageBox.style.cssText = `
background-color: white; padding: 30px; border-radius: 15px;
text-align: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
max-width: 400px; margin: 0 20px;
`;

messageBox.innerHTML = `
<h3 style="color: var(--primary); margin-bottom: 15px;">⚠️ コンテンツがありません</h3>
<p style="font-size: 18px; margin-bottom: 10px;">更新をお待ちください</p>
<p style="font-size: 16px; color: var(--mid); margin-bottom: 20px;">Please wait for updates</p>
<button id="close-no-content-msg" style="
background-color: var(--accent1); color: white; padding: 10px 20px;
border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">OK</button>
`;

messageOverlay.appendChild(messageBox);
document.body.appendChild(messageOverlay);

document.getElementById('close-no-content-msg').addEventListener('click', () => {
document.body.removeChild(messageOverlay);
});

messageOverlay.addEventListener('click', (e) => {
if (e.target === messageOverlay) {
document.body.removeChild(messageOverlay);
}
});
}

document.querySelectorAll('.preset-btn').forEach(button => {
button.addEventListener('click', () => {
const presetKey = button.dataset.preset;
if (presetVocabulary[presetKey]) {
const content = presetVocabulary[presetKey];
if (isContentEmpty(content)) {
showNoContentMessage();
return;
}
processTextImport(content);
textImportModal.style.display = 'none';

const successMessage = document.createElement('div');
successMessage.style.cssText = `
position: fixed; top: 20px; right: 20px; background-color: var(--accent2);
color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold;
z-index: 1000; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
`;
successMessage.textContent = `✅ ${button.textContent} 読み込み完了！`;
document.body.appendChild(successMessage);

setTimeout(() => {
if (document.body.contains(successMessage)) {
document.body.removeChild(successMessage);
}
}, 3000);
}
});
});

textImportSubmitBtn.addEventListener('click', () => {
const text = textImportContent.value.trim();
if (!text) {
alert('レッスンを選ぶか、「日本語 = English」の形式で入力してください。');
return;
}
processTextImport(text);
textImportModal.style.display = 'none';
});

textImportClearBtn.addEventListener('click', () => {
textImportContent.value = '';
});

textImportMemoryBtn.addEventListener('click', async () => {
const content = textImportContent.value.trim();
if (!content) {
alert('記憶する内容がありません。');
return;
}

const namePrompt = prompt('このカスタムリストの名前を入力してください：');
if (!namePrompt) {
return;
}

const name = namePrompt.trim();
if (!name) {
alert('名前を入力してください。');
return;
}

try {
await saveCustomList(name, content);
await renderCustomButtons();

const successMessage = document.createElement('div');
successMessage.style.cssText = `
position: fixed; top: 20px; right: 20px; background-color: var(--accent2);
color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold;
z-index: 1000; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
`;
successMessage.textContent = `📌 ${name} 記憶完了！`;
document.body.appendChild(successMessage);

setTimeout(() => {
if (document.body.contains(successMessage)) {
document.body.removeChild(successMessage);
}
}, 3000);

textImportContent.value = '';
} catch (error) {
console.error('Error saving custom list:', error);
if (error.name === 'ConstraintError') {
alert('この名前は既に使用されています。別の名前を選んでください。');
} else {
alert('保存に失敗しました。もう一度お試しください。');
}
}
});

// ===== TEXT IMPORT AND TABLE RENDERING =====
function processTextImport(text) {
vocabularyData = [];
sectionOrder = [];
const lines = text.split('\n');
let currentSection = "Default";

for (let i = 0; i < lines.length; i++) {
const line = lines[i].trim();
if (!line) continue;

if (line.includes('◎') || line.includes('@') || line.startsWith('※')) {
currentSection = line.replace('◎', '').replace('@', '').replace('※', '').trim();
if (!sectionOrder.includes(currentSection)) {
sectionOrder.push(currentSection);
}
continue;
}

const parts = line.split('=');
if (parts.length < 2) continue;

const vocabulary = parts[0].trim();
const translation = parts[1].trim();

if (vocabulary && translation) {
vocabularyData.push({
vocabulary: vocabulary,
translation: translation,
selected: false,
section: currentSection
});
}
}

renderVocabularyTable();

if (vocabularyData.length > 0) {
startBtn.disabled = false;
japaneseToEnglishBtn.disabled = false;
listenChooseBtn.disabled = false;
}
}

function toggleSection(sectionName) {
const sectionRows = document.querySelectorAll(`.section-row[data-section="${sectionName}"]`);
const collapseBtn = document.querySelector(`[data-section-toggle="${sectionName}"]`);

if (!collapseBtn) return;

const isCollapsed = collapseBtn.textContent === '🔽';

if (isCollapsed) {
sectionRows.forEach(row => row.style.display = 'table-row');
collapseBtn.textContent = '🔼';
collapseBtn.title = 'Collapse (収起)';
} else {
sectionRows.forEach(row => row.style.display = 'none');
collapseBtn.textContent = '🔽';
collapseBtn.title = 'Expand (展開)';
}
}

function renderVocabularyTable() {
if (vocabularyData.length === 0) {
vocabularyBody.innerHTML = '<tr><td colspan="3" class="no-data">語彙リストを読み込んでください</td></tr>';
return;
}

vocabularyBody.innerHTML = '';

const sectionMap = {};
vocabularyData.forEach(item => {
if (!sectionMap[item.section]) {
sectionMap[item.section] = [];
}
sectionMap[item.section].push(item);
});

Object.keys(sectionMap).forEach(sectionName => {
const sectionItems = sectionMap[sectionName];

const sectionRow = document.createElement('tr');
sectionRow.className = 'section-header';

const sectionCell = document.createElement('td');
sectionCell.colSpan = 2;

const sectionTitle = document.createElement('div');
sectionTitle.className = 'section-title';

const collapseBtn = document.createElement('button');
collapseBtn.className = 'collapse-btn';
collapseBtn.textContent = '🔼';
collapseBtn.title = 'Collapse (収起)';
collapseBtn.setAttribute('data-section-toggle', sectionName);
collapseBtn.addEventListener('click', () => toggleSection(sectionName));

const titleText = document.createElement('span');
titleText.textContent = sectionName;

sectionTitle.appendChild(collapseBtn);
sectionTitle.appendChild(titleText);
sectionCell.appendChild(sectionTitle);

const sectionCheckCell = document.createElement('td');
const sectionCheckbox = document.createElement('input');
sectionCheckbox.type = 'checkbox';
sectionCheckbox.checked = sectionItems.every(item => item.selected);
sectionCheckbox.dataset.section = sectionName;

sectionCheckbox.addEventListener('change', (e) => {
const isChecked = e.target.checked;
const section = e.target.dataset.section;

vocabularyData.forEach((item, index) => {
if (item.section === section) {
item.selected = isChecked;
const checkbox = document.querySelector(`input[data-index="${index}"]`);
if (checkbox) checkbox.checked = isChecked;
}
});

updateSelectAllCheckbox();
});

sectionCheckCell.appendChild(sectionCheckbox);
sectionRow.appendChild(sectionCell);
sectionRow.appendChild(sectionCheckCell);
vocabularyBody.appendChild(sectionRow);

sectionItems.forEach((item, localIndex) => {
const index = vocabularyData.findIndex(vItem =>
vItem.vocabulary === item.vocabulary &&
vItem.translation === item.translation);

const row = document.createElement('tr');
row.className = 'section-row';
row.setAttribute('data-section', sectionName);

const wordCell = document.createElement('td');
const cleanWord = item.vocabulary.replace(/\(.*\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();
wordCell.innerHTML = `
${item.vocabulary}
<span class="speaker-icon" title="Listen" data-word="${cleanWord}">🔊</span>
`;

const translationCell = document.createElement('td');
translationCell.textContent = item.translation;

const checkboxCell = document.createElement('td');
const checkbox = document.createElement('input');
checkbox.type = 'checkbox';
checkbox.checked = item.selected;
checkbox.dataset.index = index;
checkbox.dataset.section = item.section;

checkbox.addEventListener('change', (e) => {
vocabularyData[index].selected = e.target.checked;
updateSectionCheckbox(item.section);
updateSelectAllCheckbox();
});

checkboxCell.appendChild(checkbox);
row.appendChild(wordCell);
row.appendChild(translationCell);
row.appendChild(checkboxCell);
vocabularyBody.appendChild(row);
});
});

document.querySelectorAll('.speaker-icon').forEach(icon => {
icon.addEventListener('click', (e) => {
const word = e.target.dataset.word;
speak(word);
});
});

updateSelectAllCheckbox();
}

function updateSectionCheckbox(sectionName) {
const sectionItems = vocabularyData.filter(item => item.section === sectionName);
const allSelected = sectionItems.every(item => item.selected);
const noneSelected = sectionItems.every(item => !item.selected);

const sectionCheckbox = document.querySelector(`input[data-section="${sectionName}"]`);
if (sectionCheckbox) {
sectionCheckbox.checked = allSelected;
sectionCheckbox.indeterminate = !allSelected && !noneSelected;
}
}

function updateSelectAllCheckbox() {
if (vocabularyData.length === 0) {
selectAllCheckbox.checked = false;
selectAllCheckbox.indeterminate = false;
return;
}

const selectedCount = vocabularyData.filter(item => item.selected).length;

if (selectedCount === 0) {
selectAllCheckbox.checked = false;
selectAllCheckbox.indeterminate = false;
} else if (selectedCount === vocabularyData.length) {
selectAllCheckbox.checked = true;
selectAllCheckbox.indeterminate = false;
} else {
selectAllCheckbox.checked = false;
selectAllCheckbox.indeterminate = true;
}
}

selectAllCheckbox.addEventListener('change', (e) => {
const isChecked = e.target.checked;

vocabularyData.forEach(item => {
item.selected = isChecked;
});

document.querySelectorAll('#vocabulary-body input[type="checkbox"]').forEach(checkbox => {
checkbox.checked = isChecked;
if (checkbox.dataset.section) {
checkbox.indeterminate = false;
}
});
});

// ===== PROGRESS TRACKING =====
function initializeSectionProgress() {
sectionProgress = {};
const sectionMap = {};

vocabularyData.forEach(item => {
if (!sectionMap[item.section]) {
sectionMap[item.section] = [];
}
sectionMap[item.section].push(item);
});

Object.keys(sectionMap).forEach(sectionName => {
const sectionItems = sectionMap[sectionName].filter(item => item.selected);
if (sectionItems.length > 0) {
sectionProgress[sectionName] = {
currentIndex: -1,
totalCount: sectionItems.length,
items: sectionItems
};
}
});
}

function getCurrentProgressInfo() {
if (quizMode !== 'sequential' || !currentJapaneseWord) {
return null;
}

const currentSection = currentJapaneseWord.section;

if (!sectionProgress[currentSection]) {
return null;
}

const progress = sectionProgress[currentSection];
const currentPosition = progress.currentIndex + 1;
const totalInSection = progress.totalCount;

return {
current: currentPosition,
total: totalInSection,
section: currentSection
};
}

function updateProgressDisplay() {
if (quizMode !== 'sequential') {
japaneseProgressInfo.style.display = 'none';
return;
}

const progressInfo = getCurrentProgressInfo();

if (!progressInfo) {
japaneseProgressInfo.style.display = 'none';
return;
}

japaneseProgressText.textContent = `${progressInfo.current} / ${progressInfo.total} (${progressInfo.section})`;
japaneseProgressInfo.style.display = 'block';
}

// ===== LISTEN AND CHOOSE QUIZ =====
function startListenAndChooseQuiz() {
currentListenQuizWords = vocabularyData.filter(item => item.selected);

if (currentListenQuizWords.length === 0) {
alert('最低1つの単語/フレーズを選んでください。');
return;
}

if (currentListenQuizWords.length < 8) {
alert('このクイズには最低8つの単語/フレーズが必要です。');
return;
}

resetListenAndChooseQuiz();
listenChooseModal.style.display = 'flex';
nextListenQuestion();
}

function resetListenAndChooseQuiz() {
currentListenWordIndex = -1;
currentListenWord = null;
questionStartTime = null;
isAnswered = false;
listenAnswerDisplay.textContent = 'スピーカーをクリック';
timerFeedback.textContent = '';
}

function nextListenQuestion() {
isAnswered = false;
questionStartTime = null;
listenAnswerDisplay.textContent = 'スピーカーをクリック';
timerFeedback.textContent = '';

if (quizMode === 'sequential') {
currentListenWordIndex = (currentListenWordIndex + 1) % currentListenQuizWords.length;
} else {
const previousIndex = currentListenWordIndex;
if (currentListenQuizWords.length === 1) {
currentListenWordIndex = 0;
} else {
do {
currentListenWordIndex = Math.floor(Math.random() * currentListenQuizWords.length);
} while (currentListenWordIndex === previousIndex && currentListenQuizWords.length > 1);
}
}

currentListenWord = currentListenQuizWords[currentListenWordIndex];
generateChoices();
}

function generateChoices() {
if (!currentListenWord) return;

const otherTranslations = currentListenQuizWords
.filter(item => item.translation !== currentListenWord.translation)
.map(item => item.translation);

const shuffled = otherTranslations.sort(() => 0.5 - Math.random());
const selectedChoices = shuffled.slice(0, 7);
const allChoices = [...selectedChoices, currentListenWord.translation];
const finalChoices = allChoices.sort(() => 0.5 - Math.random());

choicesGrid.innerHTML = '';

finalChoices.forEach(choice => {
const button = document.createElement('button');
button.className = 'choice-button';
button.textContent = choice;
button.addEventListener('click', () => handleChoiceClick(button, choice));
choicesGrid.appendChild(button);
});
}

function handleChoiceClick(button, selectedChoice) {
if (isAnswered) return;

isAnswered = true;
const responseTime = questionStartTime ? (Date.now() - questionStartTime) / 1000 : 0;

document.querySelectorAll('.choice-button').forEach(btn => {
btn.disabled = true;
});

const isCorrect = selectedChoice === currentListenWord.translation;

if (isCorrect) {
button.classList.add('correct');
listenAnswerDisplay.textContent = currentListenWord.vocabulary.replace(/\(.*?\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();

let feedbackMessage = '';
if (responseTime < 2) {
feedbackMessage = '完璧！ ⚡';
speak('完璧');
} else if (responseTime < 3.5) {
feedbackMessage = 'いいね！ 👍';
speak('いいね!');
} else if (responseTime < 6) {
feedbackMessage = '早く！ ⏰';
speak('早く!');
} else {
feedbackMessage = '遅いよ！ 😴';
speak('遅いよ！');
}

timerFeedback.textContent = `${feedbackMessage} (${responseTime.toFixed(1)}秒かかりました)`;
timerFeedback.className = 'timer-feedback correct';
} else {
button.classList.add('incorrect');

document.querySelectorAll('.choice-button').forEach(btn => {
if (btn.textContent === currentListenWord.translation) {
btn.classList.add('correct');
}
});

timerFeedback.textContent = 'あ、違うよ！😓❌';
timerFeedback.className = 'timer-feedback incorrect';
speak('あ、違うよ！');
listenAnswerDisplay.textContent = currentListenWord.vocabulary.replace(/\(.*?\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();
}
}

listenChooseBtn.addEventListener('click', startListenAndChooseQuiz);

listenSpeaker.addEventListener('click', () => {
if (currentListenWord && !isAnswered) {
const cleanWord = currentListenWord.vocabulary.replace(/\(.*?\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();
speak(cleanWord);

if (!questionStartTime) {
questionStartTime = Date.now();
}
}
});

listenNextBtn.addEventListener('click', nextListenQuestion);

listenCloseBtn.addEventListener('click', () => {
listenChooseModal.style.display = 'none';
});

// ===== JAPANESE TO ENGLISH QUIZ =====
japaneseToEnglishBtn.addEventListener('click', () => {
currentJapaneseQuizWords = vocabularyData.filter(item => item.selected);

if (currentJapaneseQuizWords.length === 0) {
alert('最低1つの単語/フレーズを選んでクイズを開始してください。');
return;
}

startJapaneseToEnglishQuiz();
});

checkAnswerBtn.addEventListener('click', showEnglishAnswer);
japaneseNextBtn.addEventListener('click', nextJapaneseQuestion);

japaneseCloseBtn.addEventListener('click', () => {
japaneseToEnglishModal.style.display = 'none';
});

japaneseWordSpeaker.addEventListener('click', (e) => {
e.preventDefault();
e.stopPropagation();

if (isSpeaking) {
console.log('Already speaking, ignoring click');
return;
}

if (currentJapaneseWord) {
isSpeaking = true;
const cleanWord = currentJapaneseWord.vocabulary.replace(/\(.*?\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();
console.log('About to speak:', cleanWord);
speak(cleanWord);

setTimeout(() => {
isSpeaking = false;
}, 3000);
}
});

function startJapaneseToEnglishQuiz() {
console.log('Starting Japanese to English quiz');
console.log('Voices loaded:', voicesLoaded, 'Voice count:', voices.length);

if (!voicesLoaded || voices.length === 0) {
console.log('Loading voices before starting quiz...');
loadVoices().then(() => {
console.log('Voices loaded, starting quiz');
resetJapaneseToEnglishQuiz();
japaneseToEnglishModal.style.display = 'flex';
nextJapaneseQuestion();
});
} else {
resetJapaneseToEnglishQuiz();
japaneseToEnglishModal.style.display = 'flex';
nextJapaneseQuestion();
}
}

function resetJapaneseToEnglishQuiz() {
currentJapaneseWordIndex = -1;
currentJapaneseWord = null;
englishAnswerDisplay.style.display = 'none';
checkQuestion.style.display = 'none';
checkAnswerBtn.style.display = 'block';

if (quizMode === 'sequential') {
initializeSectionProgress();
}
}

function nextJapaneseQuestion() {
englishAnswerDisplay.style.display = 'none';
checkQuestion.style.display = 'none';
checkAnswerBtn.style.display = 'block';

if (quizMode === 'sequential') {
if (currentJapaneseWordIndex === -1) {
const firstSection = sectionOrder.find(section =>
sectionProgress[section] && sectionProgress[section].totalCount > 0
);

if (firstSection) {
sectionProgress[firstSection].currentIndex = 0;
currentJapaneseWord = sectionProgress[firstSection].items[0];
currentJapaneseWordIndex = 0;
} else {
currentJapaneseWordIndex = 0;
currentJapaneseWord = currentJapaneseQuizWords[0];
}
} else {
const currentSection = currentJapaneseWord.section;
const sectionData = sectionProgress[currentSection];

if (sectionData && sectionData.currentIndex + 1 < sectionData.totalCount) {
sectionData.currentIndex++;
currentJapaneseWord = sectionData.items[sectionData.currentIndex];
} else {
const currentSectionIndex = sectionOrder.indexOf(currentSection);
let nextSectionIndex = currentSectionIndex + 1;

while (nextSectionIndex < sectionOrder.length) {
const nextSection = sectionOrder[nextSectionIndex];
if (sectionProgress[nextSection] && sectionProgress[nextSection].totalCount > 0) {
sectionProgress[nextSection].currentIndex = 0;
currentJapaneseWord = sectionProgress[nextSection].items[0];
break;
}
nextSectionIndex++;
}

if (nextSectionIndex >= sectionOrder.length) {
const firstSection = sectionOrder.find(section =>
sectionProgress[section] && sectionProgress[section].totalCount > 0
);

if (firstSection) {
sectionProgress[firstSection].currentIndex = 0;
currentJapaneseWord = sectionProgress[firstSection].items[0];
}
}
}

currentJapaneseWordIndex = currentJapaneseQuizWords.findIndex(item =>
item.vocabulary === currentJapaneseWord.vocabulary &&
item.translation === currentJapaneseWord.translation
);
}
} else {
const previousIndex = currentJapaneseWordIndex;

if (currentJapaneseQuizWords.length === 1) {
currentJapaneseWordIndex = 0;
} else {
do {
currentJapaneseWordIndex = Math.floor(Math.random() * currentJapaneseQuizWords.length);
} while (currentJapaneseWordIndex === previousIndex && currentJapaneseQuizWords.length > 1);
}

currentJapaneseWord = currentJapaneseQuizWords[currentJapaneseWordIndex];
}

const cleanWord = currentJapaneseWord.vocabulary.replace(/\(.*?\)/g, '').trim();
japaneseWordDisplay.textContent = cleanWord;

updateProgressDisplay();
}

function showEnglishAnswer() {
if (!currentJapaneseWord) return;

englishAnswerDisplay.textContent = currentJapaneseWord.translation;
englishAnswerDisplay.style.display = 'block';
checkQuestion.style.display = 'block';
checkAnswerBtn.style.display = 'none';
}

// ===== MAIN QUIZ =====
startBtn.addEventListener('click', () => {
currentQuizWords = vocabularyData.filter(item => item.selected);

if (currentQuizWords.length === 0) {
alert('最低1つの単語/フレーズを選んでクイズを開始してください。');
return;
}

startQuiz();
});

function startQuiz() {
resetQuiz();
quizModal.style.display = 'flex';
nextQuestion();
}

function resetQuiz() {
currentWordIndex = -1;
currentWord = null;
answerInput.value = '';
feedbackEl.textContent = '';
feedbackEl.className = 'feedback';
hintTextEl.textContent = '';
revealAnswerEl.textContent = '';
}

function nextQuestion() {
answerInput.value = '';
feedbackEl.textContent = '';
feedbackEl.className = 'feedback';
hintTextEl.textContent = '';
revealAnswerEl.textContent = '';

if (quizMode === 'sequential') {
currentWordIndex = (currentWordIndex + 1) % currentQuizWords.length;
} else {
const previousIndex = currentWordIndex;

if (currentQuizWords.length === 1) {
currentWordIndex = 0;
} else {
do {
currentWordIndex = Math.floor(Math.random() * currentQuizWords.length);
} while (currentWordIndex === previousIndex && currentQuizWords.length > 1);
}
}

currentWord = currentQuizWords[currentWordIndex];
translationPrompt.textContent = currentWord.translation;
}

function submitAnswer() {
if (!currentWord) return;

const userAnswer = answerInput.value.trim();
const correctAnswers = currentWord.vocabulary
.split('/')
.map(ans => ans.replace(/\(.*?\)/g, '').trim());

const normalizedUserAnswer = userAnswer.replace(/[.,?'''...#!？！～、。「」（）…$%^&*;:{}=\-_`~()]/g, "");

const isCorrect = correctAnswers.some(answer => {
const normalizedAnswer = answer.replace(/[.,?'''...#!？！～、。「」（）…$%^&*;:{}=\-_`~()]/g, "");
return normalizedUserAnswer === normalizedAnswer;
});

if (isCorrect) {
feedbackEl.textContent = '正解！🏆😊👍';
feedbackEl.className = 'feedback correct';
speak('正解！');
} else {
feedbackEl.textContent = 'まだまだだね！💥😏🎾';
feedbackEl.className = 'feedback incorrect';
speak('まだまだだね！');
}
}

function showHint() {
if (!currentWord) return;

const correctAnswer = currentWord.vocabulary.replace(/\(.*?\)/g, '').trim();
const firstChar = correctAnswer.charAt(0);

hintTextEl.textContent = `ヒント：「${firstChar}」で始まります`;
}

function showAnswer() {
if (!currentWord) return;

const correctAnswer = currentWord.vocabulary.replace(/\(.*?\)/g, '').replace(/\*/g, '').replace(/\[.*?\]/g, '').trim();
revealAnswerEl.textContent = `${correctAnswer}`;
speak(correctAnswer);
}

submitBtn.addEventListener('click', submitAnswer);

answerInput.addEventListener('keypress', (e) => {
if (e.key === 'Enter') {
submitAnswer();
}
});

speakBtn.addEventListener('click', () => {
if (!recognition) {
alert('音声認識はこのブラウザではサポートされていません。');
return;
}

try {
if (speakBtn.textContent === '🎤 音声入力') {
recognition.start();
speakBtn.textContent = '録音中';
speakBtn.classList.add('recording');
} else {
recognition.stop();
speakBtn.textContent = '🎤 音声入力';
speakBtn.classList.remove('recording');
}
} catch (error) {
console.error('Speech recognition error:', error);
speakBtn.textContent = '🎤 音声入力';
speakBtn.classList.remove('recording');
}
});

hintBtn.addEventListener('click', showHint);
answerBtn.addEventListener('click', showAnswer);
nextBtn.addEventListener('click', nextQuestion);

closeBtn.addEventListener('click', () => {
quizModal.style.display = 'none';
if (recognition) {
recognition.stop();
}
});

// ===== DATE INFORMATION =====
function updateDateInfo() {
const dateInfoEl = document.getElementById('date-info');

const options = {
timeZone: 'Asia/Tokyo',
weekday: 'long',
month: 'long',
day: 'numeric',
year: 'numeric'
};

const today = new Date();
const japanDate = today.toLocaleDateString('ja-JP', options);

const examDate = new Date('July 5, 2026');
examDate.setHours(0, 0, 0, 0);

const todayNoTime = new Date(today);
todayNoTime.setHours(0, 0, 0, 0);

const daysUntilExam = Math.ceil((examDate - todayNoTime) / (1000 * 60 * 60 * 24));

const decExamDate = new Date('December 6, 2026');
decExamDate.setHours(0, 0, 0, 0);

const daysUntilDecExam = Math.ceil((decExamDate - todayNoTime) / (1000 * 60 * 60 * 24));

dateInfoEl.innerHTML = `
<span><span class="emoji">📅</span>${japanDate}</span>
<span><span class="emoji">⏰</span>JLPTまで あと<span class="countdown">${daysUntilExam}</span>日 (毎年7月の第一日曜日)</span>
<span><span class="emoji">📚</span>JLPTまで あと<span class="countdown">${daysUntilDecExam}</span>日 (毎年12月の第一日曜日)</span>
`;
}

updateDateInfo();
setInterval(updateDateInfo, 60000);

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await initIndexedDB();
        await renderCustomButtons();
    } catch (error) {
        console.error('Error initializing IndexedDB:', error);
    }

    initializeTTS();

    // Add toggle functionality for button sets
    document.querySelectorAll('.toggle-icon').forEach(icon => {
        icon.addEventListener('click', function() {
            const targetId = this.getAttribute('data-toggle');
            const targetContent = document.getElementById(targetId);
            
            if (targetContent) {
                targetContent.classList.toggle('visible');
                
                // Change icon direction
                if (targetContent.classList.contains('visible')) {
                    this.textContent = '▲';
                } else {
                    this.textContent = '▼';
                }
            }
        });
    });

    const refreshReminderPopup = document.getElementById('refresh-reminder-popup');

    setTimeout(() => {
        refreshReminderPopup.style.display = 'flex';
    }, 1000);

    const closeReminderBtn = document.getElementById('close-reminder-btn');

    closeReminderBtn.addEventListener('click', () => {
        refreshReminderPopup.style.display = 'none';
    });
});

document.addEventListener('click', function initOnFirstClick() {
initializeTTS();
document.removeEventListener('click', initOnFirstClick);
}, { once: true });
</script>
</body>
</html>
