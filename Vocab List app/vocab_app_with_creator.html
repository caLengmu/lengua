<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive vocabulary learning app with custom lists and AI study partners">
    <meta name="theme-color" content="#3498db">
    <title>Vocabulary Learning App</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="VocabApp">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 2.5em;
        }

        .button-categories {
            margin-bottom: 30px;
        }

        .category {
            margin-bottom: 25px;
        }

        .category-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            display: inline-block;
        }

        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .vocab-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: background-color 0.3s;
            position: relative;
        }

        .vocab-btn:hover {
            background-color: #2980b9;
        }

        .vocab-btn.active {
            background-color: #e74c3c;
        }

        .vocab-btn.custom-list {
            background-color: #9b59b6;
        }

        .vocab-btn.custom-list:hover {
            background-color: #8e44ad;
        }

        .delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .vocab-btn.custom-list:hover .delete-btn {
            display: block;
        }

        .create-list-section {
            margin: 30px 0;
            text-align: center;
            padding: 20px;
            background-color: #e8f4f8;
            border-radius: 8px;
        }

        .create-list-btn {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin-right: 15px;
        }

        .create-list-btn:hover {
            background-color: #8e44ad;
        }

        .speed-control-section {
            margin: 30px 0;
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .speed-label {
            font-weight: bold;
            color: #495057;
            margin-right: 15px;
            font-size: 16px;
        }

        .speed-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .speed-btn:hover {
            background-color: #5a6268;
        }

        .speed-btn.active-speed {
            background-color: #28a745;
        }

        .study-partner-section {
            margin: 30px 0;
            text-align: center;
            padding: 20px;
            background-color: #e8f4f8;
            border-radius: 8px;
        }

        .study-partner-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }

        .study-partner-btn:hover {
            background-color: #218838;
        }

        .vocab-table-container {
            margin-top: 30px;
            overflow-x: auto;
        }

        .vocab-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        .section-header {
            background-color: #ecf0f1;
            font-weight: bold;
            padding: 15px;
            text-align: left;
            font-size: 1.5em;
            color: #2c3e50;
        }

        .vocab-row {
            border-bottom: 1px solid #ddd;
        }

        .audio-controls {
            width: 80px;
            text-align: center;
            padding: 15px 10px;
            vertical-align: top;
        }

        .content-cell {
            padding: 15px;
            vertical-align: top;
        }

        .vocab-word {
            font-weight: bold;
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .example-sentence {
            font-size: 1.5em;
            color: #555;
            line-height: 1.5;
        }

        .audio-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            margin: 2px;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        .audio-btn:hover {
            background-color: #f0f0f0;
        }

        .play-btn {
            color: #27ae60;
        }

        .stop-btn {
            color: #e74c3c;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 5px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        /* Creator Modal Styles */
        .creator-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-input:focus {
            border-color: #3498db;
            outline: none;
        }

        .word-entry {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }

        .word-entry-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .word-number {
            font-weight: bold;
            color: #6c757d;
            margin-right: 10px;
        }

        .remove-word-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
        }

        .remove-word-btn:hover {
            background-color: #c82333;
        }

        .add-word-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .add-word-btn:hover {
            background-color: #218838;
        }

        .save-list-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
        }

        .save-list-btn:hover {
            background-color: #0056b3;
        }

        .partner-selection {
            text-align: center;
        }

        .partner-selection h2 {
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .partners-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .partner-card {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
        }

        .partner-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #e9ecef;
            overflow: hidden;
            margin: 0 auto 15px;
        }

        .partner-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .select-partner-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        .select-partner-btn:hover {
            background-color: #0056b3;
        }

        /* Study Session Styles */
        .study-session {
            text-align: center;
        }

        .partner-display {
            margin-bottom: 30px;
        }

        .partner-avatar {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background-color: #e9ecef;
            overflow: hidden;
            margin: 0 auto 20px;
        }

        .partner-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .speech-bubble {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 20px;
            border-radius: 10px;
            margin: 0 auto 20px;
            max-width: 500px;
        }

        .current-word {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .current-example {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .bubble-controls {
            margin-bottom: 15px;
        }

        .bubble-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            margin: 0 5px;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        .bubble-btn:hover {
            background-color: #f0f0f0;
        }

        .bubble-btn.play-btn {
            color: #27ae60;
        }

        .bubble-btn.stop-btn {
            color: #e74c3c;
        }

        .progress-info {
            margin-bottom: 20px;
            font-size: 17px;
            color: #666;
        }

        .navigation-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 17px;
        }

        .nav-btn:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .nav-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .learn-again-btn {
            background-color: #28a745 !important;
        }

        .learn-again-btn:hover {
            background-color: #218838 !important;
        }

        .congratulations {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .congratulations h3 {
            margin-bottom: 10px;
        }

        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 2em;
            }

            .category-buttons {
                justify-content: center;
            }

            .vocab-btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .audio-controls {
                width: 60px;
                padding: 10px 5px;
            }

            .content-cell {
                padding: 12px;
            }

            .vocab-word {
                font-size: 1.3em;
            }

            .speed-control-section {
                margin: 20px 0;
                padding: 10px;
            }

            .speed-label {
                display: block;
                margin-bottom: 10px;
                margin-right: 0;
            }

            .speed-btn {
                padding: 10px 14px;
                margin: 2px;
                font-size: 13px;
            }

            .partners-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .partner-image {
                width: 60px;
                height: 60px;
            }

            .partner-avatar {
                width: 105px;
                height: 105px;
            }

            .navigation-controls {
                gap: 5px;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 15px;
            }

            .modal-content {
                margin: 10px auto;
                padding: 15px;
                width: 90%;
                max-height: 90vh;
            }

            .speech-bubble {
                padding: 15px;
            }

            .current-word {
                font-size: 20px;
            }

            .current-example {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Install PWA Prompt -->
    <div id="installPrompt" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #3498db; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; max-width: 90%; text-align: center;">
        <p style="margin: 0 0 10px 0; font-weight: bold;">Install Vocabulary App</p>
        <p style="margin: 0 0 15px 0; font-size: 14px;">Add to your home screen for quick access!</p>
        <button id="installBtn" style="background: white; color: #3498db; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 10px;">Install</button>
        <button id="dismissBtn" style="background: transparent; color: white; border: 2px solid white; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">Later</button>
    </div>

    <div class="container">
        <h1>Vocabulary List (2.5)</h1>

        <div class="button-categories">
            <div class="category">
                <div class="category-title">Textbook</div>
                <div class="category-buttons">
                    <button class="vocab-btn" data-category="textbook" data-lesson="B3_L1">B3 L1</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="B3_L2">B3 L2</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="B3_L3">B3 L3</button>
                </div>
            </div>

            <div class="category">
                <div class="category-title">Magazine</div>
                <div class="category-buttons">
                    <button class="vocab-btn" data-category="magazine" data-lesson="U4">U4</button>
                    <button class="vocab-btn" data-category="magazine" data-lesson="U9">U9</button>
                    <button class="vocab-btn" data-category="magazine" data-lesson="U11">U11</button>
                    <button class="vocab-btn" data-category="magazine" data-lesson="U13">U13</button>
                </div>
            </div>

            <div class="category">
                <div class="category-title">核心字彙</div>
                <div class="category-buttons">
                    <button class="vocab-btn" data-category="core" data-lesson="P2U1">P2 U1</button>
                    <button class="vocab-btn" data-category="core" data-lesson="P2U2">P2 U2</button>
                    <button class="vocab-btn" data-category="core" data-lesson="P2U3">P2 U3</button>
                </div>
            </div>

            <div class="category">
                <div class="category-title">My Custom Lists</div>
                <div class="category-buttons" id="customListButtons">
                    <!-- Custom list buttons will be added here -->
                </div>
            </div>
        </div>

        <!-- Create Custom List Section -->
        <div class="create-list-section">
            <button class="create-list-btn" id="createListBtn">
                ➕ Create Your Own Vocabulary List
            </button>
        </div>

        <!-- Speed Control -->
        <div class="speed-control-section">
            <span class="speed-label">Speed:</span>
            <button class="speed-btn" data-speed="1.2">1.2x</button>
            <button class="speed-btn active-speed" data-speed="1.0">1x</button>
            <button class="speed-btn" data-speed="0.8">0.8x</button>
            <button class="speed-btn" data-speed="0.6">0.6x</button>
        </div>

        <!-- Study Partner Section -->
        <div class="study-partner-section">
            <button class="study-partner-btn" id="choosePartnerBtn">
                👬 Choose Your Study Partner (選學伴)
            </button>
        </div>

        <!-- Table -->
        <div class="vocab-table-container">
            <table class="vocab-table" id="vocabTable">
                <tbody id="vocabTableBody">
                    <tr class="no-data">
                        <td colspan="2">Select a lesson to display vocabulary</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Custom List Creator Modal -->
    <div id="creatorModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeCreatorModal">&times;</span>
            <div class="creator-form">
                <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Create Custom Vocabulary List</h2>
                
                <div id="creatorMessages"></div>
                
                <div class="form-group">
                    <label class="form-label" for="listName">List Name:</label>
                    <input type="text" id="listName" class="form-input" placeholder="Enter list name (e.g., My TOEFL Words)">
                </div>

                <div class="form-group">
                    <label class="form-label" for="sectionName">Section Name:</label>
                    <input type="text" id="sectionName" class="form-input" placeholder="Enter section name (e.g., Unit 1, Chapter A)" value="◎Vocabulary List">
                </div>

                <div id="wordsContainer">
                    <!-- Word entries will be added here -->
                </div>

                <button class="add-word-btn" id="addWordBtn">+ Add New Word</button>
                
                <button class="save-list-btn" id="saveListBtn">Save Custom List</button>
            </div>
        </div>
    </div>

    <!-- Partner Selection Modal -->
    <div id="partnerModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closePartnerModal">&times;</span>
            <div class="partner-selection">
                <h2>Choose Your Study Partner</h2>
                <div class="partners-grid">
                    <div class="partner-card">
                        <div class="partner-image">
                            <img src="partner1.jpg" alt="partner 1">
                        </div>
                        <button class="select-partner-btn" data-partner="1">Shawn Mendes</button>
                    </div>
                    <div class="partner-card">
                        <div class="partner-image">
                            <img src="partner2.jpg" alt="partner 2">
                        </div>
                        <button class="select-partner-btn" data-partner="2">Taylor Swift</button>
                    </div>
                    <div class="partner-card">
                        <div class="partner-image">
                            <img src="partner3.jpg" alt="partner 3">
                        </div>
                        <button class="select-partner-btn" data-partner="3">Rosé</button>
                    </div>
                    <div class="partner-card">
                        <div class="partner-image">
                            <img src="partner4.jpg" alt="partner 4">
                        </div>
                        <button class="select-partner-btn" data-partner="4">全圓佑</button>
                    </div>
                    <div class="partner-card">
                        <div class="partner-image">
                            <img src="partner5.jpg" alt="partner 5">
                        </div>
                        <button class="select-partner-btn" data-partner="5">姜太顯</button>
                    </div>
                    <div class="partner-card">
                        <div class="partner-image">
                            <img src="partner6.jpg" alt="partner 6">
                        </div>
                        <button class="select-partner-btn" data-partner="6">IU</button>
                    </div>
                    <div class="partner-card">
                        <div class="partner-image">
                            <img src="partner7.jpg" alt="partner 7">
                        </div>
                        <button class="select-partner-btn" data-partner="7">ASA</button>
                    </div>
                    <div class="partner-card">
                        <div class="partner-image">
                            <img src="partner8.jpg" alt="partner 8">
                        </div>
                        <button class="select-partner-btn" data-partner="8">金城武</button>
                    </div>
                    <div class="partner-card">
                        <div class="partner-image">
                            <img src="partner9.jpg" alt="partner 9">
                        </div>
                        <button class="select-partner-btn" data-partner="9">佐藤健</button>
                    </div>
                    <div class="partner-card">
                        <div class="partner-image">
                            <img src="partner10.jpg" alt="partner 10">
                        </div>
                        <button class="select-partner-btn" data-partner="10">初音ミク</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Study Session Modal -->
    <div id="studyModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeStudyModal">&times;</span>
            <div class="study-session">
                <div class="partner-display">
                    <div class="partner-avatar" id="currentPartnerAvatar">
                        <img src="partner1.jpg" alt="partner 1">
                    </div>
                    <div class="speech-bubble" id="speechBubble">
                        <div class="current-word" id="currentWord">Select a lesson first!</div>
                        <div class="current-example" id="currentExample">Please choose a lesson from the main page before starting your study session.</div>
                        <div class="bubble-controls">
                            <button class="bubble-btn play-btn" id="speakCurrentBtn">🔊</button>
                            <button class="bubble-btn stop-btn" id="stopCurrentBtn">⏹</button>
                        </div>
                    </div>
                </div>
                <div class="progress-info" id="progressInfo">
                    Ready to start!
                </div>
                <div class="navigation-controls" id="navigationControls">
                    <button class="nav-btn" id="backBtn">← Back</button>
                    <button class="nav-btn" id="nextBtn">Next →</button>
                    <button class="nav-btn" id="nextSectionBtn">Next Section</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Built-in database (existing data)
        const vocabDatabase = {
            B3_L2: [],
            'B3_L1': [],
            'B3_L3': [],
            'U4': [],
            'U9': [],
            'U11': [],
            'U13': [],
            'P2U1': [
                {
                    "section": "◎Vocabulary List",
                    "words": [
                        {
                            "word": "dependent (adj) (依賴的)",
                            "example": "He is dependent on his parents for money. (他依賴父母給他錢。)"
                        },
                        {
                            "word": "imagine (v) (想像)",
                            "example": "I can imagine living on the moon one day. (我能想像有一天住在月球上。)"
                        },
                        {
                            "word": "electronics (n) (電子產品)",
                            "example": "My brother loves electronics like phones and tablets. (我哥哥喜歡電子產品，像是手機和平板。)"
                        },
                        {
                            "word": "advanced (adj) (先進的)",
                            "example": "This is an advanced phone with a lot of features. (這是一支功能很多的先進手機。)"
                        },
                        {
                            "word": "commercial (adj) (商業的)",
                            "example": "They are a commercial company that sells clothes. (他們是一家賣衣服的商業公司。)"
                        },
                        {
                            "word": "TV commercial (n) (電視廣告)",
                            "example": "I saw a TV commercial for a new video game. (我看了一個新電玩遊戲的電視廣告。)"
                        },
                        {
                            "word": "technically (adv) (技術上地)",
                            "example": "Technically, a robot is a machine that does work. (技術上來說，機器人是做事的機器。)"
                        },
                        {
                            "word": "assistant (n) (助理)",
                            "example": "My boss has a new assistant to help with work. (我的老闆有一個新助理來幫忙工作。)"
                        },
                        {
                            "word": "device (n) (裝置)",
                            "example": "A smartphone is a useful communication device. (智慧型手機是個有用的通訊裝置。)"
                        },
                        {
                            "word": "imitate (v) (模仿)",
                            "example": "A parrot can imitate human sounds. (鸚鵡可以模仿人類的聲音。)"
                        }
                    ]
                }
            ],
            'P2U2': [],
            'P2U3': []
        };

        // Custom lists storage
        let customLists = {};

        // Partner configurations
        const partners = {
            1: { image: 'partner1.jpg', name: 'Kitty' },
            2: { image: 'partner2.jpg', name: 'Buddy' },
            3: { image: 'partner3.jpg', name: 'Panda' },
            4: { image: 'partner4.jpg', name: 'Foxy' },
            5: { image: 'partner5.jpg', name: 'Froggy' },
            6: { image: 'partner6.jpg', name: 'Sparkle' },
            7: { image: 'partner7.jpg', name: 'Lucky' },
            8: { image: 'partner8.jpg', name: 'Shadow' },
            9: { image: 'partner9.jpg', name: 'Rainbow' },
           10: { image: 'partner10.jpg', name: 'Monkey' }
        };

        // Study session state
        let currentLessonData = null;
        let currentPartner = null;
        let currentWordIndex = 0;
        let flatWordsList = [];
        let currentSpeech = null;
        let speechRate = 1.0;
        let voices = [];
        let isCompleted = false;

        // Custom List Creator Functions
        function loadCustomLists() {
            try {
                const saved = JSON.parse(document.cookie.replace(/(?:(?:^|.*;\s*)customVocabLists\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '{}');
                customLists = saved;
                updateCustomListButtons();
            } catch (e) {
                customLists = {};
            }
        }

        function saveCustomLists() {
            try {
                document.cookie = `customVocabLists=${JSON.stringify(customLists)}; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/`;
            } catch (e) {
                console.error('Failed to save custom lists:', e);
            }
        }

        function updateCustomListButtons() {
            const container = document.getElementById('customListButtons');
            container.innerHTML = '';

            Object.keys(customLists).forEach(listId => {
                const list = customLists[listId];
                const button = document.createElement('button');
                button.className = 'vocab-btn custom-list';
                button.setAttribute('data-category', 'custom');
                button.setAttribute('data-lesson', listId);
                button.innerHTML = `${list.name}<button class="delete-btn" onclick="deleteCustomList('${listId}'); event.stopPropagation();">×</button>`;
                
                button.addEventListener('click', function() {
                    document.querySelectorAll('.vocab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    loadVocabulary(listId);
                });

                container.appendChild(button);
            });
        }

        function deleteCustomList(listId) {
            if (confirm('Are you sure you want to delete this list?')) {
                delete customLists[listId];
                delete vocabDatabase[listId];
                saveCustomLists();
                updateCustomListButtons();
                
                // If this list is currently active, clear the table
                const activeBtn = document.querySelector('.vocab-btn.active');
                if (activeBtn && activeBtn.getAttribute('data-lesson') === listId) {
                    document.getElementById('vocabTableBody').innerHTML = '<tr class="no-data"><td colspan="2">Select a lesson to display vocabulary</td></tr>';
                }
            }
        }

        function showMessage(message, type = 'success') {
            const container = document.getElementById('creatorMessages');
            const div = document.createElement('div');
            div.className = type === 'error' ? 'error-message' : 'success-message';
            div.textContent = message;
            container.innerHTML = '';
            container.appendChild(div);
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        function createWordEntry(word = '', example = '') {
            const wordsContainer = document.getElementById('wordsContainer');
            const wordCount = wordsContainer.children.length + 1;
            
            const wordEntry = document.createElement('div');
            wordEntry.className = 'word-entry';
            wordEntry.innerHTML = `
                <div class="word-entry-header">
                    <span class="word-number">Word ${wordCount}</span>
                    <button type="button" class="remove-word-btn" onclick="removeWordEntry(this)">Remove</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Word/Phrase:</label>
                    <input type="text" class="form-input word-input" placeholder="e.g., advanced (adj) (先進的)" value="${word}">
                </div>
                <div class="form-group">
                    <label class="form-label">Example Sentence:</label>
                    <input type="text" class="form-input example-input" placeholder="e.g., This is an advanced phone with many features." value="${example}">
                </div>
            `;
            
            wordsContainer.appendChild(wordEntry);
            updateWordNumbers();
            return wordEntry;
        }

        function removeWordEntry(button) {
            button.closest('.word-entry').remove();
            updateWordNumbers();
        }

        function updateWordNumbers() {
            const wordEntries = document.querySelectorAll('.word-entry');
            wordEntries.forEach((entry, index) => {
                const numberSpan = entry.querySelector('.word-number');
                numberSpan.textContent = `Word ${index + 1}`;
            });
        }

        function resetCreatorForm() {
            document.getElementById('listName').value = '';
            document.getElementById('sectionName').value = '◎Vocabulary List';
            document.getElementById('wordsContainer').innerHTML = '';
            document.getElementById('creatorMessages').innerHTML = '';
            
            // Add initial word entries
            createWordEntry();
            createWordEntry();
        }

        function validateForm() {
            const listName = document.getElementById('listName').value.trim();
            const sectionName = document.getElementById('sectionName').value.trim();
            
            if (!listName) {
                showMessage('Please enter a list name.', 'error');
                return false;
            }

            if (!sectionName) {
                showMessage('Please enter a section name.', 'error');
                return false;
            }

            const wordEntries = document.querySelectorAll('.word-entry');
            if (wordEntries.length === 0) {
                showMessage('Please add at least one word.', 'error');
                return false;
            }

            let hasValidWord = false;
            wordEntries.forEach(entry => {
                const word = entry.querySelector('.word-input').value.trim();
                const example = entry.querySelector('.example-input').value.trim();
                
                if (word && example) {
                    hasValidWord = true;
                }
            });

            if (!hasValidWord) {
                showMessage('Please fill in at least one complete word entry (both word and example).', 'error');
                return false;
            }

            return true;
        }

        function saveCustomList() {
            if (!validateForm()) return;

            const listName = document.getElementById('listName').value.trim();
            const sectionName = document.getElementById('sectionName').value.trim();
            
            // Generate unique ID
            const listId = 'custom_' + Date.now();

            // Collect words
            const words = [];
            const wordEntries = document.querySelectorAll('.word-entry');
            
            wordEntries.forEach(entry => {
                const word = entry.querySelector('.word-input').value.trim();
                const example = entry.querySelector('.example-input').value.trim();
                
                if (word && example) {
                    words.push({ word, example });
                }
            });

            if (words.length === 0) {
                showMessage('No valid word entries found.', 'error');
                return;
            }

            // Save to custom lists
            customLists[listId] = {
                name: listName,
                created: new Date().toISOString()
            };

            // Save to vocab database
            vocabDatabase[listId] = [{
                section: sectionName,
                words: words
            }];

            saveCustomLists();
            updateCustomListButtons();
            
            showMessage(`Successfully created "${listName}" with ${words.length} words!`);
            
            setTimeout(() => {
                document.getElementById('creatorModal').style.display = 'none';
                resetCreatorForm();
            }, 1500);
        }

        // Load voices
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            if (!voices.length) {
                const dummy = new SpeechSynthesisUtterance('');
                speechSynthesis.speak(dummy);
                voices = speechSynthesis.getVoices();
            }
        }

        // Get English voice
        function getEnglishVoice() {
            if (!voices.length) loadVoices();
            let voice = voices.find(v => v.name.includes('Samantha')) || 
                       voices.find(v => v.lang === 'en-US');
            return voice || null;
        }

        // Clean text for TTS
        function cleanTextForTTS(text) {
            return text.replace(/\*/g, '')
                      .replace(/\//g, '')
                      .replace(/\([^)]*\)/g, '')
                      .replace(/\[[^\]]*\]/g, '')
                      .replace(/\s+/g, ' ')
                      .trim();
        }

        // Speak text
        function speakText(text) {
            stopSpeech();
            const cleaned = cleanTextForTTS(text);
            if (!cleaned) return;

            const utterance = new SpeechSynthesisUtterance(cleaned);
            utterance.lang = 'en-US';
            utterance.rate = speechRate;

            const voice = getEnglishVoice();
            if (voice) utterance.voice = voice;

            utterance.onend = () => {
                currentSpeech = null;
            };

            currentSpeech = utterance;
            speechSynthesis.speak(utterance);
        }

        // Stop speech
        function stopSpeech() {
            if (speechSynthesis.speaking || speechSynthesis.pending) {
                speechSynthesis.cancel();
            }
            currentSpeech = null;
        }

        // Load vocabulary
        function loadVocabulary(lessonKey) {
            const tableBody = document.getElementById('vocabTableBody');
            const data = vocabDatabase[lessonKey];

            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr class="no-data"><td colspan="2">No data available</td></tr>';
                return;
            }

            let html = '';
            data.forEach(section => {
                html += `<tr><td colspan="2" class="section-header">${section.section}</td></tr>`;
                section.words.forEach(item => {
                    const fullText = `${item.word}. ${item.example}`;
                    html += `<tr class="vocab-row">
                        <td class="audio-controls">
                            <button class="audio-btn play-btn" onclick="speakText('${fullText.replace(/'/g, "\\'")}')">🔊</button>
                            <button class="audio-btn stop-btn" onclick="stopSpeech()">⏹</button>
                        </td>
                        <td class="content-cell">
                            <div class="vocab-word">${item.word}</div>
                            <div class="example-sentence">${item.example}</div>
                        </td>
                    </tr>`;
                });
            });

            tableBody.innerHTML = html;
        }

        // Flatten lesson data
        function flattenLessonData(lessonData) {
            const flattened = [];
            lessonData.forEach((section, sectionIndex) => {
                section.words.forEach((word, wordIndex) => {
                    flattened.push({
                        ...word,
                        sectionIndex,
                        sectionTitle: section.section,
                        wordIndex
                    });
                });
            });
            return flattened;
        }

        // Update study session display
        function updateStudySession() {
            if (!currentLessonData || !flatWordsList.length) {
                document.getElementById('currentWord').textContent = 'Select a lesson first!';
                document.getElementById('currentExample').textContent = 'Please choose a lesson from the main page before starting your study session.';
                document.getElementById('progressInfo').textContent = 'Ready to start!';
                return;
            }

            // Restore normal interface if coming back from completion
            if (isCompleted) {
                restoreNormalInterface();
            }

            const currentItem = flatWordsList[currentWordIndex];
            if (!currentItem) return;

            document.getElementById('currentWord').textContent = currentItem.word;
            document.getElementById('currentExample').textContent = currentItem.example;

            const totalWords = flatWordsList.length;
            const progressText = `Word ${currentWordIndex + 1} of ${totalWords} • ${currentItem.sectionTitle}`;
            document.getElementById('progressInfo').textContent = progressText;

            // Update navigation buttons
            updateNavigationButtons();
        }

        // Update navigation buttons based on current state
        function updateNavigationButtons() {
            const backBtn = document.getElementById('backBtn');
            const nextBtn = document.getElementById('nextBtn');
            const nextSectionBtn = document.getElementById('nextSectionBtn');

            if (!flatWordsList.length) return;

            const totalWords = flatWordsList.length;
            const currentItem = flatWordsList[currentWordIndex];

            // Back button
            backBtn.disabled = currentWordIndex === 0;

            // Next button
            nextBtn.disabled = currentWordIndex === totalWords - 1;

            // Next section button
            const isLastSection = currentItem && currentItem.sectionIndex === Math.max(...flatWordsList.map(item => item.sectionIndex));
            nextSectionBtn.disabled = isLastSection;
        }

        // Restore normal interface from completion screen
        function restoreNormalInterface() {
            const speechBubble = document.getElementById('speechBubble');
            const currentItem = flatWordsList[currentWordIndex];

            if (currentItem) {
                speechBubble.innerHTML = `<div class="current-word" id="currentWord">${currentItem.word}</div>
                    <div class="current-example" id="currentExample">${currentItem.example}</div>
                    <div class="bubble-controls">
                        <button class="bubble-btn play-btn" id="speakCurrentBtn">🔊</button>
                        <button class="bubble-btn stop-btn" id="stopCurrentBtn">⏹</button>
                    </div>`;

                // Reattach event listeners
                attachBubbleEventListeners();
            }

            isCompleted = false;
        }

        // Attach event listeners to bubble controls
        function attachBubbleEventListeners() {
            const speakBtn = document.getElementById('speakCurrentBtn');
            const stopBtn = document.getElementById('stopCurrentBtn');

            if (speakBtn) {
                speakBtn.addEventListener('click', handleSpeakCurrent);
            }
            if (stopBtn) {
                stopBtn.addEventListener('click', stopSpeech);
            }
        }

        // Handle speak current word
        function handleSpeakCurrent() {
            const currentItem = flatWordsList[currentWordIndex];
            if (currentItem) {
                const fullText = `${currentItem.word}. ${currentItem.example}`;
                speakText(fullText);
            }
        }

        // Show congratulations screen
        function showCongratulations() {
            const partnerName = partners[currentPartner].name;
            const message = `Fantastic work! You've completed the entire vocabulary list! ${partnerName} is so proud of you!`;

            const speechBubble = document.getElementById('speechBubble');
            speechBubble.innerHTML = `<div class="congratulations">
                    <h3>Congratulations!</h3>
                    <p>${message}</p>
                </div>
                <div class="bubble-controls">
                    <button class="bubble-btn play-btn" id="congratsPlayBtn">🔊</button>
                    <button class="bubble-btn stop-btn" id="congratsStopBtn">⏹</button>
                    <button class="bubble-btn learn-again-btn" id="learnAgainBtn">🔄 Learn Again</button>
                </div>`;

            // Attach event listeners for congratulations screen
            document.getElementById('congratsPlayBtn').addEventListener('click', () => speakText(message));
            document.getElementById('congratsStopBtn').addEventListener('click', stopSpeech);
            document.getElementById('learnAgainBtn').addEventListener('click', restartLesson);

            setTimeout(() => speakText(message), 500);

            document.getElementById('progressInfo').textContent = 'Lesson Complete!';
            isCompleted = true;
            updateNavigationButtons();
        }

        // Check if lesson is completed - FIXED: Only trigger after going past the last word
        function checkCompletion() {
            // Only show completion if we've moved beyond the last word
            if (currentWordIndex >= flatWordsList.length && !isCompleted) {
                showCongratulations();
                // Set index back to last word so we don't go out of bounds
                currentWordIndex = flatWordsList.length - 1;
            }
        }

        // Navigation functions
        function nextWord() {
            if (currentWordIndex < flatWordsList.length - 1) {
                currentWordIndex++;
                updateStudySession();
            } else if (currentWordIndex === flatWordsList.length - 1) {
                // Moving past the last word - show completion
                currentWordIndex++;
                checkCompletion();
            }
        }

        function previousWord() {
            if (currentWordIndex > 0) {
                currentWordIndex--;
                // If coming back from completion state, restore interface
                if (isCompleted) {
                    isCompleted = false;
                }
                updateStudySession();
            }
        }

        function nextSection() {
            const currentSectionIndex = flatWordsList[currentWordIndex].sectionIndex;
            const nextSectionFirstWord = flatWordsList.find(item => item.sectionIndex > currentSectionIndex);
            
            if (nextSectionFirstWord) {
                currentWordIndex = flatWordsList.indexOf(nextSectionFirstWord);
                updateStudySession();
                checkCompletion();
            }
        }

        // Restart lesson from beginning - FIXED: Properly reset state
        function restartLesson() {
            currentWordIndex = 0;
            isCompleted = false;
            updateStudySession();
        }

        // Start study session with selected partner - FIXED: Always reset completion state
        function startStudySession(partnerNumber) {
            const selectedLesson = document.querySelector('.vocab-btn.active')?.getAttribute('data-lesson');
            
            if (!selectedLesson || !vocabDatabase[selectedLesson] || vocabDatabase[selectedLesson].length === 0) {
                alert('Please select a lesson with vocabulary data first!');
                return;
            }

            // Initialize session state - ALWAYS reset completion state
            currentPartner = partnerNumber;
            currentLessonData = vocabDatabase[selectedLesson];
            flatWordsList = flattenLessonData(currentLessonData);
            currentWordIndex = 0; // Always start from first word
            isCompleted = false; // Always reset completion state

            // Update partner display
            const partnerInfo = partners[partnerNumber];
            const avatarElement = document.getElementById('currentPartnerAvatar');
            avatarElement.innerHTML = `<img src="${partnerInfo.image}" alt="partner ${partnerNumber}">`;

            // Close partner selection modal and open study session
            document.getElementById('partnerModal').style.display = 'none';
            document.getElementById('studyModal').style.display = 'block';

            updateStudySession();
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Load voices
            document.body.addEventListener('click', () => loadVoices(), { once: true });

            // Load custom lists on startup
            loadCustomLists();

            // Lesson buttons (existing ones)
            const lessonButtons = document.querySelectorAll('.vocab-btn:not(.custom-list)');
            lessonButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.vocab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const lessonKey = this.getAttribute('data-lesson');
                    loadVocabulary(lessonKey);
                });
            });

            // Create List button
            document.getElementById('createListBtn').addEventListener('click', () => {
                resetCreatorForm();
                document.getElementById('creatorModal').style.display = 'block';
            });

            // Creator modal controls
            document.getElementById('closeCreatorModal').addEventListener('click', () => {
                document.getElementById('creatorModal').style.display = 'none';
            });

            document.getElementById('addWordBtn').addEventListener('click', () => {
                createWordEntry();
            });

            document.getElementById('saveListBtn').addEventListener('click', saveCustomList);

            // Speed buttons
            const speedButtons = document.querySelectorAll('.speed-btn');
            speedButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    speedButtons.forEach(b => b.classList.remove('active-speed'));
                    this.classList.add('active-speed');
                    speechRate = parseFloat(this.getAttribute('data-speed'));
                    stopSpeech();
                });
            });

            // Modal controls
            const choosePartnerBtn = document.getElementById('choosePartnerBtn');
            const partnerModal = document.getElementById('partnerModal');
            const studyModal = document.getElementById('studyModal');
            const creatorModal = document.getElementById('creatorModal');

            choosePartnerBtn.addEventListener('click', () => {
                partnerModal.style.display = 'block';
            });

            // Close buttons
            document.getElementById('closePartnerModal').addEventListener('click', () => {
                partnerModal.style.display = 'none';
            });

            document.getElementById('closeStudyModal').addEventListener('click', () => {
                studyModal.style.display = 'none';
                stopSpeech();
            });

            // Partner selection buttons
            const selectPartnerBtns = document.querySelectorAll('.select-partner-btn');
            selectPartnerBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const partnerNumber = parseInt(this.getAttribute('data-partner'));
                    startStudySession(partnerNumber);
                });
            });

            // Navigation buttons
            document.getElementById('nextBtn').addEventListener('click', nextWord);
            document.getElementById('backBtn').addEventListener('click', previousWord);
            document.getElementById('nextSectionBtn').addEventListener('click', nextSection);

            // Initial bubble event listeners
            attachBubbleEventListeners();

            // Click outside modal to close
            window.addEventListener('click', (e) => {
                if (e.target === partnerModal) {
                    partnerModal.style.display = 'none';
                }
                if (e.target === studyModal) {
                    studyModal.style.display = 'none';
                    stopSpeech();
                }
                if (e.target === creatorModal) {
                    creatorModal.style.display = 'none';
                }
            });

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => stopSpeech());
        }

        // Global functions for HTML onclick events
        window.removeWordEntry = removeWordEntry;
        window.deleteCustomList = deleteCustomList;
        window.speakText = speakText;
        window.stopSpeech = stopSpeech;

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeEventListeners);

        // PWA Installation Handler
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const dismissBtn = document.getElementById('dismissBtn');

        // Capture install prompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt after 3 seconds
            setTimeout(() => {
                installPrompt.style.display = 'block';
            }, 3000);
        });

        // Install button click
        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            console.log(`User response: ${outcome}`);
            deferredPrompt = null;
            installPrompt.style.display = 'none';
        });

        // Dismiss button click
        dismissBtn.addEventListener('click', () => {
            installPrompt.style.display = 'none';
        });

        // Hide prompt after successful install
        window.addEventListener('appinstalled', () => {
            console.log('PWA installed successfully');
            installPrompt.style.display = 'none';
            deferredPrompt = null;
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>