<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë™ûÂΩô„É™„Çπ„Éà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 2.5em;
        }

        .button-categories {
            margin-bottom: 30px;
        }

        .category {
            margin-bottom: 25px;
        }

        .category-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            display: inline-block;
        }

        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .vocab-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .vocab-btn:hover {
            background-color: #2980b9;
        }

        .vocab-btn.active {
            background-color: #e74c3c;
        }

        /* Quiz Section */
        .quiz-section {
            margin: 30px 0;
            text-align: center;
            padding: 20px;
            background-color: #fff3cd;
            border-radius: 8px;
            border: 2px solid #ffc107;
        }

        /* Section Selector */
        .section-selector-area {
            margin: 15px 0 0 0;
            padding: 20px;
            background-color: #fffbf0;
            border-radius: 8px;
            border: 2px dashed #ffc107;
        }

        .section-selector-title {
            font-weight: bold;
            font-size: 16px;
            color: #856404;
            margin-bottom: 15px;
        }

        .section-checkboxes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .section-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .section-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .section-checkbox-item label {
            cursor: pointer;
            font-size: 14px;
            color: #333;
            user-select: none;
            flex: 1;
        }

        .section-checkbox-item:hover {
            background-color: #f0f0f0;
        }

        /* Floating Navigation Buttons */
        .floating-nav-buttons {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .floating-nav-btn {
            width: 60px;
            height: 60px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            transition: all 0.3s;
        }

        .floating-nav-btn:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }

        .floating-nav-btn.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .next-section-btn {
            background-color: #27ae60;
        }

        .next-section-btn:hover {
            background-color: #229954;
        }

        .prev-section-btn {
            background-color: #27ae60;
        }

        .prev-section-btn:hover {
            background-color: #229954;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            #toggleEnglishBtn {
                padding: 6px 12px !important;
                font-size: 14px !important;
            }

            .floating-nav-buttons {
                bottom: 20px;
                right: 20px;
                gap: 8px;
            }
            
            .floating-nav-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        @media (max-width: 768px) {
            .section-selector-area {
                padding: 15px;
                margin: 15px 0;
            }

            .section-selector-title {
                font-size: 15px;
            }

            .section-checkboxes-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .section-checkbox-item {
                padding: 10px;
            }

            .section-checkbox-item input[type="checkbox"] {
                width: 18px;
                height: 18px;
            }

            .section-checkbox-item label {
                font-size: 13px;
            }
        }

        .quiz-btn {
            background-color: #ffc107;
            color: #333;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .quiz-btn:hover {
            background-color: #ffb300;
        }

        /* Overall Vocabulary Button Section */
        .overall-vocab-section {
            margin: 30px 0;
            text-align: center;
            padding: 20px;
            background-color: #e8f8f5;
            border-radius: 8px;
        }

        /* Overall Vocabulary Modal */
        .overall-vocab-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .overall-vocab-content {
            background-color: white;
            margin: 20px auto;
            padding: 30px;
            border-radius: 8px;
            width: 95%;
            max-width: 1000px;
            position: relative;
        }

        .overall-vocab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }

        .overall-vocab-header h2 {
            color: #2c3e50;
            margin: 0;
        }

        .overall-vocab-buttons {
            display: flex;
            gap: 10px;
        }

        .overall-vocab-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .overall-vocab-btn:hover {
            background-color: #218838;
        }

        .overall-vocab-btn.close-btn {
            background-color: #6c757d;
        }

        .overall-vocab-btn.close-btn:hover {
            background-color: #5a6268;
        }

        .vocab-section-block {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .section-title-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .section-title-row input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .section-title-row label {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            cursor: pointer;
            flex: 1;
        }

        .section-count {
            font-size: 0.9em;
            color: red;
            font-weight: bold;
            margin-left: 8px;
        }

        .vocab-items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .vocab-item-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .vocab-item-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .vocab-item-row label {
            cursor: pointer;
            font-size: 18px;  
            color: #333;
            line-height: 1.5;  
            flex: 1;
            word-wrap: break-word;  
        }

        @media (max-width: 768px) {
            .vocab-items-grid {
                grid-template-columns: 1fr;
            }
            
            .overall-vocab-content {
                padding: 15px;
            }
        }

        .speed-control-section {
            margin: 30px 0;
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .speed-label {
            font-weight: bold;
            color: #495057;
            margin-right: 15px;
            font-size: 16px;
        }

        .speed-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .speed-btn:hover {
            background-color: #5a6268;
        }

        .speed-btn.active-speed {
            background-color: #28a745;
        }

        .study-partner-section {
            margin: 30px 0;
            text-align: center;
            padding: 20px;
            background-color: #e8f4f8;
            border-radius: 8px;
        }

        .study-partner-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }

        .study-partner-btn:hover {
            background-color: #218838;
        }

        .vocab-table-container {
            margin-top: 30px;
            overflow-x: auto;
        }

        .vocab-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        .section-header {
            background-color: #ecf0f1;
            font-weight: bold;
            padding: 15px;
            text-align: left;
            font-size: 1.5em;
            color: #2c3e50;
        }

        .vocab-row {
            border-bottom: 1px solid #ddd;
        }

        .audio-controls {
            width: 80px;
            text-align: center;
            padding: 15px 10px;
            vertical-align: top;
        }

        .content-cell {
            padding: 15px;
            vertical-align: top;
        }

        .vocab-word {
            font-weight: bold;
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .example-sentence {
            font-size: 1.5em;
            color: #555;
            line-height: 1.5;
        }

        .audio-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            margin: 2px;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        .audio-btn:hover {
            background-color: #f0f0f0;
        }

        .play-btn {
            color: #27ae60;
        }

        .stop-btn {
            color: #e74c3c;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: red;
            font-size: 25px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 20px auto;
            padding: 25px;
            border-radius: 8px;
            width: 95%;
            max-width: 600px;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            right: 15px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
        }

        .close:hover {
            color: #000;
        }

        /* Listen and Choose Quiz Styles - Mobile Optimized */
        .quiz-modal-content {
            margin: 5px auto;
            padding: 15px;
            max-height: 98vh;
            display: flex;
            flex-direction: column;
        }

        .quiz-header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.5em;
            padding-right: 30px;
        }

        @media (max-width: 768px) {
            .quiz-connector {
                margin: 3px 0;
            }
            
            .section-selector-area {
                margin: 10px 0 0 0;
                padding: 15px;
            }

            .section-selector {
                max-height: 120px;
                padding: 10px;
            }

            .section-selector-title {
                font-size: 16px;
            }

            .section-item label {
                font-size: 12px;
            }
        }

        .listen-answer-section {
            text-align: center;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .listen-answer-display {
            font-size: 23px;
            font-weight: bold;
            color: #2c3e50;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .listen-speaker {
            font-size: 30px;
            cursor: pointer;
            display: inline-block;
            transition: transform 0.2s;
        }

        .listen-speaker:hover {
            transform: scale(1.1);
        }

        .listen-speaker:active {
            transform: scale(0.95);
        }

        .timer-feedback-section {
            text-align: center;
            margin: 8px 0;
            min-height: 25px;
        }

        .timer-feedback {
            font-size: 25px;
            font-weight: bold;
        }

        .timer-feedback.correct {
            color: #28a745;
        }

        .timer-feedback.incorrect {
            color: #dc3545;
        }

        .choices-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 10px 0;
            flex-grow: 1;
        }

        .choice-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.4;
        }

        .choice-btn:hover:not(:disabled) {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .choice-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .choice-btn.correct {
            background-color: #28a745;
            animation: pulse-correct 0.5s;
        }

        .choice-btn.incorrect {
            background-color: #dc3545;
            animation: shake 0.5s;
        }

        @keyframes pulse-correct {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .listen-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }

        .listen-next-btn, .listen-close-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .listen-next-btn {
            background-color: #28a745;
            color: white;
        }

        .listen-next-btn:hover:not(:disabled) {
            background-color: #218838;
        }

        .listen-next-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .listen-close-btn {
            background-color: #6c757d;
            color: white;
        }

        .listen-close-btn:hover {
            background-color: #5a6268;
        }

        .quiz-complete {
            text-align: center;
            padding: 20px;
            grid-column: 1 / -1;
            width: 100%;
        }

        .quiz-complete h3 {
            color: #28a745;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .quiz-score {
            font-size: 25px;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .restart-quiz-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
        }

        .restart-quiz-btn:hover {
            background-color: #2980b9;
        }           
        
        .study-session {
            text-align: center;
        }

        .partner-display {
            margin-bottom: 30px;
        }

        .partner-avatar {
            font-size: 100px;
            line-height: 1;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .speech-bubble {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 20px;
            border-radius: 10px;
            margin: 0 auto 20px;
            max-width: 500px;
        }

        .current-word {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .current-example {
            font-size: 23px;
            margin-bottom: 15px;
        }

        .bubble-controls {
            margin-bottom: 15px;
        }

        .bubble-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            margin: 0 5px;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        .bubble-btn:hover {
            background-color: #f0f0f0;
        }

        .bubble-btn.play-btn {
            color: #27ae60;
        }

        .bubble-btn.stop-btn {
            color: #e74c3c;
        }

        .bubble-btn.translate-btn {
            color: #e74c3c;
        }

        .bubble-btn.translate-btn:disabled {
            color: #95a5a6;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .translation-text {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 5px;
            border: 1px solid #ffc107;
            font-size: 21px;
            color: #856404;
            line-height: 1.5;
        }

        .translation-text.show {
            display: block;
        }

        .translation-label {         
            color: #856404;
            margin-bottom: 5px;
        }

        .progress-info {
            margin-bottom: 20px;
            font-size: 19px;
            color: #666;
        }

        .navigation-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 17px;
        }

        .nav-btn:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .nav-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .learn-again-btn {
            background-color: #28a745 !important;
        }

        .learn-again-btn:hover {
            background-color: #218838 !important;
        }

        .congratulations {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .congratulations h3 {
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }

            .category-title {
                font-size: 1.2em;
            }

            .vocab-btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .quiz-section {
                padding: 15px;
                margin: 20px 0;
            }

            .quiz-btn {
                padding: 12px 20px;
                font-size: 16px;
            }

            .speed-control-section {
                padding: 10px;
            }

            .speed-label {
                display: block;
                margin-bottom: 10px;
                margin-right: 0;
            }

            .speed-btn {
                padding: 8px 12px;
                font-size: 13px;
                margin: 2px;
            }

            .study-partner-section {
                padding: 15px;
            }

            .study-partner-btn {
                padding: 12px 20px;
                font-size: 16px;
            }

            .section-header {
                font-size: 1.2em;
                padding: 12px;
            }

            .section-checkbox {
                width: 18px;
                height: 18px;
            }

            .audio-controls {
                width: 60px;
                padding: 10px 5px;
            }

            .content-cell {
                padding: 12px;
            }

            .vocab-word {
                font-size: 1.5em;
            }

            .example-sentence {
                font-size: 1.5em;
            }

            /* Quiz Modal Mobile Optimization */
            .modal-content {
                width: 98%;
                margin: 5px auto;
                padding: 12px;
            }

            .quiz-modal-content {
                max-height: 97vh;
                padding: 10px;
            }

            .quiz-header {
                font-size: 1.5em;
                margin-bottom: 10px;
            }

            .listen-answer-section {
                padding: 10px;
                margin-bottom: 8px;
            }

            .listen-answer-display {
                font-size: 23px;
                min-height: 50px;
                line-height: 1.3;
            }

            .listen-speaker {
                font-size: 30px;
            }

            .timer-feedback {
                font-size: 25px;
            }

            .choices-grid {
                gap: 6px;
                margin: 8px 0;
            }

            .choice-btn {
                font-size: 18px;
                padding: 10px 8px;
                min-height: 55px;
                line-height: 1.3;
            }

            .listen-controls {
                gap: 8px;
                margin-top: 8px;
                padding-top: 8px;
            }

            .listen-next-btn, .listen-close-btn {
                padding: 8px 20px;
                font-size: 20px;
            }
         
            .partner-avatar {
                font-size: 45px;
            }

            .question-prompt {
                font-size: 20px !important;
            }

            .partner-display {
                padding: 12px !important;
                gap: 8px !important;
            }

            .speech-bubble {
                padding: 15px !important;
            }

            .current-word {
                font-size: 23px;
            }

            .current-example {
                font-size: 21px;
            }

            .translation-text {
                font-size: 19px;
                padding: 8px;
                margin-top: 8px;
            }

            .navigation-controls {
                gap: 5px;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 15px;
            }
        }

        @media (max-width: 400px) {
            .quiz-header {
                font-size: 1.5em;
            }

            .listen-answer-display {
                font-size: 23px;
                min-height: 45px;
            }

            .choice-btn {
                font-size: 18px;
                min-height: 50px;
                padding: 8px 6px;
            }
        }

        /* Quiz Connector Animation */
        .quiz-connector {
            animation: bounce 1.5s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(5px);
            }
        }

        /* Quiz History Styles */
        .quiz-history-item {
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .quiz-history-item:hover {
            border-color: #3498db;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .quiz-history-date {
            font-size: 18px; 
            color: #3498db;    
            margin-bottom: 10px;
        }

        .quiz-history-category {
            font-size: 18px; 
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .quiz-history-lesson {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .quiz-history-sections {
            font-size: 18px; 
            color: #555;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .quiz-history-score {
            font-size: 20px;
            font-weight: bold;
            display: inline-block;
            padding: 8px 16px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .quiz-history-score.excellent {
            background-color: #d4edda;
            color: #155724;
        }

        .quiz-history-score.good {
            background-color: #fff3cd;
            color: #856404;
        }

        .quiz-history-score.needs-improvement {
            background-color: #f8d7da;
            color: #721c24;
        }

        .quiz-history-delete {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px; 
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px; 
            margin-top: 10px;
            float: right;
        }

        .quiz-history-delete:hover {
            background-color: #c0392b;
        }

        .no-quiz-history {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 18px;
        }

        /* Custom Monthly Learning Cycle Styles */
        .monthly-custom-btn {
            background-color: #FFB11B;
            color: black;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .monthly-custom-btn:hover {
            background-color: #FC9F4D;
        }

        .week-section {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .week-section h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .item-count {
            font-size: 14px;
            color: #e74c3c;
            font-weight: bold;
        }

        .days-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .day-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .day-btn {
            background-color: #17a2b8;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .day-btn:hover {
            background-color: #138496;
            transform: translateY(-1px);
        }

        .day-btn.has-content {
            background-color: #27ae60;
        }

        .edit-btn {
            background-color: #ffc107;
            color: #333;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .edit-btn:hover {
            background-color: #e0a800;
            transform: translateY(-1px);
        }

        .clear-week-btn {
            background-color: #95a5a6;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
        }

        .clear-week-btn:hover {
            background-color: #e74c3c;
        }

        @media (max-width: 768px) {
            #monthly-grid { grid-template-columns: 1fr !important; }
        }

    </style>
</head>
<body>
    <div class="floating-nav-buttons">
        <button class="floating-nav-btn" id="backToTopBtn" title="Back to lesson buttons">üîù</button>
        <button class="floating-nav-btn prev-section-btn" id="floatingPrevSectionBtn" title="Previous section">‚¨ÜÔ∏è</button>
        <button class="floating-nav-btn next-section-btn" id="floatingNextSectionBtn" title="Next section">‚¨áÔ∏è</button>
    </div>
    
    <div class="container">
        <h1>üìö ÂçòË™ûË°®<br>(v6.11)</h1>

        <div class="button-categories">
            <div class="category">
                <div class="category-title">üìò Êó•Êú¨Ë™û Go Go Go Ôºë</div>
                <div class="category-buttons">
                    <button class="vocab-btn" data-category="textbook" data-lesson="b1l1">L1</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b1l2">L2</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b1l3">L3</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b1l4">L4</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b1l5">L5</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b1l6">L6</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b1l7">L7</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b1l8">L8</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b1l9">L9</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b1l10">L10</button>            
                </div>
            </div>

            <div class="category">
                <div class="category-title">üìî Êó•Êú¨Ë™û Go Go Go Ôºí</div>
                <div class="category-buttons">
                    <button class="vocab-btn" data-category="textbook" data-lesson="b2l1">L1</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b2l2">L2</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b2l3">L3</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b2l4">L4</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b2l5">L5</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b2l6">L6</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b2l7">L7</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b2l8">L8</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b2l9">L9</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b2l10">L10</button>
                </div>
            </div>

            <div class="category">
                <div class="category-title">üìô Êó•Êú¨Ë™û Go Go Go Ôºì</div>
                <div class="category-buttons">
                    <button class="vocab-btn" data-category="textbook" data-lesson="b3l1">L1</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b3l2">L2</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b3l3">L3</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b3l4">L4</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b3l5">L5</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b3l6">L6</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b3l7">L7</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b3l8">L8</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b3l9">L9</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b3l10">L10</button>
                </div>
            </div>

            <div class="category">
                <div class="category-title">üìó Êó•Êú¨Ë™û Go Go Go Ôºî</div>
                <div class="category-buttons">
                    <button class="vocab-btn" data-category="textbook" data-lesson="b4l1">L1</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b4l2">L2</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b4l3">L3</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b4l4">L4</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b4l5">L5</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b4l6">L6</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b4l7">L7</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b4l8">L8</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b4l9">L9</button>
                    <button class="vocab-btn" data-category="textbook" data-lesson="b4l10">L10</button>
                </div>
            </div>

            <div class="category">
                <div class="category-title">üìù ÊúàÈñì(„Åí„Å£„Åã„Çì)„Çπ„Ç±„Ç∏„É•„Éº„É´</div>
                <div class="category-buttons" id="custom-category-buttons">
                    <button class="monthly-custom-btn" data-month="1">1„É∂ÊúàÁõÆ</button>
                    <button class="monthly-custom-btn" data-month="2">2„É∂ÊúàÁõÆ</button>
                    <button class="monthly-custom-btn" data-month="3">3„É∂ÊúàÁõÆ</button>
                    <button id="hidden-custom-btn" class="vocab-btn" style="display: none;"></button>
                </div>
            </div>
        </div>

        <div class="study-partner-section">
            <button class="study-partner-btn" id="walkMeThruBtn">
                üëÄ Âæ©Áøí <br>(Âíå‚Üí‰∏≠ Á¢∫Ë™ç)
            </button>
        </div>

        <div class="quiz-section">
            <button class="quiz-btn" id="listenChooseBtn">
                üéß ËÅ¥Ëß£ (8Âïè)
            </button>
            
            <div class="quiz-connector" id="quizConnector" style="display: none;">
                <div style="text-align: center; font-size: 30px; color: #ffc107; margin: 5px 0;">‚òùÔ∏è</div>
            </div>
            
            <div class="section-selector-area" id="sectionSelectorArea" style="display: none;">
                <div class="section-selector-title">üìã „ÇØ„Ç§„Ç∫„ÅÆÁØÑÂõ≤„ÇíÈÅ∏Êäû <br>(„Çª„ÇØ„Ç∑„Éß„É≥ÈÅ∏Êäû)</div>
                <div class="section-checkboxes-grid" id="sectionCheckboxesGrid"></div>
            </div>
        </div>

        <div class="overall-vocab-section" id="overallVocabSection" style="display: none;">
            <button class="study-partner-btn" id="overallVocabBtn" style="background-color: #17a2b8;">
                üóÉÔ∏è ÂçòË™ûÁÆ°ÁêÜ(„Åã„Çì„Çä 1) <br>(Ë¶ö„Åà„ÅüÂçòË™û„ÇíÂ§ñ„Åô)
            </button>
        </div>

        <div class="overall-vocab-section" style="display: block; margin-top: 20px;">
            <button class="study-partner-btn" id="quizHistoryBtn" style="background-color: #9b59b6;">
                üìä „ÇØ„Ç§„Ç∫„ÅÆÁÇπÊï∞„ÅÆË®òÈå≤(„Åç„Çç„Åè 0) <br>(ÈÅéÂéª„ÅÆÊàêÁ∏æ)
            </button>
        </div>

        <div class="speed-control-section">
            <div class="tts-system-selector" style="margin-bottom: 15px; font-size: 16px; color: #495057;">
                <label for="tts-system" style="font-weight: bold; margin-right: 8px;">Á≥ªÁµ±(„Åë„ÅÑ„Å®„ÅÜ 0)Ôºè„Ç∑„Çπ„ÉÜ„É†:</label>
                <select id="tts-system" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; background-color: white;">
                    <option value="android" selected>Android</option>
                    <option value="ios">iOS</option>
                </select>
            </div>
            <span class="speed-label">ÈÄüÂ∫¶(„Åù„Åè„Å© 1)Ôºè„Çπ„Éî„Éº„Éâ:</span>
            <button class="speed-btn" data-speed="1.2">1.2x</button>
            <button class="speed-btn active-speed" data-speed="1.0">1x</button>
            <button class="speed-btn" data-speed="0.8">0.8x</button>
            <button class="speed-btn" data-speed="0.6">0.6x</button>
        </div>

        <div class="vocab-table-container">
            <table class="vocab-table" id="vocabTable">
                <tbody id="vocabTableBody">
                    <tr class="no-data">
                        <td colspan="2">„É¨„ÉÉ„Çπ„É≥„ÇíÈÅ∏Êäû„Åó„Å¶ÂçòË™û„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="welcomeModal" class="modal" style="display: block;">
        <div class="modal-content" style="max-width: 500px;">
            <div style="text-align: center; padding: 10px;">
                <h2 style="color: #2c3e50; margin-bottom: 20px;">üì¢ ÈáçË¶Å„Å™„ÅäÁü•„Çâ„Åõ</h2>
                <div style="text-align: left; font-size: 16px; line-height: 1.8; margin-bottom: 25px;">
                    <p style="margin-bottom: 15px; color: red; text-align: center;"><strong>1. ÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó„Åô„Çã„Åü„ÇÅ„ÄÅÊØéÂõû„ÄåÊõ¥Êñ∞ („É™„Éï„É¨„ÉÉ„Ç∑„É•) üîÑ„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ</strong></p>
                    <p style="margin-bottom: 0; text-align: center;">2. „Çπ„Éû„Éõ„ÅÆ„Äå„ÉÜ„Ç≠„Çπ„ÉàË™≠„Åø‰∏ä„Åí„ÄçÊ©üËÉΩ„ÅåÊõ¥Êñ∞„Åï„Çå„Çã„Å® üîä „ÅåÈ≥¥„Çâ„Å™„Åè„Å™„Çã„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÁ´ØÊú´„ÇíÂÜçËµ∑Âãï„Åô„Çã„Å®Áõ¥„Çä„Åæ„Åô„ÄÇ</p>
                </div>
                <button id="welcomeOkBtn" onclick="document.getElementById('welcomeModal').style.display='none';" style="background-color: #28a745; color: white; border: none; padding: 12px 40px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; min-height: 48px; touch-action: manipulation;">
                    Á¢∫Ë™ç„Åó„Åæ„Åó„Åü
                </button>
            </div>
        </div>
    </div>

    <div id="listenChooseModal" class="modal">
        <div class="modal-content quiz-modal-content">
            <span class="close" id="closeListenChoose">&times;</span>
            <h2 class="quiz-header">üéß ËÅ¥„ÅÑ„Å¶ÈÅ∏„Å∂</h2>
            <div class="listen-answer-section">
                <div id="listenAnswerDisplay" class="listen-answer-display">„Çπ„Éî„Éº„Ç´„Éº„Çí„ÇØ„É™„ÉÉ„ÇØ</div>
                <div style="display: flex; justify-content: center; align-items: center; gap: 15px;">
                    <div class="listen-speaker" id="listenSpeaker" title="Play Audio">üîä</div>
                    <button id="toggleEnglishBtn" class="listen-next-btn" style="padding: 8px 16px; font-size: 16px; background-color: #6c757d;">
                        Êó•Êú¨Ë™û„ÇíË°®Á§∫
                    </button>
                </div>
            </div>
            <div class="timer-feedback-section">
                <div id="timerFeedback" class="timer-feedback"></div>
            </div>
            <div id="choicesGrid" class="choices-grid"></div>
            <div class="listen-controls">
                <button id="listenNextBtn" class="listen-next-btn">Ê¨°„Å∏</button>
                <button id="listenCloseBtn" class="listen-close-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>
    
    <div id="studyModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeStudyModal">&times;</span>
            <div class="study-session">
                <div class="partner-display" style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                    <div class="partner-avatar" id="currentPartnerAvatar" style="font-size: 38px; line-height: 1;">
                        üßë
                    </div>
                    <div class="question-prompt" id="questionPrompt" style="font-size: 24px; font-weight: bold; color: #3498db;">
                        „Å©„ÅÜ„ÅÑ„ÅÜÊÑèÂë≥„Åß„Åô„ÅãÔºü
                    </div>
                </div>

                <div class="speech-bubble" id="speechBubble" style="background-color: white; padding: 20px; border-radius: 8px; border: 2px solid #dee2e6; margin-bottom: 20px;">
                    <div class="current-word" id="currentWord">„Åæ„Åö„É¨„ÉÉ„Çπ„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ</div>
                    <div class="current-example" id="currentExample">Â≠¶Áøí„ÇíÂßã„ÇÅ„ÇãÂâç„Å´„ÄÅ„É°„Ç§„É≥„Éö„Éº„Ç∏„Åã„Çâ„É¨„ÉÉ„Çπ„É≥„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
                    <div class="bubble-controls">
                        <button class="bubble-btn play-btn" id="speakCurrentBtn" title="Play Audio">üîä</button>
                        <button class="bubble-btn stop-btn" id="stopCurrentBtn" title="Stop">‚èπ</button>
                        <button class="bubble-btn translate-btn" id="showTranslationBtn" title="Show Translation">üÄÑ</button>
                    </div>
                    <div class="translation-text" id="translationText">
                        <div class="translation-label">üåê Êó•Êú¨Ë™ûË®≥Ôºö</div>
                        <div>ÁøªË®≥ÂæÖ„Å°...</div>
                    </div>
                </div>
                <div class="progress-info" id="progressInfo">
                    Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ
                </div>
                <div class="navigation-controls" id="navigationControls">
                    <button class="nav-btn" id="backBtn">‚Üê Êàª„Çã</button>
                    <button class="nav-btn" id="nextBtn">Ê¨°„Å∏ ‚Üí</button>
                    <button class="nav-btn" id="studyModalNextSectionBtn">Ê¨°„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥</button>
                </div>
            </div>
        </div>
    </div>

    <div id="overallVocabModal" class="overall-vocab-modal">
        <div class="overall-vocab-content">
            <div class="overall-vocab-header">
                <h2>üóÉÔ∏è ÂçòË™ûÁÆ°ÁêÜ</h2>
                <div class="overall-vocab-buttons">
                    <button class="overall-vocab-btn" id="saveVocabBtn">üíæ ‰øùÂ≠ò</button>
                    <button class="overall-vocab-btn close-btn" id="closeOverallVocabBtn">‚úñ Èñâ„Åò„Çã</button>
                </div>
            </div>
            <p style="color: red; margin-bottom: 20px; font-size: 18px;">Ë¶ö„Åà„ÅüÂçòË™û„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§ñ„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ(*Â§ñ„ÅôÔºè„ÅØ„Åö„Åô 0)</p>
            <div id="overallVocabList"></div>
        </div>
    </div>

    <div id="quizHistoryModal" class="overall-vocab-modal">
        <div class="overall-vocab-content">
            <div class="overall-vocab-header">
                <h2>üìä „ÇØ„Ç§„Ç∫Â±•Ê≠¥</h2>
                <div class="overall-vocab-buttons">
                    <button class="overall-vocab-btn" id="clearHistoryBtn" style="background-color: #e74c3c;">
                        üóëÔ∏è „Åô„Åπ„Å¶ÂâäÈô§
                    </button>
                    <button class="overall-vocab-btn close-btn" id="closeQuizHistoryBtn">‚úñ Èñâ„Åò„Çã</button>
                </div>
            </div>
            <div id="quizHistoryList" style="max-height: 600px; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="monthly-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <h2 id="monthly-modal-title" style="text-align: center; color: #2c3e50; margin-bottom: 20px;">üóìÔ∏è X„É∂ÊúàÁõÆ</h2>
            <div id="monthly-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <script>
                    for(let w=1; w<=4; w++) {
                        document.write(`
                        <div class="week-section">
                            <h3>Á¨¨ ${w} ÈÄ± <span id="week${w}-count" class="item-count">0 ÂÄã</span></h3>
                            <div class="days-grid">
                                ${[1,2,3,4,5,6,7].map(d => `
                                <div class="day-row">
                                    <button class="day-btn" data-week="${w}" data-day="${d}">${d === 7 ? 'Âæ©ÁøíÊó•' : d + 'Êó•ÁõÆ'}</button>
                                    <button class="edit-btn" data-week="${w}" data-day="${d}">Á∑®ÈõÜ</button>
                                </div>`).join('')}
                            </div>
                            <button class="clear-week-btn" data-week="${w}">Á¨¨ ${w} ÈÄ±„ÇíÂâäÈô§</button>
                        </div>`);
                    }
                </script>
                <div class="week-section" style="grid-column: 1 / -1;">
                    <h3>‰∫àÂÇô <span id="weekbackup-count" class="item-count">0 ÂÄã</span></h3>
                    <div class="days-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <script>
                            for(let d=1; d<=5; d++) {
                                document.write(`
                                <div class="day-row">
                                    <button class="day-btn" data-week="backup" data-day="${d}">‰∫àÂÇô ${d}</button>
                                    <button class="edit-btn" data-week="backup" data-day="${d}">Á∑®ÈõÜ</button>
                                </div>`);
                            }
                        </script>
                    </div>
                    <button class="clear-week-btn" data-week="backup" style="margin-top: 10px;">‰∫àÂÇô„ÇíÂâäÈô§</button>
                </div>
            </div>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                <button id="monthly-clear-all-btn" class="quiz-btn" style="background-color: #e74c3c; color: white;">üà≥ ‰ªäÊúà„Çí„Åô„Åπ„Å¶ÂâäÈô§</button>
                <button id="monthly-close-btn" class="quiz-btn" style="background-color: #6c757d; color: white;">‚úñ Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <div id="edit-entry-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 10px;">‚úèÔ∏è „Ç®„É≥„Éà„É™„Éº„ÇíÁ∑®ÈõÜ</h2>
            <p style="color: #e74c3c; margin-bottom: 15px; text-align: center; font-weight: bold;">(ÂÖ•ÂäõÂΩ¢Âºè: ÂçòË™û („É≠„Éº„ÉûÂ≠ó) (‰∏≠Ë®≥) ^ ‰æãÊñá (Ëã±Ë®≥))</p>
            <textarea id="edit-entry-content" style="width: 100%; height: 400px; padding: 15px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 6px; box-sizing: border-box; resize: vertical; font-family: monospace; line-height: 1.6;" placeholder="‚óé„Çª„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´&#10;ÂçòË™û („É≠„Éº„ÉûÂ≠ó) (‰∏≠Ë®≥) ^ ‰æãÊñá (Ëã±Ë®≥)"></textarea>
            
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <button id="edit-save-btn" class="quiz-btn" style="background-color: #28a745; color: white;">üíæ ‰øùÂ≠ò</button>
                <button id="edit-ai-link-btn" class="quiz-btn" style="background-color: #17a2b8; color: white;">üí° AI (Ë®≥+‰æãÊñá)</button>
                <button id="edit-clear-btn" class="quiz-btn" style="background-color: #f39c12; color: white;">üà≥ „Åï„Åè„Åò„Çá 1</button>
                <button id="edit-cancel-btn" class="quiz-btn" style="background-color: #6c757d; color: white;">üö´ „Å°„ÇÖ„ÅÜ„Åó 0</button>
            </div>
        </div>
    </div>

    <script>
        // ============ INDEXEDDB FUNCTIONS ============
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('VocabDatabase', 4);  
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('checkedWords')) {
                        db.createObjectStore('checkedWords', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('visitHistory')) {
                        db.createObjectStore('visitHistory', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('quizHistory')) {
                        db.createObjectStore('quizHistory', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('customLists')) {
                        db.createObjectStore('customLists', { keyPath: 'id' });
                    }
                };
            });
        }

        function saveCheckedWords(lessonKey, checkedWords) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['checkedWords'], 'readwrite');
                const store = transaction.objectStore('checkedWords');
                const request = store.put({ id: lessonKey, words: checkedWords });
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function loadCheckedWords(lessonKey) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['checkedWords'], 'readonly');
                const store = transaction.objectStore('checkedWords');
                const request = store.get(lessonKey);
                
                request.onsuccess = () => {
                    if (request.result) {
                        resolve(request.result.words);
                    } else {
                        resolve(null);
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }

        function saveVisitRecord(visitData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }
                const transaction = db.transaction(['visitHistory'], 'readwrite');
                const store = transaction.objectStore('visitHistory');
                const request = store.put(visitData);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function loadVisitRecord() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }
                const transaction = db.transaction(['visitHistory'], 'readonly');
                const store = transaction.objectStore('visitHistory');
                const request = store.get('userVisits');
                
                request.onsuccess = () => {
                    resolve(request.result || null);
                };
                request.onerror = () => reject(request.error);
            });
        }

        function getDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function calculateVisitStats() {
            try {
                const visitRecord = await loadVisitRecord();
                const today = getDateString(new Date());
                
                if (!visitRecord) {
                    const newRecord = {
                        id: 'userVisits',
                        firstVisit: today,
                        lastVisit: today,
                        totalVisits: 1,
                        consecutiveDays: 1,
                        visitDates: [today]
                    };
                    await saveVisitRecord(newRecord);
                    return newRecord;
                }
                
                if (visitRecord.lastVisit === today) {
                    return visitRecord;
                }
                
                const lastVisitDate = new Date(visitRecord.lastVisit);
                const todayDate = new Date(today);
                const daysDifference = Math.floor((todayDate - lastVisitDate) / (1000 * 60 * 60 * 24));
                
                const updatedRecord = {
                    ...visitRecord,
                    lastVisit: today,
                    totalVisits: visitRecord.totalVisits + 1,
                    visitDates: [...(visitRecord.visitDates || []), today]
                };
                
                if (daysDifference === 1) {
                    updatedRecord.consecutiveDays = (visitRecord.consecutiveDays || 1) + 1;
                    updatedRecord.lastStreakBroken = undefined;
                } else if (daysDifference > 1) {
                    updatedRecord.consecutiveDays = 1;
                    updatedRecord.lastStreakBroken = daysDifference;
                }
                
                await saveVisitRecord(updatedRecord);
                return updatedRecord;
            } catch (error) {
                console.error('Error calculating visit stats:', error);
                throw error;
            }
        }

        function formatVisitMessage(stats) {
            try {
                const firstVisitDate = new Date(stats.firstVisit);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = firstVisitDate.toLocaleDateString('ja-JP', options);
                
                let message = `ÂàùÂõû„Ç¢„ÇØ„Çª„Çπ: <span style="color: #e67e22; font-weight: bold;">${formattedDate}</span> <br>ÂêàË®à„Ç¢„ÇØ„Çª„ÇπÊï∞: <span style="color: #e67e22; font-weight: bold;">${stats.totalVisits}</span>`;
                
                if (stats.consecutiveDays >= 2) {
                    message += `<br><span style="color: #27ae60; font-weight: bold; font-size: 20px;">${stats.consecutiveDays}Êó•ÈÄ£Á∂ö(„Çå„Çì„Åû„Åè)</span>„ÅÆÂ≠¶Áøí„Åß„Åô„ÄÇ<br>„Åì„ÅÆË™øÂ≠ê„ÅßÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ üòä`;
                } else if (stats.lastStreakBroken && stats.lastStreakBroken > 1) {
                    message += `<br>ÂâçÂõû„ÅÆÂ≠¶Áøí„Åã„Çâ <span style="color: #e74c3c; font-weight: bold;">${stats.lastStreakBroken}Êó•</span> Áµå„Å°„Åæ„Åó„Åü(„Åü„Å§)„ÄÇ<br>„Åæ„Åü‰∏ÄÁ∑í„Å´È†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ üò¢`;
                }
                
                return message;
            } catch (error) {
                console.error('Error formatting message:', error);
                return '„ÅäÂ∏∞„Çä„Å™„Åï„ÅÑÔºÅ (Welcome back!)';
            }
        }

        async function displayVisitStats() {
            const statsContainer = document.getElementById('visitStatsContainer');
            
            if (!statsContainer) {
                console.error('Visit stats container not found');
                return;
            }
            
            try {
                const stats = await calculateVisitStats();
                const message = formatVisitMessage(stats);
                statsContainer.innerHTML = message;
            } catch (error) {
                console.error('Error displaying visit stats:', error);
                statsContainer.innerHTML = '„Ç¢„ÇØ„Çª„ÇπÁµ±Ë®à„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ';
            }
        }

        function saveQuizResult(quizData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }
                const transaction = db.transaction(['quizHistory'], 'readwrite');
                const store = transaction.objectStore('quizHistory');
                
                quizData.id = Date.now();
                const request = store.put(quizData);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function loadQuizHistory() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }
                const transaction = db.transaction(['quizHistory'], 'readonly');
                const store = transaction.objectStore('quizHistory');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const results = request.result || [];
                    results.sort((a, b) => b.id - a.id);
                    resolve(results);
                };
                request.onerror = () => reject(request.error);
            });
        }

        function deleteQuizResult(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }
                const transaction = db.transaction(['quizHistory'], 'readwrite');
                const store = transaction.objectStore('quizHistory');
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function parseSimplifiedDatabase(text) {
            const sections = [];
            const lines = text.trim().split('\n');
            let currentSection = null;

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                if (line.startsWith('‚óé')) {
                    if (currentSection) {
                        sections.push(currentSection);
                    }
                    currentSection = {
                        section: line,
                        words: []
                    };
                } else if (line.includes('^') && currentSection) {
                    const [wordPart, examplePart] = line.split('^').map(s => s.trim());
                    currentSection.words.push({
                        word: wordPart + ':',
                        example: examplePart
                    });
                }
            }

            if (currentSection) {
                sections.push(currentSection);
            }

            return sections;
        }

        // ============ CUSTOM LIST FUNCTIONS ============
        let currentCustomMonth = null;
        let currentEditWeek = null;
        let currentEditDay = null;

        function saveCustomEntry(id, content) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['customLists'], 'readwrite');
                const store = transaction.objectStore('customLists');
                const request = store.put({ id: id, content: content });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function loadCustomEntry(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['customLists'], 'readonly');
                const store = transaction.objectStore('customLists');
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result ? request.result.content : '');
                request.onerror = () => reject(request.error);
            });
        }

        function deleteCustomEntry(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['customLists'], 'readwrite');
                const store = transaction.objectStore('customLists');
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function countCustomItems(content) {
            if (!content || !content.trim()) return 0;
            const parsed = parseSimplifiedDatabase(content);
            let count = 0;
            parsed.forEach(section => { count += section.words.length; });
            return count;
        }

        async function updateCustomUI(month) {
            const weeks = ['1', '2', '3', '4', 'backup'];
            for (const week of weeks) {
                let totalCount = 0;
                const dayCount = week === 'backup' ? 5 : 7;
                for (let day = 1; day <= dayCount; day++) {
                    const id = `m${month}_w${week}_d${day}`;
                    const content = await loadCustomEntry(id);
                    totalCount += countCustomItems(content);
                    
                    const btn = document.querySelector(`.day-btn[data-week="${week}"][data-day="${day}"]`);
                    if (btn) {
                        if (content && content.trim()) {
                            btn.classList.add('has-content');
                        } else {
                            btn.classList.remove('has-content');
                        }
                    }
                }
                
                const countEl = document.getElementById(`week${week}-count`);
                if (countEl) countEl.textContent = `${totalCount} ÂÄã`;
            }
        }

        async function clearCustomWeek(month, week) {
            const dayCount = week === 'backup' ? 5 : 7;
            for (let day = 1; day <= dayCount; day++) {
                await deleteCustomEntry(`m${month}_w${week}_d${day}`);
            }
            await updateCustomUI(month);
        }

        async function clearEntireMonth(month) {
            const weeks = ['1', '2', '3', '4', 'backup'];
            for (const week of weeks) {
                await clearCustomWeek(month, week);
            }
        }

        const vocabDatabaseRaw = {
            'b1l1': ``, 'b1l2': ``, 'b1l3': ``, 'b1l4': ``, 'b1l5': ``, 'b1l6': ``, 'b1l7': ``, 'b1l8': ``, 'b1l9': ``, 'b1l10': ``,
            'b2l1': ``, 'b2l2': ``, 'b2l3': ``, 'b2l4': ``, 'b2l5': ``, 'b2l6': ``, 'b2l7': ``, 'b2l8': ``, 'b2l9': ``, 'b2l10': ``,
            'b3l1': ``, 'b3l2': ``, 'b3l3': ``, 'b3l4': ``, 'b3l5': ``, 'b3l6': ``, 'b3l7': ``, 'b3l8': ``, 'b3l9': ``, 'b3l10': ``,
            'b4l1': ``, 'b4l2': ``, 'b4l3': ``, 'b4l4': ``, 'b4l5': ``, 'b4l6': ``, 'b4l7': ``, 'b4l8': ``, 'b4l9': ``, 'b4l10': ``,
            'backup': `  `
        };

        const vocabDatabase = {};
        for (const [key, value] of Object.entries(vocabDatabaseRaw)) {
            vocabDatabase[key] = parseSimplifiedDatabase(value);
        }

        const studyEmojis = ['üßë', 'üë±', 'üßî', 'üë®‚Äçü¶∞', 'üë©', 'üëß', 'üßí', 'üë±‚Äç‚ôÄÔ∏è', 'üëµ', 'üéÖ', 'üë∂', 'üë¥', 'üßì', 'üéÖüèø', 'ü§¥', 'üë∏', 'üôÜ', 'ü§∑‚Äç‚ôÇÔ∏è', 'üéÉ', 'üëª', 'üë∫', 'üßô', 'üóø', 'üëΩ', 'üí©', 'üê∂', 'üê±', 'üêµ', 'üê∑', 'üêÆ', 'üêØ', 'ü¶Å', 'üêª', 'ü¶ä', 'ü¶ù', 'üêπ', 'üê∞', 'üê®', 'üêº', 'ü§†', 'üòÇ', 'üòú'];
        let currentEmoji = 'üßë';
        let translationShown = false;

        let currentLessonData = null;
        let currentWordIndex = 0;
        let flatWordsList = [];
        let currentSpeech = null;
        let speechRate = 1.0;
        let voices = [];
        let voicesLoaded = false;
        let currentTTSSystem = 'android';
        let isCompleted = false;
        let checkedSections = new Set();

        let quizWords = [];
        let currentQuizIndex = 0;
        let quizScore = 0;
        let hasAnswered = false;
        let correctAnswer = null;
        let showEnglishInQuiz = false;
        let showEnglishTimeout = null;

        // ============ TTS FUNCTIONS ============
        function loadVoices() {
            return new Promise((resolve) => {
                voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    voicesLoaded = true;
                    console.log('Voices loaded:', voices.length);
                    resolve(voices);
                } else {
                    const utterance = new SpeechSynthesisUtterance('');
                    utterance.volume = 0;
                    speechSynthesis.speak(utterance);
                    setTimeout(() => {
                        voices = speechSynthesis.getVoices();
                        voicesLoaded = true;
                        console.log('Voices loaded after trigger:', voices.length);
                        resolve(voices);
                    }, 100);
                }
            });
        }

        function getJapaneseVoice() {
            if (!voicesLoaded || voices.length === 0) return null;

            const jpVoices = voices.filter(v => 
                v.lang === 'ja-JP' || 
                v.lang.startsWith('ja-') || 
                v.lang === 'ja'
            );

            if (currentTTSSystem === 'ios') {
                const iosJapaneseVoices = ['Kyoko', 'Otoya', 'Hattori', 'Siri'];
                for (const voiceName of iosJapaneseVoices) {
                    const voice = jpVoices.find(v => v.name.includes(voiceName));
                    if (voice) {
                        console.log('Using iOS Japanese voice:', voice.name);
                        return voice;
                    }
                }
                return jpVoices[0] || null;
            } else {
                const androidPreferredVoices = [
                    'ja-jp-x-jad-network', 
                    'ja-jp-x-jab-network', 
                    'Google Êó•Êú¨Ë™û',       
                    'ja-JP-language',
                    'Japanese'
                ];
                
                for (const voiceName of androidPreferredVoices) {
                    const voice = jpVoices.find(v =>
                        v.name.includes(voiceName) ||
                        v.name.toLowerCase().includes(voiceName.toLowerCase())
                    );
                    if (voice) {
                        console.log('Using Android Japanese voice:', voice.name);
                        return voice;
                    }
                }

                const googleVoice = jpVoices.find(v => v.name.includes('Google'));
                if (googleVoice) {
                    console.log('Using Google fallback voice:', googleVoice.name);
                    return googleVoice;
                }

                if (jpVoices.length > 0) {
                    console.log('Using generic Japanese fallback:', jpVoices[0].name);
                    return jpVoices[0];
                }
            }

            console.log('No Japanese voice found, falling back to system default');
            return voices[0] || null;
        }

        function speakText(text) {
            console.log('Speak function called with:', text, 'System:', currentTTSSystem);
            if (!('speechSynthesis' in window)) {
                console.warn('Speech synthesis not supported');
                return;
            }

            const cleanText = text
                .replace(/\([^)]*\)/g, '')   
                .replace(/\[[^\]]*\]/g, '')  
                .replace(/[*\/]/g, '')       
                .replace(/\s+/g, ' ')        
                .trim();

            if (!cleanText) return;

            stopSpeech(); 

            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(cleanText);
                
                utterance.lang = 'ja-JP';
                
                const preferredVoice = getJapaneseVoice();
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }

                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                if (currentTTSSystem === 'ios') {
                    utterance.rate = Math.max(0.5, speechRate * 0.9);
                } else {
                    utterance.rate = speechRate;
                }

                utterance.onstart = function() {
                    console.log('Speech started successfully');
                };

                utterance.onend = function() {
                    console.log('Speech ended normally');
                    currentSpeech = null;
                };

                utterance.onerror = function(event) {
                    console.error('Speech error:', event.error);
                    currentSpeech = null;
                };

                currentSpeech = utterance;
                
                try {
                    speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('Failed to start speech synthesis:', error);
                }
            }, 100);
        }

        function stopSpeech() {
            if (speechSynthesis.speaking || speechSynthesis.pending) {
                speechSynthesis.cancel();
            }
            currentSpeech = null;
        }

        async function initializeTTS() {
            console.log('Initializing TTS...');
            const testUtterance = new SpeechSynthesisUtterance('');
            testUtterance.volume = 0;
            speechSynthesis.speak(testUtterance);

            await new Promise(resolve => setTimeout(resolve, 200));
            await loadVoices();

            if (voices.length === 0) {
                console.log('No voices found, trying again...');
                await new Promise(resolve => setTimeout(resolve, 500));
                await loadVoices();
            }

            console.log('TTS initialization complete. Voices:', voices.length);

            speechSynthesis.addEventListener('voiceschanged', () => {
                console.log('Voices changed event fired');
                loadVoices();
            });
        }

        function getRandomEmoji() {
            return studyEmojis[Math.floor(Math.random() * studyEmojis.length)];
        }

        async function loadVocabulary(lessonKey) {
            const tableBody = document.getElementById('vocabTableBody');
            const data = vocabDatabase[lessonKey];

            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr class="no-data"><td colspan="2">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊõ¥Êñ∞„Çí„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ</td></tr>';
                document.getElementById('overallVocabSection').style.display = 'none';
                
                setTimeout(() => {
                    const vocabTable = document.getElementById('vocabTable');
                    if (vocabTable) {
                        vocabTable.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 50);
                
                return;
            }

            const savedCheckedWords = await loadCheckedWords(lessonKey);
            checkedSections.clear();

            let html = '';
            data.forEach((section, sectionIndex) => {
                html += `<tr><td colspan="2" class="section-header">${section.section}</td></tr>`;
                
                section.words.forEach((item, wordIndex) => {
                    const isChecked = !savedCheckedWords || savedCheckedWords[`${sectionIndex}_${wordIndex}`] !== false;
                    if (isChecked) {
                        const fullText = `${item.word}. ${item.example}`;
                        html += `<tr class="vocab-row">
                            <td class="audio-controls">
                                <button class="audio-btn play-btn" onclick="speakText('${fullText.replace(/'/g, "\\'")}')">üîä</button>
                                <button class="audio-btn stop-btn" onclick="stopSpeech()">‚èπ</button>
                            </td>
                            <td class="content-cell">
                                <div class="vocab-word">${item.word}</div>
                                <div class="example-sentence">${item.example}</div>
                            </td>
                        </tr>`;
                    }
                });
            });

            tableBody.innerHTML = html;
            showSectionSelector(data, lessonKey, savedCheckedWords);
            document.getElementById('overallVocabSection').style.display = 'block';
        }

        async function flattenLessonData(lessonData) {
            const selectedLesson = document.querySelector('.vocab-btn.active')?.getAttribute('data-lesson');
            const savedCheckedWords = await loadCheckedWords(selectedLesson);
            
            const flattened = [];
            lessonData.forEach((section, sectionIndex) => {
                section.words.forEach((word, wordIndex) => {
                    const isChecked = !savedCheckedWords || savedCheckedWords[`${sectionIndex}_${wordIndex}`] !== false;
                    if (isChecked) {
                        flattened.push({
                            ...word,
                            sectionIndex,
                            sectionTitle: section.section,
                            wordIndex
                        });
                    }
                });
            });
            return flattened;
        }

        async function showSectionSelector(lessonData, lessonKey, savedCheckedWords) {
            const selectorArea = document.getElementById('sectionSelectorArea');
            const connector = document.getElementById('quizConnector');
            const grid = document.getElementById('sectionCheckboxesGrid');
            
            grid.innerHTML = '';
            
            for (let sectionIndex = 0; sectionIndex < lessonData.length; sectionIndex++) {
                const section = lessonData[sectionIndex];
                let checkedCount = 0;
                section.words.forEach((word, wordIndex) => {
                    const isChecked = !savedCheckedWords || savedCheckedWords[`${sectionIndex}_${wordIndex}`] !== false;
                    if (isChecked) checkedCount++;
                });
                
                if (checkedCount > 0) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'section-checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `section_${lessonKey}_${sectionIndex}`;
                    checkbox.checked = checkedSections.has(sectionIndex);
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            checkedSections.add(sectionIndex);
                        } else {
                            checkedSections.delete(sectionIndex);
                        }
                    });
                    
                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = `${section.section} (${checkedCount} ÂÄã)`;
                    
                    itemDiv.appendChild(checkbox);
                    itemDiv.appendChild(label);
                    grid.appendChild(itemDiv);
                }
            }
            
            selectorArea.style.display = 'block';
            if (connector) connector.style.display = 'block';
        }

        async function getWordsFromCheckedSections(lessonData) {
            const selectedLesson = document.querySelector('.vocab-btn.active')?.getAttribute('data-lesson');
            const savedCheckedWords = await loadCheckedWords(selectedLesson);
            
            const allWords = [];
            lessonData.forEach((section, sectionIndex) => {
                if (checkedSections.has(sectionIndex)) {
                    section.words.forEach((word, wordIndex) => {
                        const isChecked = !savedCheckedWords || savedCheckedWords[`${sectionIndex}_${wordIndex}`] !== false;
                        if (isChecked) {
                            allWords.push({
                                ...word,
                                sectionIndex,
                                sectionTitle: section.section,
                                wordIndex
                            });
                        }
                    });
                }
            });
            return allWords;
        }

        function extractEnglishWordOnly(wordString) {
            return wordString.split('(')[0].trim().replace(':', '');
        }

        function extractEnglishExampleOnly(exampleString) {
            return exampleString.split('(')[0].trim();
        }

        function extractChineseWord(wordString) {
            const match = wordString.match(/\(([^)]+)\):/);
            return match ? match[1] : '';
        }

        function extractChineseExample(exampleString) {
            const match = exampleString.match(/\(([^)]+)\)/);
            return match ? match[1] : '';
        }

        function extractChineseTranslation(wordString) {
            const match = wordString.match(/\(([^)]+)\):/);
            return match ? match[1] : wordString;
        }

        function extractEnglishWord(wordString) {
            const match = wordString.match(/^(.+?)\s*\([^)]+\):/);
            return match ? match[1].trim() : wordString.split('(')[0].trim();
        }

        function extractExampleOnly(exampleString) {
            return exampleString.split('(')[0].trim();
        }

        async function startListenChooseQuiz() {
            const selectedLesson = document.querySelector('.vocab-btn.active')?.getAttribute('data-lesson');
            
            if (!selectedLesson || !vocabDatabase[selectedLesson] || vocabDatabase[selectedLesson].length === 0) {
                alert('„Åæ„ÅöÂçòË™û„Éá„Éº„Çø„ÅÆ„ÅÇ„Çã„É¨„ÉÉ„Çπ„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
                return;
            }

            const lessonData = vocabDatabase[selectedLesson];
            const allWords = await getWordsFromCheckedSections(lessonData);
            
            if (allWords.length < 8) {
                alert('„ÇØ„Ç§„Ç∫„Å´„ÅØÂ∞ë„Å™„Åè„Å®„ÇÇ8„Å§„ÅÆÂçòË™û„ÇíÂê´„ÇÄ„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            quizWords = shuffleArray([...allWords]).slice(0, 8);
            currentQuizIndex = 0;
            quizScore = 0;

            document.getElementById('listenChooseModal').style.display = 'block';
            loadQuizQuestion();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function loadQuizQuestion() {
            if (currentQuizIndex >= quizWords.length) {
                showQuizComplete();
                return;
            }

            if (showEnglishTimeout) {
                clearTimeout(showEnglishTimeout);
                showEnglishTimeout = null;
            }

            hasAnswered = false;
            correctAnswer = quizWords[currentQuizIndex];

            document.getElementById('listenAnswerDisplay').textContent = '„Çπ„Éî„Éº„Ç´„Éº„Çí„ÇØ„É™„ÉÉ„ÇØ';
            document.getElementById('timerFeedback').textContent = '';
            document.getElementById('timerFeedback').className = 'timer-feedback';
            document.getElementById('listenNextBtn').disabled = true;
            document.getElementById('listenNextBtn').style.display = 'inline-block';

            const toggleBtn = document.getElementById('toggleEnglishBtn');
            if (toggleBtn) {
                toggleBtn.textContent = showEnglishInQuiz ? 'Êó•Êú¨Ë™û„ÇíÈö†„Åô(„Åã„Åè„Åô 2)' : 'Êó•Êú¨Ë™û„ÇíË°®Á§∫';
                toggleBtn.style.backgroundColor = showEnglishInQuiz ? '#28a745' : '#6c757d';
            }

            displayChoices(shuffleArray([...quizWords]));
        }

        function displayChoices(choices) {
            const grid = document.getElementById('choicesGrid');
            grid.innerHTML = '';

            choices.forEach((choice) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = extractChineseTranslation(choice.word);
                btn.onclick = () => handleChoiceClick(choice, btn);
                grid.appendChild(btn);
            });
        }

        function handleChoiceClick(selectedChoice, btn) {
            if (hasAnswered) return;

            hasAnswered = true;
            const allChoices = document.querySelectorAll('.choice-btn');
            const correctChinese = extractChineseTranslation(correctAnswer.word);
            
            if (extractChineseTranslation(selectedChoice.word) === correctChinese) {
                btn.classList.add('correct');
                document.getElementById('timerFeedback').textContent = '‚úì Ê≠£Ëß£ÔºÅ';
                document.getElementById('timerFeedback').className = 'timer-feedback correct';
                quizScore++;
                
                setTimeout(() => speakText('Ê≠£Ëß£ÔºÅ'), 0);
            } else {
                btn.classList.add('incorrect');
                document.getElementById('timerFeedback').textContent = '‚úó ÈÅï„ÅÜ„ÇàÔºÅÊ≠£Ëß£„ÅØÔºö' + correctChinese;
                document.getElementById('timerFeedback').className = 'timer-feedback incorrect';
                
                allChoices.forEach(choiceBtn => {
                    if (choiceBtn.textContent === correctChinese) {
                        choiceBtn.classList.add('correct');
                    }
                });
                
                setTimeout(() => speakText('ÈÅï„ÅÜ„ÇàÔºÅ'), 0);
            }

            allChoices.forEach(choiceBtn => {
                choiceBtn.disabled = true;
            });

            const englishWord = extractEnglishWord(correctAnswer.word);
            const exampleOnly = extractExampleOnly(correctAnswer.example);
            document.getElementById('listenAnswerDisplay').innerHTML = 
                `<strong>${englishWord}</strong><br><span style="font-size: 18px;">${exampleOnly}</span>`;

            document.getElementById('listenNextBtn').disabled = false;
        }

        function playQuizAudio() {
            if (correctAnswer) {
                const englishWord = extractEnglishWord(correctAnswer.word);
                const exampleOnly = extractExampleOnly(correctAnswer.example);
                const fullText = `${englishWord}. ${exampleOnly}`;
                speakText(fullText);
                
                if (showEnglishTimeout) {
                    clearTimeout(showEnglishTimeout);
                    showEnglishTimeout = null;
                }
                
                if (showEnglishInQuiz && !hasAnswered) {
                    showEnglishTimeout = setTimeout(() => {
                        if (!hasAnswered && correctAnswer === quizWords[currentQuizIndex]) {
                            document.getElementById('listenAnswerDisplay').innerHTML = 
                                `<strong>${englishWord}</strong><br><span style="font-size: 18px;">${exampleOnly}</span>`;
                        }
                        showEnglishTimeout = null;
                    }, 4000);
                }
            }
        }

        function toggleEnglishDisplay() {
            showEnglishInQuiz = !showEnglishInQuiz;
            const toggleBtn = document.getElementById('toggleEnglishBtn');
            
            if (toggleBtn) {
                toggleBtn.textContent = showEnglishInQuiz ? 'Êó•Êú¨Ë™û„ÇíÈö†„Åô(„Åã„Åè„Åô 2)' : 'Êó•Êú¨Ë™û„ÇíË°®Á§∫';
                toggleBtn.style.backgroundColor = showEnglishInQuiz ? '#28a745' : '#6c757d';
            }
            
            if (!showEnglishInQuiz && !hasAnswered) {
                document.getElementById('listenAnswerDisplay').textContent = '„Çπ„Éî„Éº„Ç´„Éº„Çí„ÇØ„É™„ÉÉ„ÇØ';
            }
        }

        function nextQuizQuestion() {
            currentQuizIndex++;
            loadQuizQuestion();
        }

        async function showQuizComplete() {
            const grid = document.getElementById('choicesGrid');
            const percentage = Math.round((quizScore / quizWords.length) * 100);
            
            const selectedLesson = document.querySelector('.vocab-btn.active')?.getAttribute('data-lesson');
            const lessonName = document.querySelector('.vocab-btn.active')?.textContent || 'Unknown';

            const selectedButton = document.querySelector('.vocab-btn.active');
            let categoryName = 'Unknown Category';
            
            if (selectedButton) {
                const categoryDiv = selectedButton.closest('.category');
                if (categoryDiv) {
                    const categoryTitle = categoryDiv.querySelector('.category-title');
                    if (categoryTitle && categoryTitle.textContent) {
                        categoryName = categoryTitle.textContent.trim();
                    }
                }
            }
            
            const sectionNames = [...checkedSections].map(index => {
                const lessonData = vocabDatabase[selectedLesson];
                return lessonData[index]?.section || `Section ${index + 1}`;
            });
            
            const quizData = {
                date: new Date().toISOString(),
                lessonKey: selectedLesson,
                categoryName: categoryName,  
                lessonName: lessonName.trim(),
                sections: sectionNames,
                score: quizScore,
                total: quizWords.length,
                percentage: percentage
            };
            
            try {
                await saveQuizResult(quizData);
            } catch (error) {
                console.error('Failed to save quiz result:', error);
            }
            
            grid.innerHTML = `
                <div class="quiz-complete">
                    <h3>üéâ „ÇØ„Ç§„Ç∫ÂÆå‰∫ÜÔºÅ</h3>
                    <div class="quiz-score">
                        „ÅÇ„Å™„Åü„ÅÆ„Çπ„Ç≥„Ç¢Ôºö<strong>${quizScore} / ${quizWords.length} (${percentage}%)</strong>
                    </div>
                    <button class="restart-quiz-btn" onclick="restartQuiz()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åô„Çã</button>
                </div>
            `;

            document.getElementById('listenAnswerDisplay').textContent = '„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ';
            document.getElementById('timerFeedback').textContent = '';
            document.getElementById('listenNextBtn').style.display = 'none';
        }

        function restartQuiz() {
            document.getElementById('listenNextBtn').style.display = 'inline-block';
            showEnglishInQuiz = false;  
            startListenChooseQuiz();
        }

        function closeQuizModal() {
            if (showEnglishTimeout) {
                clearTimeout(showEnglishTimeout);
                showEnglishTimeout = null;
            }
            
            document.getElementById('listenChooseModal').style.display = 'none';
            stopSpeech();
            showEnglishInQuiz = false;  
            
            const toggleBtn = document.getElementById('toggleEnglishBtn');
            if (toggleBtn) {
                toggleBtn.textContent = 'Êó•Êú¨Ë™û„ÇíË°®Á§∫';
                toggleBtn.style.backgroundColor = '#6c757d';
            }
        }

        function openOverallVocabModal() {
            const selectedLesson = document.querySelector('.vocab-btn.active')?.getAttribute('data-lesson');
            
            if (!selectedLesson || !vocabDatabase[selectedLesson] || vocabDatabase[selectedLesson].length === 0) {
                alert('„Åæ„ÅöÂçòË™û„Éá„Éº„Çø„ÅÆ„ÅÇ„Çã„É¨„ÉÉ„Çπ„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
                return;
            }
            
            populateOverallVocabList(selectedLesson);
            document.getElementById('overallVocabModal').style.display = 'block';
        }

        async function populateOverallVocabList(lessonKey) {
            const lessonData = vocabDatabase[lessonKey];
            const listContainer = document.getElementById('overallVocabList');
            
            const savedCheckedWords = await loadCheckedWords(lessonKey);
            
            let html = '';
            
            lessonData.forEach((section, sectionIndex) => {
                const sectionId = `section_${lessonKey}_${sectionIndex}`;
                
                let checkedCount = 0;
                section.words.forEach((word, wordIndex) => {
                    const isChecked = !savedCheckedWords || savedCheckedWords[`${sectionIndex}_${wordIndex}`] !== false;
                    if (isChecked) checkedCount++;
                });
                
                html += `<div class="vocab-section-block">
                    <div class="section-title-row">
                        <input type="checkbox" id="${sectionId}_all" class="section-checkbox-all" 
                               data-section-index="${sectionIndex}" checked>
                        <label for="${sectionId}_all">${section.section} <span class="section-count" id="count_${sectionIndex}">(${checkedCount} ÂÄãÈÅ∏ÊäûÊ∏à„ÅøÔºè„Åô„Åø 1)</span></label>
                    </div>
                    <div class="vocab-items-grid">`;
                    
                section.words.forEach((word, wordIndex) => {
                    const wordId = `word_${lessonKey}_${sectionIndex}_${wordIndex}`;
                    const displayText = word.word.replace(/:$/, '');  
                    
                    const isChecked = !savedCheckedWords || savedCheckedWords[`${sectionIndex}_${wordIndex}`] !== false;
                    
                    html += `<div class="vocab-item-row">
                        <input type="checkbox" id="${wordId}" class="word-checkbox" 
                               data-section-index="${sectionIndex}" 
                               data-word-index="${wordIndex}" 
                               ${isChecked ? 'checked' : ''}>
                        <label for="${wordId}">${displayText}</label>  
                    </div>`;
                });
                
                html += `</div></div>`;
            });
            
            listContainer.innerHTML = html;
            attachOverallVocabListeners(lessonKey);
        }

        function attachOverallVocabListeners(lessonKey) {
            document.querySelectorAll('.section-checkbox-all').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const sectionIndex = this.getAttribute('data-section-index');
                    const wordCheckboxes = document.querySelectorAll(`.word-checkbox[data-section-index="${sectionIndex}"]`);
                    wordCheckboxes.forEach(cb => cb.checked = this.checked);
                    updateSectionCheckbox(sectionIndex);
                });
            });
            
            document.querySelectorAll('.word-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSectionCheckbox(this.getAttribute('data-section-index'));
                });
            });
            
            document.querySelectorAll('.section-checkbox-all').forEach(checkbox => {
                updateSectionCheckbox(checkbox.getAttribute('data-section-index'));
            });
        }

        function updateSectionCheckbox(sectionIndex) {
            const wordCheckboxes = document.querySelectorAll(`.word-checkbox[data-section-index="${sectionIndex}"]`);
            const sectionCheckbox = document.querySelector(`.section-checkbox-all[data-section-index="${sectionIndex}"]`);
            
            const allChecked = Array.from(wordCheckboxes).every(cb => cb.checked);
            const noneChecked = Array.from(wordCheckboxes).every(cb => !cb.checked);
            
            sectionCheckbox.checked = allChecked;
            sectionCheckbox.indeterminate = !allChecked && !noneChecked;
            
            const checkedCount = Array.from(wordCheckboxes).filter(cb => cb.checked).length;
            const countSpan = document.getElementById(`count_${sectionIndex}`);
            if (countSpan) {
                countSpan.textContent = `(${checkedCount} ÂÄãÈÅ∏ÊäûÊ∏à„ÅøÔºè„Åô„Åø 1)`;
            }
        }

        async function saveOverallVocabState() {
            const selectedLesson = document.querySelector('.vocab-btn.active')?.getAttribute('data-lesson');
            if (!selectedLesson) return;
            
            const checkedWords = {};
            document.querySelectorAll('.word-checkbox').forEach(checkbox => {
                const sectionIndex = checkbox.getAttribute('data-section-index');
                const wordIndex = checkbox.getAttribute('data-word-index');
                const key = `${sectionIndex}_${wordIndex}`;
                checkedWords[key] = checkbox.checked;
            });
            
            try {
                await saveCheckedWords(selectedLesson, checkedWords);
                alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                document.getElementById('overallVocabModal').style.display = 'none';
                loadVocabulary(selectedLesson);
            } catch (error) {
                console.error('Error saving:', error);
                alert('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }

        function updateStudySession() {
            if (!currentLessonData || !flatWordsList.length) {
                document.getElementById('currentWord').textContent = '„Åæ„Åö„É¨„ÉÉ„Çπ„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ';
                document.getElementById('currentExample').textContent = 'Â≠¶Áøí„ÇíÂßã„ÇÅ„ÇãÂâç„Å´„ÄÅ„É°„Ç§„É≥„Éö„Éº„Ç∏„Åã„Çâ„É¨„ÉÉ„Çπ„É≥„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ';
                document.getElementById('progressInfo').textContent = 'Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ';
                return;
            }

            if (isCompleted) {
                restoreNormalInterface();
            }

            const currentItem = flatWordsList[currentWordIndex];
            if (!currentItem) return;

            if (!translationShown) {
                currentEmoji = getRandomEmoji();
            }

            const avatarElement = document.getElementById('currentPartnerAvatar');
            if (avatarElement) {
                avatarElement.textContent = currentEmoji;
            }

            const englishWord = extractEnglishWordOnly(currentItem.word);
            const englishExample = extractEnglishExampleOnly(currentItem.example);

            const questionPrompt = document.getElementById('questionPrompt');
            if (questionPrompt) {
                questionPrompt.textContent = translationShown ? 'Ê≠£Ëß£„Åó„Åæ„Åó„Åü„ÅãÔºü' : '„Å©„ÅÜ„ÅÑ„ÅÜÊÑèÂë≥„Åß„Åô„ÅãÔºü';
            }

            document.getElementById('currentWord').textContent = englishWord;
            document.getElementById('currentExample').textContent = englishExample;

            const chineseWord = extractChineseWord(currentItem.word);
            const chineseExample = extractChineseExample(currentItem.example);
            document.getElementById('currentWord').setAttribute('data-chinese', chineseWord);
            document.getElementById('currentExample').setAttribute('data-chinese', chineseExample);

            const translationDiv = document.getElementById('translationText');
            const translateBtn = document.getElementById('showTranslationBtn');
            
            if (translationDiv) {
                if (translationShown) {
                    translationDiv.classList.add('show');
                } else {
                    translationDiv.classList.remove('show');
                }
                translationDiv.innerHTML = `
                    <div class="translation-label">üåê ÁøªË®≥:</div>
                    <div><strong>${chineseWord}</strong></div>
                    <div>${chineseExample}</div>
                `;
            }
            
            if (translateBtn) {
                translateBtn.disabled = translationShown;
                translateBtn.style.cursor = translationShown ? 'not-allowed' : 'pointer';
            }

            const totalWords = flatWordsList.length;
            const progressText = `ÂçòË™û ${currentWordIndex + 1} / ${totalWords} ‚Ä¢ ${currentItem.sectionTitle}`;
            document.getElementById('progressInfo').textContent = progressText;

            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            const backBtn = document.getElementById('backBtn');
            const nextBtn = document.getElementById('nextBtn');
            const nextSectionBtn = document.getElementById('studyModalNextSectionBtn');

            if (!flatWordsList.length) return;

            const totalWords = flatWordsList.length;
            const currentItem = flatWordsList[currentWordIndex];

            backBtn.disabled = currentWordIndex === 0;
            nextBtn.disabled = currentWordIndex === totalWords - 1;

            const isLastSection = currentItem && currentItem.sectionIndex === Math.max(...flatWordsList.map(item => item.sectionIndex));
            nextSectionBtn.disabled = isLastSection;
        }

        function restoreNormalInterface() {
            const speechBubble = document.getElementById('speechBubble');
            const questionPrompt = document.getElementById('questionPrompt');
            const currentItem = flatWordsList[currentWordIndex];

            if (currentItem) {
                const englishWord = extractEnglishWordOnly(currentItem.word);
                const englishExample = extractEnglishExampleOnly(currentItem.example);
                const chineseWord = extractChineseWord(currentItem.word);
                const chineseExample = extractChineseExample(currentItem.example);
                
                if (questionPrompt) {
                    questionPrompt.textContent = '„Å©„ÅÜ„ÅÑ„ÅÜÊÑèÂë≥„Åß„Åô„ÅãÔºü';
                }
                
                speechBubble.innerHTML = `
                    <div class="current-word" id="currentWord" data-chinese="${chineseWord}">${englishWord}</div>
                    <div class="current-example" id="currentExample" data-chinese="${chineseExample}">${englishExample}</div>
                    <div class="bubble-controls">
                        <button class="bubble-btn play-btn" id="speakCurrentBtn" title="Play Audio">üîä</button>
                        <button class="bubble-btn stop-btn" id="stopCurrentBtn" title="Stop">‚èπ</button>
                        <button class="bubble-btn translate-btn" id="showTranslationBtn" title="Show Translation">üÄÑ</button>
                    </div>
                    <div class="translation-text" id="translationText">
                        <div class="translation-label">üåê ÁøªË®≥Ôºö</div>
                        <div><strong>${chineseWord}</strong></div>
                        <div>${chineseExample}</div>
                    </div>`;

                attachBubbleEventListeners();
            }

            isCompleted = false;
        }

        function attachBubbleEventListeners() {
            const speakBtn = document.getElementById('speakCurrentBtn');
            const stopBtn = document.getElementById('stopCurrentBtn');
            const translateBtn = document.getElementById('showTranslationBtn');

            if (speakBtn) speakBtn.addEventListener('click', handleSpeakCurrent);
            if (stopBtn) stopBtn.addEventListener('click', stopSpeech);
            if (translateBtn) translateBtn.addEventListener('click', toggleTranslation);
        }

        function handleSpeakCurrent() {
            const currentItem = flatWordsList[currentWordIndex];
            if (currentItem) {
                const fullText = `${currentItem.word}. ${currentItem.example}`;
                speakText(fullText);
            }
        }

        function toggleTranslation() {
            const translationDiv = document.getElementById('translationText');
            const translateBtn = document.getElementById('showTranslationBtn');
            const questionPrompt = document.getElementById('questionPrompt');
            
            if (translationDiv && !translationDiv.classList.contains('show')) {
                translationDiv.classList.add('show');
                translationShown = true;
                
                if (questionPrompt) {
                    questionPrompt.textContent = 'Ê≠£Ëß£„Åó„Åæ„Åó„Åü„ÅãÔºü';
                }
                
                if (translateBtn) {
                    translateBtn.disabled = true;
                    translateBtn.style.cursor = 'not-allowed';
                }
            }
        }

        function showCongratulations() {
            const message = `Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅÂçòË™û„É™„Çπ„Éà„Çí„Åô„Åπ„Å¶ÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ„Çà„ÅèÈ†ëÂºµ„Çä„Åæ„Åó„Åü„Å≠ÔºÅ`;

            const speechBubble = document.getElementById('speechBubble');
            speechBubble.innerHTML = `<div class="congratulations">
                    <h3>„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ</h3>
                    <p>${message}</p>
                </div>
                <div class="bubble-controls">
                    <button class="bubble-btn play-btn" id="congratsPlayBtn">üîä</button>
                    <button class="bubble-btn stop-btn" id="congratsStopBtn">‚èπ</button>
                    <button class="bubble-btn learn-again-btn" id="learnAgainBtn">üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åô„Çã</button>
                </div>`;

            document.getElementById('congratsPlayBtn').addEventListener('click', () => speakText(message));
            document.getElementById('congratsStopBtn').addEventListener('click', stopSpeech);
            document.getElementById('learnAgainBtn').addEventListener('click', restartLesson);

            setTimeout(() => speakText(message), 500);

            document.getElementById('progressInfo').textContent = '„É¨„ÉÉ„Çπ„É≥ÂÆå‰∫ÜÔºÅ';
            isCompleted = true;
            updateNavigationButtons();
        }

        function checkCompletion() {
            if (currentWordIndex >= flatWordsList.length && !isCompleted) {
                showCongratulations();
                currentWordIndex = flatWordsList.length - 1;
            }
        }

        function nextWord() {
            translationShown = false;
            if (currentWordIndex < flatWordsList.length - 1) {
                currentWordIndex++;
                updateStudySession();
            } else if (currentWordIndex === flatWordsList.length - 1) {
                currentWordIndex++;
                checkCompletion();
            }
        }

        function previousWord() {
            translationShown = false;
            if (currentWordIndex > 0) {
                currentWordIndex--;
                if (isCompleted) {
                    isCompleted = false;
                }
                updateStudySession();
            }
        }

        function goToNextSection() {
            translationShown = false;
            const currentItem = flatWordsList[currentWordIndex];
            if (!currentItem) return;
            
            const currentSectionIndex = currentItem.sectionIndex;
            const nextSectionFirstWord = flatWordsList.find(item => item.sectionIndex > currentSectionIndex);
            
            if (nextSectionFirstWord) {
                currentWordIndex = flatWordsList.indexOf(nextSectionFirstWord);
                updateStudySession();
                checkCompletion();
            }
        }

        function restartLesson() {
            currentWordIndex = 0;
            isCompleted = false;
            translationShown = false;  
            updateStudySession();
        }

        async function startStudySession() {
            const selectedLesson = document.querySelector('.vocab-btn.active')?.getAttribute('data-lesson');
            
            if (!selectedLesson || !vocabDatabase[selectedLesson] || vocabDatabase[selectedLesson].length === 0) {
                alert('„Åæ„ÅöÂçòË™û„Éá„Éº„Çø„ÅÆ„ÅÇ„Çã„É¨„ÉÉ„Çπ„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ');
                return;
            }

            currentLessonData = vocabDatabase[selectedLesson];
            flatWordsList = await flattenLessonData(currentLessonData);
            currentWordIndex = 0;
            isCompleted = false;
            translationShown = false;
            currentEmoji = getRandomEmoji();

            document.getElementById('studyModal').style.display = 'block';
            updateStudySession();
        }

        function handleFloatingButtons() {
            const backToTopBtn = document.getElementById('backToTopBtn');
            const floatingPrevSectionBtn = document.getElementById('floatingPrevSectionBtn');
            const floatingNextSectionBtn = document.getElementById('floatingNextSectionBtn');
            const buttonCategories = document.querySelector('.button-categories');
            
            if (!backToTopBtn || !floatingPrevSectionBtn || !floatingNextSectionBtn || !buttonCategories) return;
            
            const buttonCategoriesBottom = buttonCategories.offsetTop + buttonCategories.offsetHeight;
            
            if (window.scrollY > buttonCategoriesBottom + 100) {
                backToTopBtn.classList.add('show');
                floatingPrevSectionBtn.classList.add('show');
                floatingNextSectionBtn.classList.add('show');
            } else {
                backToTopBtn.classList.remove('show');
                floatingPrevSectionBtn.classList.remove('show');
                floatingNextSectionBtn.classList.remove('show');
            }
        }

        function scrollToTop() {
            const buttonCategories = document.querySelector('.button-categories');
            if (buttonCategories) {
                buttonCategories.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function scrollToNextSection() {
            const sectionHeaders = document.querySelectorAll('.section-header');
            if (sectionHeaders.length === 0) return;
            
            const viewportTop = window.pageYOffset || document.documentElement.scrollTop;
            const isMobile = window.innerWidth <= 768;
            const buffer = isMobile ? 100 : 150;
            const referencePoint = viewportTop + (window.innerHeight / 3);
            
            for (let i = 0; i < sectionHeaders.length; i++) {
                const rect = sectionHeaders[i].getBoundingClientRect();
                const absoluteTop = rect.top + viewportTop;
                
                if (absoluteTop > referencePoint + buffer) {
                    const offset = isMobile ? 10 : 20;
                    window.scrollTo({ top: absoluteTop - offset, behavior: 'smooth' });
                    return;
                }
            }
            window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
        }

        function scrollToPrevSection() {
            const sectionHeaders = document.querySelectorAll('.section-header');
            if (sectionHeaders.length === 0) return;
            
            const viewportTop = window.pageYOffset || document.documentElement.scrollTop;
            const isMobile = window.innerWidth <= 768;
            const buffer = isMobile ? 80 : 100;
            const referencePoint = viewportTop + (window.innerHeight / 3);
            
            const sectionsWithPositions = Array.from(sectionHeaders).map((header, index) => {
                const rect = header.getBoundingClientRect();
                const absoluteTop = rect.top + viewportTop;
                return { header, absoluteTop, index };
            });
            
            let currentSectionIndex = -1;
            for (let i = sectionsWithPositions.length - 1; i >= 0; i--) {
                if (sectionsWithPositions[i].absoluteTop < referencePoint - buffer) {
                    currentSectionIndex = i;
                    break;
                }
            }
            
            if (currentSectionIndex > 0) {
                const targetSection = sectionsWithPositions[currentSectionIndex - 1];
                const offset = isMobile ? 10 : 20;
                window.scrollTo({ top: targetSection.absoluteTop - offset, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        async function openQuizHistoryModal() {
            try {
                const history = await loadQuizHistory();
                displayQuizHistory(history);
                document.getElementById('quizHistoryModal').style.display = 'block';
            } catch (error) {
                console.error('Failed to load quiz history:', error);
                alert('„ÇØ„Ç§„Ç∫Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }

        function displayQuizHistory(history) {
            const listContainer = document.getElementById('quizHistoryList');
            
            if (!history || history.length === 0) {
                listContainer.innerHTML = '<div class="no-quiz-history">„ÇØ„Ç§„Ç∫Â±•Ê≠¥„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„ÇØ„Ç§„Ç∫„ÇíÂÆå‰∫Ü„Åô„Çã„Å®„Åì„Åì„Å´ÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Åæ„ÅôÔºÅ</div>';
                return;
            }
            
            let html = '';
            history.forEach(item => {
                const date = new Date(item.date);
                const dateStr = date.toLocaleDateString('ja-JP', { 
                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                
                const percentage = item.percentage || Math.round((item.score / item.total) * 100);
                let scoreClass = 'needs-improvement';
                let scoreEmoji = 'üòì';  
                if (percentage >= 90) {
                    scoreClass = 'excellent';
                    scoreEmoji = 'üòÑ';  
                } else if (percentage >= 70) {
                    scoreClass = 'good';
                    scoreEmoji = 'üôÇ';  
                }
                
                const sectionsText = item.sections && item.sections.length > 0 ? item.sections.join(', ') : '„Åô„Åπ„Å¶„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥';
                
                html += `
                    <div class="quiz-history-item">
                        <div class="quiz-history-date">üìÖ ${dateStr}</div>
                        <div class="quiz-history-category">${item.categoryName || '‰∏çÊòé„Å™„Ç´„ÉÜ„Ç¥„É™„Éº'}</div>
                        <div class="quiz-history-lesson">${item.lessonName}</div>
                        <div class="quiz-history-sections"><strong>„Çª„ÇØ„Ç∑„Éß„É≥:</strong> ${sectionsText}</div>
                        <div class="quiz-history-score ${scoreClass}">
                            „Çπ„Ç≥„Ç¢Ôºö${item.score}/${item.total} (${percentage}%) ${scoreEmoji}
                        </div>
                        <button class="quiz-history-delete" onclick="deleteQuizItem(${item.id})">üóëÔ∏è</button>
                        <div style="clear: both;"></div>
                    </div>`;
            });
            listContainer.innerHTML = html;
        }

        async function deleteQuizItem(id) {
            if (!confirm('„Åì„ÅÆ„ÇØ„Ç§„Ç∫„ÅÆÁµêÊûú„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                return;
            }
            try {
                await deleteQuizResult(id);
                const history = await loadQuizHistory();
                displayQuizHistory(history);
            } catch (error) {
                console.error('Failed to delete quiz result:', error);
                alert('„ÇØ„Ç§„Ç∫ÁµêÊûú„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }

        async function clearAllQuizHistory() {
            if (!confirm('„Åô„Åπ„Å¶„ÅÆ„ÇØ„Ç§„Ç∫Â±•Ê≠¥„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                return;
            }
            try {
                const history = await loadQuizHistory();
                for (const item of history) {
                    await deleteQuizResult(item.id);
                }
                displayQuizHistory([]);
                alert('„Åô„Åπ„Å¶„ÅÆ„ÇØ„Ç§„Ç∫Â±•Ê≠¥„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ');
            } catch (error) {
                console.error('Failed to clear quiz history:', error);
                alert('„ÇØ„Ç§„Ç∫Â±•Ê≠¥„ÅÆÊ∂àÂéª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }

        function initializeEventListeners() {
            const ttsSystemSelect = document.getElementById('tts-system');
            if (ttsSystemSelect) {
                ttsSystemSelect.addEventListener('change', (e) => {
                    currentTTSSystem = e.target.value;
                    console.log(`Switched to ${currentTTSSystem} TTS system`);
                    loadVoices().then(() => {
                        console.log(`Voice loading complete for ${currentTTSSystem}`);
                    });
                });
            }

            document.addEventListener('click', function initOnFirstClick() {
                initializeTTS();
                document.removeEventListener('click', initOnFirstClick);
            }, { once: true });

            document.querySelectorAll('.monthly-custom-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    currentCustomMonth = btn.getAttribute('data-month');
                    document.getElementById('monthly-modal-title').textContent = `üóìÔ∏è ${currentCustomMonth}„É∂ÊúàÁõÆ`;
                    await updateCustomUI(currentCustomMonth);
                    document.getElementById('monthly-modal').style.display = 'block';
                });
            });

            document.getElementById('monthly-close-btn').addEventListener('click', () => {
                document.getElementById('monthly-modal').style.display = 'none';
            });

            document.getElementById('monthly-clear-all-btn').addEventListener('click', async () => {
                if (confirm(`${currentCustomMonth}„É∂ÊúàÁõÆ„ÅÆ„Éá„Éº„Çø„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`)) {
                    await clearEntireMonth(currentCustomMonth);
                }
            });

            document.querySelectorAll('.clear-week-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const week = btn.dataset.week;
                    if (confirm(`Á¨¨ ${week} ÈÄ±„ÅÆ„Éá„Éº„Çø„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                        await clearCustomWeek(currentCustomMonth, week);
                    }
                });
            });

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    currentEditWeek = btn.dataset.week;
                    currentEditDay = btn.dataset.day;
                    const id = `m${currentCustomMonth}_w${currentEditWeek}_d${currentEditDay}`;
                    const content = await loadCustomEntry(id);
                    
                    document.getElementById('edit-entry-content').value = content;
                    document.getElementById('monthly-modal').style.display = 'none';
                    document.getElementById('edit-entry-modal').style.display = 'block';
                });
            });

            document.getElementById('edit-cancel-btn').addEventListener('click', () => {
                document.getElementById('edit-entry-modal').style.display = 'none';
                document.getElementById('monthly-modal').style.display = 'block';
            });

            document.getElementById('edit-clear-btn').addEventListener('click', () => {
                if (confirm('„Åì„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Éú„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                    document.getElementById('edit-entry-content').value = '';
                }
            });

            document.getElementById('edit-save-btn').addEventListener('click', async () => {
                const content = document.getElementById('edit-entry-content').value;
                const id = `m${currentCustomMonth}_w${currentEditWeek}_d${currentEditDay}`;
                await saveCustomEntry(id, content);
                await updateCustomUI(currentCustomMonth);
                
                document.getElementById('edit-entry-modal').style.display = 'none';
                document.getElementById('monthly-modal').style.display = 'block';
            });

            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const week = btn.dataset.week;
                    const day = btn.dataset.day;
                    const id = `m${currentCustomMonth}_w${week}_d${day}`;
                    const content = await loadCustomEntry(id);
                    
                    if (content && content.trim()) {
                        document.querySelectorAll('.vocab-btn').forEach(b => b.classList.remove('active'));
                        const hiddenBtn = document.getElementById('hidden-custom-btn');
                        hiddenBtn.classList.add('active');
                        hiddenBtn.setAttribute('data-lesson', id);
                        hiddenBtn.textContent = `${currentCustomMonth}„É∂ÊúàÁõÆ - W${week} D${day}`;
                        
                        vocabDatabase[id] = parseSimplifiedDatabase(content);
                        loadVocabulary(id);
                        document.getElementById('monthly-modal').style.display = 'none';
                        
                        setTimeout(() => {
                            const overallVocabSection = document.getElementById('overallVocabSection');
                            if (overallVocabSection && overallVocabSection.style.display !== 'none') {
                                overallVocabSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 50);
                    } else {
                        alert('„Åì„ÅÆ„Ç®„É≥„Éà„É™„Éº„ÅØÁ©∫„Åß„Åô„ÄÇÂÖà„Å´„ÄåÁ∑®ÈõÜ„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÂÜÖÂÆπ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    }
                });
            });

            const editAiLinkBtn = document.getElementById('edit-ai-link-btn');
            if (editAiLinkBtn) {
                editAiLinkBtn.addEventListener('click', () => {
                    window.open('https://chatgpt.com/share/69981cae-c300-800a-a546-58ca98d39f99', '_blank');
                });
            }

            const lessonButtons = document.querySelectorAll('.vocab-btn');
            lessonButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    lessonButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const lessonKey = this.getAttribute('data-lesson');
                    loadVocabulary(lessonKey);
                    
                    setTimeout(() => {
                        const overallVocabSection = document.getElementById('overallVocabSection');
                        if (overallVocabSection && overallVocabSection.style.display !== 'none') {
                            overallVocabSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 50);
                });
            });

            const speedButtons = document.querySelectorAll('.speed-btn');
            speedButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    speedButtons.forEach(b => b.classList.remove('active-speed'));
                    this.classList.add('active-speed');
                    speechRate = parseFloat(this.getAttribute('data-speed'));
                    stopSpeech();
                });
            });

            document.getElementById('listenChooseBtn').addEventListener('click', startListenChooseQuiz);
            document.getElementById('listenSpeaker').addEventListener('click', playQuizAudio);
            document.getElementById('listenNextBtn').addEventListener('click', nextQuizQuestion);
            document.getElementById('listenCloseBtn').addEventListener('click', closeQuizModal);
            document.getElementById('closeListenChoose').addEventListener('click', closeQuizModal);
            document.getElementById('toggleEnglishBtn').addEventListener('click', toggleEnglishDisplay);

            const walkMeThruBtn = document.getElementById('walkMeThruBtn');
            const studyModal = document.getElementById('studyModal');

            walkMeThruBtn.addEventListener('click', () => {
                startStudySession();
            });

            document.getElementById('closeStudyModal').addEventListener('click', () => {
                studyModal.style.display = 'none';
                stopSpeech();
            });

            document.getElementById('nextBtn').addEventListener('click', nextWord);
            document.getElementById('backBtn').addEventListener('click', previousWord);
            document.getElementById('studyModalNextSectionBtn').addEventListener('click', goToNextSection);

            attachBubbleEventListeners();
            
            document.getElementById('overallVocabBtn').addEventListener('click', openOverallVocabModal);
            document.getElementById('saveVocabBtn').addEventListener('click', saveOverallVocabState);
            document.getElementById('closeOverallVocabBtn').addEventListener('click', () => {
                document.getElementById('overallVocabModal').style.display = 'none';
            });

            document.getElementById('quizHistoryBtn').addEventListener('click', openQuizHistoryModal);
            document.getElementById('closeQuizHistoryBtn').addEventListener('click', () => {
                document.getElementById('quizHistoryModal').style.display = 'none';
            });
            document.getElementById('clearHistoryBtn').addEventListener('click', clearAllQuizHistory);

            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('quizHistoryModal')) {
                    document.getElementById('quizHistoryModal').style.display = 'none';
                }
                if (e.target === studyModal) {
                    studyModal.style.display = 'none';
                    stopSpeech();
                }
                if (e.target === document.getElementById('listenChooseModal')) {
                    closeQuizModal();
                }
                if (e.target === document.getElementById('overallVocabModal')) {
                    document.getElementById('overallVocabModal').style.display = 'none';
                }
            });

            initDB().catch(error => {
                console.error('Failed to initialize database:', error);
            });

            window.addEventListener('beforeunload', () => stopSpeech());

            document.addEventListener('keydown', handleKeyboardNavigation);
            
            const backToTopBtn = document.getElementById('backToTopBtn');
            const floatingPrevSectionBtn = document.getElementById('floatingPrevSectionBtn');
            const floatingNextSectionBtn = document.getElementById('floatingNextSectionBtn');
            
            if (backToTopBtn) backToTopBtn.addEventListener('click', scrollToTop);
            if (floatingPrevSectionBtn) floatingPrevSectionBtn.addEventListener('click', scrollToPrevSection);
            if (floatingNextSectionBtn) floatingNextSectionBtn.addEventListener('click', scrollToNextSection);
            
            window.addEventListener('scroll', handleFloatingButtons);
            handleFloatingButtons();
        }

        function handleKeyboardNavigation(event) {
            const studyModal = document.getElementById('studyModal');
            const quizModal = document.getElementById('listenChooseModal');
            
            if (studyModal.style.display === 'block') {
                const nextBtn = document.getElementById('nextBtn');
                const backBtn = document.getElementById('backBtn');
                const speakBtn = document.getElementById('speakCurrentBtn');
                const translateBtn = document.getElementById('showTranslationBtn');

                if (event.key === 'ArrowRight' && nextBtn && !nextBtn.disabled) {
                    event.preventDefault();
                    nextWord();
                }
                if (event.key === 'ArrowLeft' && backBtn && !backBtn.disabled) {
                    event.preventDefault();
                    previousWord();
                }
                if (event.key === ' ' && speakBtn) {
                    event.preventDefault();
                    handleSpeakCurrent();
                }
                if ((event.key === 't' || event.key === 'T') && translateBtn && !translateBtn.disabled) {
                    event.preventDefault();
                    toggleTranslation();
                }
                if (event.key === 's' || event.key === 'S') {
                    event.preventDefault();
                    stopSpeech();
                }
                if (event.key === 'Escape') {
                    studyModal.style.display = 'none';
                    stopSpeech();
                }
            }

            if (quizModal.style.display === 'block') {
                const listenNextBtn = document.getElementById('listenNextBtn');
                const listenSpeaker = document.getElementById('listenSpeaker');
                const restartBtn = document.querySelector('.restart-quiz-btn');

                if (event.key === 'ArrowRight' && listenNextBtn && !listenNextBtn.disabled) {
                    event.preventDefault();
                    listenNextBtn.classList.add('key-pressed');
                    setTimeout(() => listenNextBtn.classList.remove('key-pressed'), 300);
                    nextQuizQuestion();
                }
                if (event.key === ' ' && listenSpeaker) {
                    event.preventDefault();
                    playQuizAudio();
                }
                if ((event.key === 't' || event.key === 'T') && restartBtn) {
                    event.preventDefault();
                    restartBtn.classList.add('key-pressed');
                    setTimeout(() => restartBtn.classList.remove('key-pressed'), 300);
                    restartQuiz();
                }
                if (!hasAnswered && event.key >= '1' && event.key <= '8') {
                    event.preventDefault();
                    const choiceButtons = document.querySelectorAll('.choice-btn');
                    const index = parseInt(event.key) - 1;
                    if (choiceButtons[index]) {
                        choiceButtons[index].click();
                    }
                }
                if (event.key === 'Escape') {
                    event.preventDefault();
                    closeQuizModal();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                initializeTTS(); 
                initializeEventListeners();
                
                setTimeout(async () => {
                    await displayVisitStats();
                }, 100);
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });

    </script>
    <div style="text-align: left; padding: 20px; background-color: #f0f8ff; border-top: 2px solid #3498db; margin-top: 30px; font-size: 20px; color: #2c3e50;">
        <div id="visitStatsContainer">„Ç¢„ÇØ„Çª„ÇπÁµ±Ë®à„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>
</body>
</html>
